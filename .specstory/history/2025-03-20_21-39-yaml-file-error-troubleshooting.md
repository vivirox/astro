<!-- Generated by SpecStory -->

# YAML File Error Troubleshooting (2025-03-20 17:39:00)

_**User**_



---

_**Assistant**_

I'll help resolve the errors in your `.trunk/trunk.yaml` file. Let me check the file contents first.

---



---

I can see the issue. Your `trunk.yaml` file contains `options` keys under the linter commands, which are causing validation errors. The current Trunk CLI version doesn't recognize this structure. Let me fix these issues.

---



---

_**User**_

now what

---

_**Assistant**_

I need to fix the errors in your `.trunk/trunk.yaml` file that are preventing the git commit from completing. Let me examine the full file and make the necessary corrections.

---

Read file: .trunk/trunk.yaml

---

Now I need to see the complete error message to understand which lines are causing issues:

---

<details>
            <summary>Grep search for "environment" • **23** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L10 | `environment TEXT NOT NULL CHECK (environment IN ('development', 'staging', 'production')),` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L26 | `CREATE INDEX deployments_environment_idx ON deployments (environment);` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L28 | `CREATE INDEX deployments_latest_idx ON deployments (environment, is_latest) WHERE is_latest = TRUE;` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L49 | `COMMENT ON COLUMN deployments.environment IS 'Deployment environment (development, staging, production)';` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L54 | `COMMENT ON COLUMN deployments.is_latest IS 'Flag indicating if this is the latest deployment for the environment';` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L62 | `environment,` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L80 | `-- Add sample data for development environment` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L83 | `IF current_setting('app.environment', TRUE) = 'development' THEN` |
| `file:///Users/vivi/astro/src/db/migrations/20250321_deployments.sql` | L84 | `INSERT INTO deployments (id, status, environment, version, commit_hash, deployed_at, is_latest, metadata)` |
| `file:///Users/vivi/astro/src/lib/supabase.ts` | L7 | `throw new Error("Missing Supabase environment variables");` |
| `file:///Users/vivi/astro/src/lib/db/supabase.ts` | L6 | `throw new Error("Missing Supabase environment variables");` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh.bak` | L57 | `echo -e "${BLUE}Verifying environment...${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh.bak` | L58 | `# Check for required environment variables` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh.bak` | L60 | `echo -e "${YELLOW}Warning: Supabase environment variables not found.${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh.bak` | L66 | `echo -e "${RED}Error: .env file not found and required environment variables are missing.${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh.bak` | L67 | `echo "Please set the following environment variables:"` |
| `file:///Users/vivi/astro/src/lib/ai/README.md` | L380 | `This library provides a comprehensive set of tools for working with AI services in a HIPAA-compliant environment.` |
| `file:///Users/vivi/astro/src/lib/db/ai/schema.ts` | L8 | `throw new Error("Missing Supabase environment variables");` |
| `file:///Users/vivi/astro/src/lib/ai/providers/README.md` | L25 | `4. Configure environment variables:` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L9 | `*   pnpm tsx src/scripts/record-deployment.ts --id=<deployment-id> --status=<status> [--environment=<env>]` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L14 | `*   --environment=<env>       Environment (staging, production)` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L30 | `environment: { type: "string", _default: "staging" },` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L87 | `// Try to get from environment variable (GitHub Actions)` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L115 | ``Recording deployment ${args.id} (${args.status}) for ${args.environment}...`,` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L124 | `environment: args.environment,` |
| `file:///Users/vivi/astro/src/scripts/record-deployment.ts` | L154 | `.eq("environment", args.environment)` |
| `file:///Users/vivi/astro/src/lib/supabase/client.ts` | L7 | `throw new Error("Missing Supabase environment variables");` |
| `file:///Users/vivi/astro/src/scripts/rollback.ts` | L30 | `environment: string;` |
| `file:///Users/vivi/astro/src/scripts/rollback.ts` | L56 | ``${index + 1}. ${deployment.version} (${date}) - ${deployment.environment}`,` |
| `file:///Users/vivi/astro/src/scripts/rollback.ts` | L173 | ``${deployment.version}-${deployment.environment}.sql.gz`,` |
| `file:///Users/vivi/astro/src/scripts/rollback.ts` | L267 | ``${deployment.version}-${deployment.environment}.env`,` |
| `file:///Users/vivi/astro/src/scripts/rollback.ts` | L398 | `text: `*Environment:* ${deployment.environment}\n*Rolled back to:* ${deployment.version}\n*Timestamp:* ${new Date().toISOString()}`,` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh` | L65 | `echo -e "${BLUE}Verifying environment...${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh` | L66 | `# Check for required environment variables` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh` | L68 | `echo -e "${YELLOW}Warning: Supabase environment variables not found.${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh` | L74 | `echo -e "${RED}Error: .env file not found and required environment variables are missing.${NC}"` |
| `file:///Users/vivi/astro/src/scripts/run-rollback.sh` | L75 | `echo "Please set the following environment variables:"` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L15 | `environment: string;` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L32 | `// 1. Check environment variables` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L33 | `console.log("\n[1/5] Checking environment variables...");` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L43 | `throw new Error(`Missing required environment variable: ${envVar}`);` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L46 | `console.log("✓ Environment variables verified");` |
| `file:///Users/vivi/astro/src/scripts/verify-deployment.ts` | L63 | `console.log(`  - Environment: ${healthData.environment}`);` |
| `file:///Users/vivi/astro/src/tests/performance.test.ts` | L58 | `environment: process.env.NODE_ENV || "development",` |
| `file:///Users/vivi/astro/src/docs/quickstart.mdx` | L41 | `### 3. Configure Environment Variables` |
| `file:///Users/vivi/astro/src/docs/quickstart.mdx` | L55 | `Configure the following environment variables:` |
| `file:///Users/vivi/astro/src/docs/quickstart.mdx` | L148 | `- Ensure proper environment variables` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L8 | `3. [Environments](#environments)` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L19 | `- **Environment Management**: Configuration for development, staging, and production` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L30 | `3. **Deploy**: Push the application to the target environment` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L36 | `## Environments` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L38 | `We maintain the following environments:` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L40 | `- **Development**: Local development environment for engineers` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L41 | `- **Staging**: Pre-production environment for testing and QA` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L42 | `- **Production**: Live environment for end users` |
| `file:///Users/vivi/astro/src/docs/deployment/README.mdx` | L44 | `Each environment has its own configuration, database, and security settings. For detailed information, see [Environments](./environments.mdx).` |
| `file:///Users/vivi/astro/src/docs/testing/best-practices.mdx` | L356 | `### 3. Test Environment` |
| `file:///Users/vivi/astro/src/docs/testing/best-practices.mdx` | L358 | `- Use a dedicated test environment` |
| `file:///Users/vivi/astro/src/docs/testing/best-practices.mdx` | L359 | `- Reset the environment between test runs` |
| `file:///Users/vivi/astro/src/docs/api/notification-service.md` | L445 | `1. **Environment Variables**: Store sensitive information like API keys and credentials in environment variables` |
| `file:///Users/vivi/astro/src/docs/api/plugins/security.md` | L6 | `### Sandbox Environment` |
| `file:///Users/vivi/astro/src/docs/api/plugins/security.md` | L152 | `Each plugin runs in its own isolated environment:` |
| `file:///Users/vivi/astro/src/docs/api/plugins/overview.md` | L15 | `- Secure sandbox environment for plugin execution` |
| `file:///Users/vivi/astro/src/docs/api/plugins/overview.md` | L35 | `### Sandbox Environment` |
| `file:///Users/vivi/astro/src/docs/api/plugins/lifecycle.md` | L24 | `- Create sandbox environment` |
| `file:///Users/vivi/astro/src/docs/api/plugins/lifecycle.md` | L49 | `1. **Environment Setup**` |
| `file:///Users/vivi/astro/src/docs/deployment/disaster-recovery.md` | L24 | `gh workflow run rollback.yml -f environment=production` |
| `file:///Users/vivi/astro/src/docs/deployment/disaster-recovery.md` | L65 | `- Verify environment variables are correctly set` |
| `file:///Users/vivi/astro/src/docs/deployment/disaster-recovery.md` | L92 | `# Set environment variables` |
| `file:///Users/vivi/astro/src/docs/deployment/disaster-recovery.md` | L138 | `4. Select environment (production or staging)` |
| `file:///Users/vivi/astro/src/docs/deployment/disaster-recovery.md` | L251 | `2. Simulate failures in controlled environments` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L6 | `⟪ 101 characters skipped ⟫It is configured to deploy to different environments depending on the trigger:` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L9 | `- **Workflow dispatch with environment selection**: Manual deployment to staging or production` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L16 | `2. **Deploy**: Pushes the application to the target environment` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L61 | `6. Deploys the application to the target environment` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L70 | `environment:` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L71 | `name: ${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L92 | `- name: Deploy to ${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L100 | `pnpm deploy:${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L124 | `ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L126 | `curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"✅ Successfully deployed to $ENVIRONMENT with ID $DEPLOYMENT_ID\"}" $SLACK_WEBHOOK` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L145 | `environment:` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L146 | `name: ${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L163 | `ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}` |
| `file:///Users/vivi/astro/src/docs/deployment/ci-cd.mdx` | L166 | `pnpm tsx src/scripts/rollback.ts --notify=true --environment=$ENVIRONMENT` |
| `file:///Users/vivi/astro/.gitignore` | L15 | `# environment variables` |

</details>

---

Let me search for the specific error lines in the file. Based on the error message, there are issues with the 'environment' key in the trunk.yaml file:

---

<details>
            <summary>Grep search for ""environment" is not a recognized key" • **0** files</summary>
        
No results found
</details>

---

Let me check if there might be other versions of this file:

---

<details>
            <summary>Searched codebase "trunk.yaml" • **3** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Let's check the neon-chatbot version of the trunk.yaml file to see if it might have the problematic 'environment' key:

---

Read file: /Users/vivi/astro/neon-chatbot/.trunk/trunk.yaml

---

Let me list all files in the main .trunk directory to better understand what we're working with:

---

<details>
            <summary>Listed directory .trunk • **10** results</summary>
        
| Name |
|-------|
| 📁 `tools` |
| 📁 `logs` |
| 📁 `notifications` |
| 📄 `trunk.yaml` |
| 📄 `.gitignore` |
| 📁 `configs` |
| 📁 `out` |
| 📄 `config.yml` |
| 📁 `actions` |
| 📁 `plugins` |

</details>

---

Let me check if there's a newer version or cached version of the trunk.yaml file that might have the 'environment' key:

---

<details>
            <summary>Listed directory .trunk/out • **100** results</summary>
        
| Name |
|-------|
| 📄 `RU2N4.yaml` |
| 📄 `MF59D.yaml` |
| 📄 `W3P3M.yaml` |
| 📄 `AD6YY.yaml` |
| 📄 `NPRBK.yaml` |
| 📄 `XAX9N.yaml` |
| 📄 `CDQYF.yaml` |
| 📄 `U5H0Z.yaml` |
| 📄 `BC8EP.yaml` |
| 📄 `6QAMH.yaml` |
| 📄 `DF5SR.yaml` |
| 📄 `ER93R.yaml` |
| 📄 `KULM0.yaml` |
| 📄 `2BA2D.yaml` |
| 📄 `YMLZT.yaml` |
| 📄 `V0ZB9.yaml` |
| 📄 `10N15.yaml` |
| 📄 `JT42Y.yaml` |
| 📄 `KME47.yaml` |
| 📄 `SUHX1.yaml` |
| 📄 `340MB.yaml` |
| 📄 `00W2X.yaml` |
| 📄 `WZB3Z.yaml` |
| 📄 `T2VH7.yaml` |
| 📄 `752NT.yaml` |
| 📄 `PWDHY.yaml` |
| 📄 `7H2FZ.yaml` |
| 📄 `XSSPX.yaml` |
| 📄 `5USFP.yaml` |
| 📄 `Z1PU9.yaml` |
| 📄 `K3QU6.yaml` |
| 📄 `5PPQK.yaml` |
| 📄 `GP0V0.yaml` |
| 📄 `78NNJ.yaml` |
| 📄 `BC2DK.yaml` |
| 📄 `0QBVZ.yaml` |
| 📄 `321C3.yaml` |
| 📄 `CT55K.yaml` |
| 📄 `13SGJ.yaml` |
| 📄 `BNN8E.yaml` |
| 📄 `6GMK3.yaml` |
| 📄 `RHYKH.yaml` |
| 📄 `42E8K.yaml` |
| 📄 `8FKJV.yaml` |
| 📄 `X7CEE.yaml` |
| 📄 `7PY1W.yaml` |
| 📄 `0VWA3.yaml` |
| 📄 `18QAX.yaml` |
| 📄 `3HJL8.yaml` |
| 📄 `F2ASG.yaml` |
| 📄 `EQRHC.yaml` |
| 📄 `VKKHG.yaml` |
| 📄 `1JF0T.yaml` |
| 📄 `PPU2C.yaml` |
| 📄 `RRP0G.yaml` |
| 📄 `GYGUR.yaml` |
| 📄 `06VKK.yaml` |
| 📄 `51UV1.yaml` |
| 📄 `KH6EZ.yaml` |
| 📄 `MD42J.yaml` |
| 📄 `WWTP8.yaml` |
| 📄 `QNN77.yaml` |
| 📄 `B2PDE.yaml` |
| 📄 `TPBXV.yaml` |
| 📄 `XGXV8.yaml` |
| 📄 `16LTE.yaml` |
| 📄 `B87FH.yaml` |
| 📄 `D6LVH.yaml` |
| 📄 `9C4BV.yaml` |
| 📄 `WQDCD.yaml` |
| 📄 `U3N3C.yaml` |
| 📄 `1USGZ.yaml` |
| 📄 `48W3B.yaml` |
| 📄 `PWNQP.yaml` |
| 📄 `LRADY.yaml` |
| 📄 `X2VAV.yaml` |
| 📄 `MQZP7.yaml` |
| 📄 `DJ0W6.yaml` |
| 📄 `C8TB7.yaml` |
| 📄 `W9U1F.yaml` |
| 📄 `NMR40.yaml` |
| 📄 `R8LND.yaml` |
| 📄 `0ZQ32.yaml` |
| 📄 `4U58A.yaml` |
| 📄 `E1A18.yaml` |
| 📄 `Z4DX5.yaml` |
| 📄 `JLLHU.yaml` |
| 📄 `XAFYN.yaml` |
| 📄 `NKGCJ.yaml` |
| 📄 `LRVKX.yaml` |
| 📄 `G7CPW.yaml` |
| 📄 `3W4M0.yaml` |
| 📄 `TRQ4D.yaml` |
| 📄 `260WU.yaml` |
| 📄 `H329D.yaml` |
| 📄 `XYDBQ.yaml` |
| 📄 `7V8K5.yaml` |
| 📄 `W0X74.yaml` |
| 📄 `AJ5V8.yaml` |
| 📄 `UR7LW.yaml` |

</details>

---

Let's look at one of the latest generated files to see if it has the environment key:

---

Read file: .trunk/out/RU2N4.yaml

---

Let me check for any environment-related lines in the git head using grep:

---

```bash
cd ~/astro && git diff --cached .trunk/trunk.yaml | cat
```

```
└─$ cd ~/astro && git diff --cached .trunk/trunk.yaml | cat
(base) ┌───(vivi@macattack)-[~/astro][main*] 
└─$
```

---

Let me examine the actual error message you received more closely:

---

<details>
            <summary>Grep search for "✖ Errors occurred while parsing" • **0** files</summary>
        
No results found
</details>

---

Let me try a different approach to see if there's any linting or validation running that's causing the error:

---

```bash
cd ~/astro && trunk check --verbose | cat
```

```
  AUTOFIXES  

fix-eslint.sh:81:12
 81:12  low  Prefer putting braces around variable references even when not strictly required.  shellcheck/S
C2250

  79 | 
  80 | eval_files_CMD_RESULT=$(bash /tmp/find_eval_cmd.sh)
  81 | eval_files=$eval_files_CMD_RESULT
     | eval_files=${eval_files_CMD_RESULT}
  82 | # shellcheck disable=SC2034
  83 | 

→ Apply autofix (Y/n/all/none): all
  Autofix applied.

src/scripts/run-rollback.sh
 1:1  high  Incorrect formatting  

  45 | # Check if pnpm is installed
  46 | if ! command -v pnpm &>/dev/null; then
  47 | # shellcheck disable=SC2034
     |  # shellcheck disable=SC2034
  48 |  echo -e "${RED}Error: pnpm is not installed${NC}"
  49 | # shellcheck disable=SC2034
     |  # shellcheck disable=SC2034
  50 |  echo "Please install pnpm: npm install -g pnpm"
  51 |  exit 1

  Formatting applied.

src/lib/access-control.ts
 1:1  high  Incorrect formatting  

  83 |  * Check if a role has a specific permission
  84 |  */
  85 | export function roleHasPermission(_role: Role, _permission: Permission): boolean {
     | export function roleHasPermission(
     |   _role: Role,
     |   _permission: Permission,
     | ): boolean {
  86 |   return ROLE_PERMISSIONS[role]?.includes(permission) || false;
  87 | }

  Formatting applied.

src/lib/ai/performance.ts
 1:1  high  Incorrect formatting  

  212 |    * Collects and processes performance metrics
  213 |    */
  214 |   const _collectMetrics = async (_metrics: PerformanceMetrics): Promise<void> => {
      |   const _collectMetrics = async (
      |     _metrics: PerformanceMetrics,
      |   ): Promise<void> => {
  215 |     // Log to console if enabled
  216 |     if (options.logToConsole) {

  Formatting applied.

src/lib/ai/services/crisis-detection.ts
 1:1  high  Incorrect formatting  

  66 |     },
  67 |   ): Promise<CrisisDetectionResult> {
  68 |     const _sensitivityLevel = options?.sensitivityLevel || this.sensitivityLevel;
     |     const _sensitivityLevel =
     |       options?.sensitivityLevel || this.sensitivityLevel;
  69 |     let prompt = options?.customPrompt || this.defaultPrompt;
  70 | 

  Formatting applied.

src/lib/ai/services/response-generation.ts
 1:1  high  Incorrect formatting  

  298 |       // Handle non-streaming response
  299 |       const _nonStreamingResponse = response as AICompletionResponse;
  300 |       const _content = nonStreamingResponse.choices?.[0]?.message?.content ?? "";
      |       const _content =
      |         nonStreamingResponse.choices?.[0]?.message?.content ?? "";
  301 |       if (content) {
  302 |         fullResponse = content;

  Formatting applied.

src/lib/auth/middleware.ts
 1:1  high  Incorrect formatting  

   6 |  * Middleware to verify ZK proof for session
   7 |  */
   8 | export const _verifyZKProof = async (_request: Request, _context: AuthContext) => {
     | export const _verifyZKProof = async (
     |   _request: Request,
     |   _context: AuthContext,
     | ) => {
   9 |   try {
  10 |     // Get the session from the contex

  66 |  * Middleware to verify admin access
  67 |  */
  68 | export const _verifyAdmin = async (_request: Request, _context: AuthContext) => {
     | export const _verifyAdmin = async (
     |   _request: Request,
     |   _context: AuthContext,
     | ) => {
  69 |   try {
  70 |     // Get the session from the contex

  Formatting applied.

src/lib/auth/zkAuth.ts
 1:1  high  Incorrect formatting  

  189 |     try {
  190 |       // Generate a range proof
  191 |       const _proof = await zkSystem.generateRangeProof(attempts, 0, maxAttempts);
      |       const _proof = await zkSystem.generateRangeProof(
      |         attempts,
      |         0,
      |         maxAttempts,
      |       );
  192 | 
  193 |       // Log the range proof generation

  Formatting applied.

src/lib/auth.ts
 1:1  high  Incorrect formatting  

  60 |  * Check if the user is authenticated
  61 |  */
  62 | export async function isAuthenticated(_cookies: AstroCookies): Promise<boolean> {
     | export async function isAuthenticated(
     |   _cookies: AstroCookies,
     | ): Promise<boolean> {
  63 |   const _user = await getCurrentUser(cookies);
  64 |   return !!user;

  Formatting applied.

src/lib/middleware/logging.ts
 1:1  high  Incorrect formatting  

    8 |  * Adds request ID tracking and structured logging for all requests
    9 |  */
   10 | export const _loggingMiddleware = defineMiddleware(async ({ request }, next) => {
   11 |   // Generate or get request ID
   12 |   const _requestId = request.headers.get("x-request-id") || uuidv4();
      | export const _loggingMiddleware = defineMiddleware(
      |   async ({ request }, next) => {
      |     // Generate or get request ID
      |     const _requestId = request.headers.get("x-request-id") || uuidv4();
   13 | 
   14 |   // Create a logger for this reques
   15 |   const _logger = getLogger(requestId);
      |     // Create a logger for this reques
      |     const _logger = getLogger(requestId);
   16 | 
   17 |   // Basic request information
   18 |   const _method = request.method;
   19 |   const _url = new URL(request.url);
   20 |   const _path = url.pathname;
   21 |   const _userAgent = request.headers.get("user-agent") || "unknown";
   22 |   const _referer = request.headers.get("referer") || "direct";
   23 |   const ip =
   24 |     request.headers.get("x-forwarded-for") ||
   25 |     request.headers.get("cf-connecting-ip") ||
   26 |     "unknown";
      |     // Basic request information
      |     const _method = request.method;
      |     const _url = new URL(request.url);
      |     const _path = url.pathname;
      |     const _userAgent = request.headers.get("user-agent") || "unknown";
      |     const _referer = request.headers.get("referer") || "direct";
      |     const ip =
      |       request.headers.get("x-forwarded-for") ||
      |       request.headers.get("cf-connecting-ip") ||
      |       "unknown";
   27 | 
   28 |   // Try to get user from session
   29 |   let userId = "anonymous";
   30 |   try {
   31 |     const _session = await getSession(request);
   32 |     if (session?.user?.id) {
   33 |       userId = session.user.id;
   34 |       logger.setContext("userId", userId);
   35 |       logger.setContext("userRole", session.user.role || "user");
      |     // Try to get user from session
      |     let userId = "anonymous";
      |     try {
      |       const _session = await getSession(request);
      |       if (session?.user?.id) {
      |         userId = session.user.id;
      | ...120 additional lines hidden...

  Formatting applied.

src/lib/zk/index.ts
 1:1  high  Incorrect formatting  

  52 |   generateProof: (_data: any) => Promise<ProofData>;
  53 |   verifyProof: (_proofData: ProofData) => Promise<VerificationResult>;
  54 |   encryptAndProve: (_data: any, _context: string) => Promise<EncryptedProofData>;
     |   encryptAndProve: (
     |     _data: any,
     |     _context: string,
     |   ) => Promise<EncryptedProofData>;
  55 |   generateRangeProof: (
  56 |     value: number,

  Formatting applied.

src/pages/api/ai/intervention-analysis.ts
 1:1  high  Incorrect formatting  

  215 |       const _conversationMessages = Array.isArray(conversation)
  216 |         ? conversation
  217 |         : ([{ role: "user", _content: conversation, _name: "" }] as AIMessage[]);
      |         : ([
      |             { role: "user", _content: conversation, _name: "" },
      |           ] as AIMessage[]);
  218 | 
  219 |       result = await interventionService.analyzeIntervention(

  Formatting applied.

src/pages/api/ai/response.ts
 1:1  high  Incorrect formatting  

  89 |         throw new Error("Streaming not supported yet");
  90 |       },
  91 |       getModelInfo: (_model: string) => ({ id: model, _capabilities: ["chat"] }),
     |       getModelInfo: (_model: string) => ({
     |         id: model,
     |         _capabilities: ["chat"],
     |       }),
  92 |       createChatCompletionWithTracking: async (
  93 |         messages: any[],

  Formatting applied.

src/pages/api/ai/sentiment.ts
 1:1  high  Incorrect formatting  

  43 | 
  44 | // Helper function to get session
  45 | async function getSessionHelper(_request: Request): Promise<SessionData | null> {
     | async function getSessionHelper(
     |   _request: Request,
     | ): Promise<SessionData | null> {
  46 |   // Dynamically import the session module
  47 |   const _sessionModule = await import("../../../lib/auth/session.js");

  Formatting applied.

src/pages/api/auth/login.ts
 1:1  high  Incorrect formatting  

  16 | 
  17 |     // Authenticate user (replace with your actual auth logic)
  18 |     const user: User = { id: "user-" + crypto.randomUUID(), _email: body.email };
     |     const user: User = {
     |       id: "user-" + crypto.randomUUID(),
     |       _email: body.email,
     |     };
  19 | 
  20 |     // Create session data

  Formatting applied.

src/pages/api/chat/send.ts
 1:1  high  Incorrect formatting  

  43 |     // Verify the sender is authorized (for AI messages or restricted conversations)
  44 |     if (body.requireSenderVerification) {
  45 |       const _authorizedSenders = await getAuthorizedSenders(body.conversationId);
     |       const _authorizedSenders = await getAuthorizedSenders(
     |         body.conversationId,
     |       );
  46 |       await zkChat.verifyAuthorizedSender(body.userId, authorizedSenders);
  47 |     }

  70 | 
  71 | // Helper function to get authorized senders for a conversation
  72 | async function getAuthorizedSenders(_conversationId: string): Promise<string[]> {
     | async function getAuthorizedSenders(
     |   _conversationId: string,
     | ): Promise<string[]> {
  73 |   // In a real implementation, this would fetch the authorized senders from the database
  74 |   // For now, return a mock lis

  Formatting applied.

src/scripts/record-deployment.ts
 1:1  high  Incorrect formatting  

  74 |   try {
  75 |     const _packageJsonPath = path.join(process.cwd(), "package.json");
  76 |     const _packageJson = JSON.parse(await fs.readFile(packageJsonPath, "utf-8"));
     |     const _packageJson = JSON.parse(
     |       await fs.readFile(packageJsonPath, "utf-8"),
     |     );
  77 |     return packageJson.version || "unknown";
  78 |   } catch (error) {

  Formatting applied.

src/scripts/security-tests.ts
 1:1  high  Incorrect formatting  

  230 |   // 1. API Endpoint Security Tests
  231 |   const _startTime = Date.now();
  232 |   const _endpointResults = await runTest("API Endpoint Security Tests", "pnpm", [
  233 |     "test:security:endpoint",
  234 |   ]);
      |   const _endpointResults = await runTest(
      |     "API Endpoint Security Tests",
      |     "pnpm",
      |     ["test:security:endpoint"],
      |   );
  235 |   results.push({
  236 |     name: "API Endpoint Security",

  Formatting applied.

src/tests/browser-compatibility.test.ts
 1:1  high  Incorrect formatting  

  436 |     // Check for contrast issues (basic check)
  437 | 
  438 |     const _walk = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
      |     const _walk = document.createTreeWalker(
      |       document.body,
      |       NodeFilter.SHOW_TEXT,
      |     );
  439 |     let node;
  440 |     while ((node = walk.nextNode())) {

  Formatting applied.

src/tests/crypto.test.ts
 1:1  high  Incorrect formatting  

  108 |     // Mock the expiration date to be in the pas
  109 |     const _originalDate = Date.now;
  110 |     const _mockDate = vi.fn(() => metadata.createdAt + 91 * 24 * 60 * 60 * 1000); // 91 days later
      |     const _mockDate = vi.fn(
      |       () => metadata.createdAt + 91 * 24 * 60 * 60 * 1000,
      |     ); // 91 days later
  111 |     global.Date.now = mockDate;
  112 | 

  Formatting applied.

Re-checking autofixed files...


  ISSUES  

.github/workflows/deploy-production.yml:121:121
 121:121  medium  line too long (121 > 120 characters)  yamllint/line-length

.github/workflows/deploy.yml:113:121
 113:121  medium  line too long (137 > 120 characters)  yamllint/line-length
 127:121  medium  line too long (250 > 120 characters)  yamllint/line-length
 169:121  medium  line too long (175 > 120 characters)  yamllint/line-length

README.md:189:0
 189:0  low  Line length  markdownlint/MD013
 201:0  low  Line length  markdownlint/MD013

src/docs/deployment/README.mdx:3:0
  3:0  low  Line length  markdownlint/MD013
 27:0  low  Line length  markdownlint/MD013
 49:0  low  Line length  markdownlint/MD013
 55:0  low  Line length  markdownlint/MD013
 61:0  low  Line length  markdownlint/MD013

src/docs/deployment/ci-cd.mdx:7:0
 7:0  low  Line length  markdownlint/MD013

src/docs/deployment/rollback.mdx:3:0
 3:0  low  Line length  markdownlint/MD013

src/docs/deployment/verification.mdx:3:0
   3:0  low  Line length  markdownlint/MD013
   7:0  low  Line length  markdownlint/MD013
  11:0  low  Line length  markdownlint/MD013
  88:0  low  Line length  markdownlint/MD013
  92:0  low  Line length  markdownlint/MD013
 145:0  low  Line length  markdownlint/MD013

  NOTICES  

 The following files that affect markdownlint's execution are git-ignored: .trunk/configs/.markdownlint.yaml
. This may
 cause discrepancies in local and remote execution.


 The following files that affect shellcheck's execution are git-ignored: .trunk/configs/.shellcheckrc. This 
may cause
 discrepancies in local and remote execution.


 The following files that affect yamllint's execution are git-ignored: .trunk/configs/.yamllint.yaml. This m
ay cause
 discrepancies in local and remote execution.



  ACTIONS  

fix-eslint.sh
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 shellcheck      .trunk/out/YRV7F.yaml  lint  
 shfmt           .trunk/out/LAYPM.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/lib/access-control.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/ai/performance.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/ai/services/crisis-detection.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/ai/services/response-generation.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/auth/middleware.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/auth/zkAuth.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/auth.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/lib/middleware/logging.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 prettier        .trunk/out/ETP0M.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/lib/zk/index.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/pages/api/ai/intervention-analysis.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/pages/api/ai/response.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/pages/api/ai/sentiment.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/pages/api/auth/login.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/pages/api/chat/send.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

src/scripts/record-deployment.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 prettier        .trunk/out/ETP0M.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/scripts/run-rollback.sh
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 shellcheck      .trunk/out/7U2BA.yaml  lint  
 shfmt           .trunk/out/LAYPM.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/scripts/security-tests.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 prettier        .trunk/out/ETP0M.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/tests/browser-compatibility.test.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint  
 prettier        .trunk/out/ETP0M.yaml  format
 trufflehog      .trunk/out/70XJ5.yaml  lint  

src/tests/crypto.test.ts
 git-diff-check  .trunk/out/TFY7F.yaml  lint           
 git-diff-check  .trunk/out/3LQ93.yaml  lint [upstream]
 prettier        .trunk/out/ETP0M.yaml  format         
 trufflehog      .trunk/out/70XJ5.yaml  lint           
 trufflehog      [cached]               lint [upstream]

Checked 327 modified files
716 existing issues (use --show-existing to see them)
✖ 19 new lint issues

```

---

Now I'll check for any other trunk.yaml files that might be in the repository:

---

```bash
find ~/astro -name "trunk.yaml" | cat
```

```
└─$ find ~/astro -name "trunk.yaml" | cat
/Users/vivi/astro/.trunk/trunk.yaml
/Users/vivi/astro/neon-chatbot/.trunk/trunk.yaml
(base) ┌───(vivi@macattack)-[~/astro][main*] 
└─$
```

---

The problem appears to be related to the git commit failing due to Trunk validation errors. The error mentions "environment" is not a recognized key in the trunk.yaml file, but I don't see this key in the current file. 

Since the error specifically mentions lines 31, 39, 47, and 54, but our current file only has 39 lines total, there must be another version of the file that git is trying to commit or there's a mismatch between what's in the repo and what's on disk.

Let's check the git status to see what files are staged for commit:

---

```bash
cd ~/astro && git status
```

```
On branch main
Your branch is up to date with 'origin/main'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        deleted:    .cursor/rules/next-seo.mdc
        deleted:    .cursor/rules/next-supa.mdc
        deleted:    .cursor/rules/react.mdc
        deleted:    .cursor/rules/supabase-seo.mdc
        deleted:    .cursor/rules/tailwind-vite.mdc
        deleted:    .cursor/rules/vercel-ai.mdc
        modified:   .cursorrules
        modified:   .env.example
        modified:   .github/workflows/backup.yml
        modified:   .github/workflows/deploy-production.yml
        modified:   .github/workflows/deploy-staging.yml
        new file:   .github/workflows/deploy.yml
        modified:   .github/workflows/monitoring.yml
        modified:   .github/workflows/rollback.yml
        modified:   .gitignore
        new file:   .gitmodules
        new file:   .markdownlintignore
        modified:   README.md
        modified:   commit-message.txt
        new file:   error-summary-fixed.mdx
        new file:   error-summary.mdx
        new file:   fix-eslint.sh
        new file:   fix_dates.sh
        new file:   fix_frontmatter.sh
        new file:   fix_mdx_quotes.sh
        new file:   fix_shell_scripts.sh
        new file:   neon-chatbot
        modified:   package.json
        modified:   pnpm-lock.yaml
        new file:   public/android-chrome-192x192.png
        new file:   public/android-chrome-512x512.png
        new file:   public/apple-touch-icon.png
        new file:   public/favicon-16x16.png
        new file:   public/favicon-32x32.png
        new file:   public/favicon.ico
        new file:   repomix-output.xml
        modified:   security-updates-summary.md
        modified:   src/components/AIChat.tsx
        modified:   src/components/accessibility/ContrastChecker.tsx
        new file:   src/components/admin/PerformanceDashboard.astro
        modified:   src/components/admin/ZKSystemDashboard.tsx
        modified:   src/components/ai/AccessibleLoadingIndicator.tsx
        modified:   src/components/ai/PerformanceDashboard.tsx
        modified:   src/components/ai/chat/ChatContainer.tsx
        modified:   src/components/ai/chat/ChatInput.tsx
        modified:   src/components/ai/chat/ChatMessage.tsx
        modified:   src/components/ai/chat/index.ts
        modified:   src/components/ai/chat/useChatCompletion.ts
        modified:   src/components/ai/chat/useCrisisDetection.ts
        modified:   src/components/ai/chat/useResponseGeneration.ts
        modified:   src/components/ai/chat/useSentimentAnalysis.ts
        modified:   src/components/ai/index.ts
        modified:   src/components/auth/ZKAuthStatus.tsx
        new file:   src/components/blog/ArticleCard.astro
        modified:   src/components/blog/ArticleHeader.astro
        new file:   src/components/blog/AuthorBio.astro
        new file:   src/components/blog/Divider.astro
        new file:   src/components/blog/SeriesNavigation.astro
        new file:   src/components/blog/SocialShare.astro
        new file:   src/components/blog/Subscribe.astro
        modified:   src/components/blog/TableOfContents.astro
        modified:   src/components/chat/ChatMessage.tsx
        modified:   src/components/chat/ZKChatStatus.tsx
        modified:   src/components/demo/ChatDemo.tsx
        new file:   src/components/demo/index.ts
        new file:   src/components/layout/Layout.tsx
        new file:   src/components/layout/index.ts
        modified:   src/components/security/SecurityDashboard.tsx
        modified:   src/components/testing/BrowserCompatibilityTester.tsx
        modified:   src/components/ui/AccessibilityAnnouncer.tsx
        modified:   src/components/ui/Button.astro
        modified:   src/components/ui/Footer.astro
        modified:   src/components/ui/Navigation.astro
        modified:   src/components/ui/ThemeToggle.astro
        modified:   src/components/widgets/SpinningGlobe.astro
        modified:   src/config.ts
        modified:   src/content/blog/healing-series/codependency-and-trauma.mdx
        modified:   src/content/blog/healing-series/dance-of-wounded-souls.mdx
        modified:   src/content/blog/healing-series/emotional-unavailability.mdx
        modified:   src/content/blog/healing-series/index.mdx
        modified:   src/content/blog/index.mdx
        modified:   src/content/blog/mental/I-CPTSD/A-Understanding/CPTSD-Manifestions.mdx
        modified:   src/content/blog/mental/I-CPTSD/A-Understanding/CPTSD-vs-PTSD.mdx
        modified:   src/content/blog/mental/I-CPTSD/A-Understanding/Causes-and-Factors.mdx
        modified:   src/content/blog/mental/I-CPTSD/B-CopingStrategies/Emotional-Balance.mdx
        modified:   src/content/blog/mental/I-CPTSD/B-CopingStrategies/Finding-Calm.mdx
        modified:   src/content/blog/mental/I-CPTSD/B-CopingStrategies/Finding-Peace.mdx
        modified:   src/content/blog/mental/I-CPTSD/C-TreatmentOptions/Alternative-Options.mdx
        modified:   src/content/blog/mental/I-CPTSD/C-TreatmentOptions/Medication-Approach.mdx
        modified:   src/content/blog/mental/I-CPTSD/C-TreatmentOptions/Therapy-Approaches.mdx
        modified:   src/content/blog/mental/I-CPTSD/overview.mdx
        modified:   src/content/blog/mental/I-CPTSD/resources.mdx
        modified:   src/content/blog/mental/I-CPTSD/symptoms.mdx
        modified:   src/content/blog/mental/I-CPTSD/treatment.mdx
        modified:   src/content/blog/mental/II-Addiction/A-Understanding/Addiction-Cycle.mdx
        modified:   src/content/blog/mental/II-Addiction/A-Understanding/Co-Occuring-Disorders.mdx
        modified:   src/content/blog/mental/II-Addiction/A-Understanding/Definition-of-Addiction.mdx
        modified:   src/content/blog/mental/II-Addiction/B-RecoveryStrategies/12-Steps.mdx
        modified:   src/content/blog/mental/II-Addiction/B-RecoveryStrategies/Relapse-Prevention.mdx
        modified:   src/content/blog/mental/II-Addiction/B-RecoveryStrategies/Support-Network.mdx
        modified:   src/content/blog/mental/II-Addiction/C-TreatmentApproaches/CBT.mdx
        modified:   src/content/blog/mental/II-Addiction/C-TreatmentApproaches/Detox.mdx
        modified:   src/content/blog/mental/II-Addiction/C-TreatmentApproaches/MAT.mdx
        modified:   src/content/blog/mental/II-Addiction/assessment.mdx
        modified:   src/content/blog/mental/II-Addiction/intervention.mdx
        modified:   src/content/blog/mental/II-Addiction/overview.mdx
        modified:   src/content/blog/mental/II-Addiction/recovery.mdx
        modified:   src/content/blog/mental/III-Intersection/A-Understanding/Affects-of-CPTSD.mdx
        modified:   src/content/blog/mental/III-Intersection/A-Understanding/Leading-Cause.mdx
        modified:   src/content/blog/mental/III-Intersection/B-IntegratedTreatment/DDP.mdx
        modified:   src/content/blog/mental/III-Intersection/B-IntegratedTreatment/TI-Treatment.mdx
        modified:   src/content/blog/mental/III-Intersection/case-studies.mdx
        modified:   src/content/blog/mental/III-Intersection/comorbidity.mdx
        modified:   src/content/blog/mental/III-Intersection/integrated-treatment.mdx
        modified:   src/content/blog/mental/III-Intersection/overview.mdx
        modified:   src/content/blog/mental/IV-Management/A-DailyPractices/Healthy-Routines.mdx
        modified:   src/content/blog/mental/IV-Management/A-DailyPractices/Sleep-Hygeine.mdx
        modified:   src/content/blog/mental/IV-Management/A-DailyPractices/Stress-Management.mdx
        modified:   src/content/blog/mental/IV-Management/B-BuildingResilience/Healthy-Coping.mdx
        modified:   src/content/blog/mental/IV-Management/B-BuildingResilience/Self-Compassion.mdx
        modified:   src/content/blog/mental/IV-Management/B-BuildingResilience/Setting-Boundaries.mdx
        modified:   src/content/blog/mental/IV-Management/crisis-planning.mdx
        modified:   src/content/blog/mental/IV-Management/overview.mdx
        modified:   src/content/blog/mental/IV-Management/strategies.mdx
        modified:   src/content/blog/mental/IV-Management/support-systems.mdx
        modified:   src/content/blog/mental/V-Resources/A-ProfessionalHelp/Addiction-Specialists.mdx
        modified:   src/content/blog/mental/V-Resources/A-ProfessionalHelp/Trauma-Informed.mdx
        modified:   src/content/blog/mental/V-Resources/B-SupportGroups/Addiction-Support.mdx
        modified:   src/content/blog/mental/V-Resources/B-SupportGroups/CPTSD-Support.mdx
        modified:   src/content/blog/mental/V-Resources/C-EductationalMaterial/Books.mdx
        modified:   src/content/blog/mental/V-Resources/C-EductationalMaterial/Online Courses.mdx
        modified:   src/content/blog/mental/V-Resources/C-EductationalMaterial/Podcasts.mdx
        modified:   src/content/blog/mental/V-Resources/literature.mdx
        modified:   src/content/blog/mental/V-Resources/overview.mdx
        modified:   src/content/blog/mental/V-Resources/support-groups.mdx
        modified:   src/content/blog/mental/V-Resources/therapy-options.mdx
        modified:   src/content/blog/mental/XYZbundle/Scapegoat-Summary.mdx
        modified:   src/content/blog/mental/XYZbundle/family-resources.mdx
        modified:   src/content/blog/mental/XYZbundle/patient-resources.mdx
        modified:   src/content/blog/mental/XYZbundle/therapist-resources.mdx
        modified:   src/content/blog/mental/index.mdx
        modified:   src/content/blog/planning/article-template.mdx
        modified:   src/content/blog/planning/content-calendar.mdx
        modified:   src/content/blog/planning/series-outline.mdx
        modified:   src/content/blog/trauma-body-series/index.mdx
        modified:   src/content/blog/trauma-body-series/physical-impact.mdx
        modified:   src/content/blog/trauma-series/dark-side-of-love.mdx
        modified:   src/content/blog/trauma-series/healing-inner-child.mdx
        modified:   src/content/blog/trauma-series/heart-of-codependency.mdx
        modified:   src/content/blog/trauma-series/index.mdx
        modified:   src/content/blog/trauma-series/inner-critic.mdx
        modified:   src/content/blog/trauma-series/scapegoat-dynamics.mdx
        modified:   src/content/blog/trauma-series/trauma-bonds.mdx
        modified:   src/content/blog/trauma-series/understanding-narcissism.mdx
        modified:   src/content/config.ts
        new file:   src/db/migrations/20250321_deployments.sql
        modified:   src/docs/api/notification-service.md
        modified:   src/docs/api/overview.mdx
        modified:   src/docs/blog/healing-series/dance-of-wounded-souls.mdx
        modified:   src/docs/core/authentication.mdx
        new file:   src/docs/deployment/README.mdx
        new file:   src/docs/deployment/ci-cd.mdx
        modified:   src/docs/deployment/disaster-recovery.md
        new file:   src/docs/deployment/rollback.mdx
        new file:   src/docs/deployment/verification.mdx
        modified:   src/docs/devops.md
        modified:   src/docs/guides/ai-deployment.mdx
        modified:   src/docs/guides/getting-started.mdx
        modified:   src/docs/guides/security.md
        modified:   src/docs/guides/troubleshooting.md
        modified:   src/docs/migration/unified-plan.mdx
        modified:   src/docs/security/authentication.mdx
        modified:   src/docs/security/compliance.mdx
        modified:   src/docs/security/encryption.mdx
        modified:   src/docs/security/overview.mdx
        modified:   src/docs/testing/browser-compatibility-testing.md
        modified:   src/env.d.ts
        modified:   src/layouts/AdminLayout.astro
        modified:   src/layouts/AuthLayout.astro
        modified:   src/layouts/BaseLayout.astro
        modified:   src/layouts/BlogPostLayout.astro
        modified:   src/layouts/ChatLayout.astro
        modified:   src/layouts/StandardLayout.astro
        modified:   src/lib/access-control.ts
        modified:   src/lib/ai/__tests__/performance-optimizations.test.ts
        modified:   src/lib/ai/analytics.ts
        modified:   src/lib/ai/error-handling.ts
        modified:   src/lib/ai/factory.ts
        modified:   src/lib/ai/index.ts
        modified:   src/lib/ai/models/ai-types.ts
        modified:   src/lib/ai/models/registry.ts
        modified:   src/lib/ai/models/types.ts
        modified:   src/lib/ai/performance-optimizations.ts
        modified:   src/lib/ai/performance-tracker.ts
        modified:   src/lib/ai/performance.ts
        deleted:    src/lib/ai/providers/modal.ts
        modified:   src/lib/ai/providers/together.ts
        modified:   src/lib/ai/services/ai-service.ts
        modified:   src/lib/ai/services/cache-service.ts
        modified:   src/lib/ai/services/connection-pool.ts
        modified:   src/lib/ai/services/crisis-detection.ts
        modified:   src/lib/ai/services/fallback-service.ts
        modified:   src/lib/ai/services/intervention-analysis.ts
        modified:   src/lib/ai/services/prompt-optimizer.ts
        modified:   src/lib/ai/services/response-generation.ts
        modified:   src/lib/ai/services/response.ts
        modified:   src/lib/ai/services/sentiment-analysis.ts
        modified:   src/lib/ai/services/together.ts
        new file:   src/lib/ai/types.tmp
        modified:   src/lib/ai/types.ts
        new file:   src/lib/audit/index.ts
        modified:   src/lib/audit/log.ts
        modified:   src/lib/auth.ts
        modified:   src/lib/auth/index.ts
        modified:   src/lib/auth/middleware.ts
        modified:   src/lib/auth/session.d.ts
        modified:   src/lib/auth/session.ts
        modified:   src/lib/auth/types.ts
        modified:   src/lib/auth/zkAuth.ts
        modified:   src/lib/chat/index.ts
        modified:   src/lib/chat/zkChat.ts
        modified:   src/lib/crypto/encryption.ts
        modified:   src/lib/crypto/example.ts
        modified:   src/lib/crypto/index.ts
        modified:   src/lib/crypto/keyRotation.ts
        modified:   src/lib/crypto/keyStorage.ts
        modified:   src/lib/crypto/scheduledRotation.ts
        new file:   src/lib/crypto/types.ts
        new file:   src/lib/database.types.ts
        new file:   src/lib/db/ai-metrics.ts
        modified:   src/lib/db/ai/index.ts
        modified:   src/lib/db/ai/initialize.ts
        modified:   src/lib/db/ai/repository.ts
        modified:   src/lib/db/ai/schema.ts
        modified:   src/lib/db/ai/types.ts
        modified:   src/lib/db/conversations.ts
        modified:   src/lib/db/index.ts
        modified:   src/lib/db/messages.ts
        modified:   src/lib/db/migrations/20250320_add_ai_performance_metrics.ts
        new file:   src/lib/db/migrations/20250321_add_ai_usage_logs.ts
        modified:   src/lib/db/security/initialize.ts
        modified:   src/lib/db/security/schema.ts
        new file:   src/lib/db/supabase.ts
        modified:   src/lib/db/user-settings.ts
        modified:   src/lib/logging/index.ts
        modified:   src/lib/logging/rotation.ts
        new file:   src/lib/middleware/cors.ts
        new file:   src/lib/middleware/index.ts
        renamed:    src/middleware/logging.ts -> src/lib/middleware/logging.ts
        new file:   src/lib/middleware/rate-limit.ts
        new file:   src/lib/rate-limit.ts
        modified:   src/lib/security/index.ts
        modified:   src/lib/security/monitoring.ts
        modified:   src/lib/startup.ts
        modified:   src/lib/supabase.ts
        new file:   src/lib/supabase.types.ts
        new file:   src/lib/supabase/client.ts
        new file:   src/lib/types/supabase.ts
        modified:   src/lib/validation/index.ts
        modified:   src/lib/validation/schemas.ts
        modified:   src/lib/zk/index.ts
        modified:   src/lib/zk/types.ts
        modified:   src/lib/zk/zkProofService.ts
        deleted:    src/middleware/cors.ts
        deleted:    src/middleware/index.ts
        deleted:    src/middleware/rate-limit.ts
        modified:   src/pages/_app.ts
        modified:   src/pages/about.astro
        modified:   src/pages/admin/ai-performance.astro
        modified:   src/pages/admin/ai/high-risk-crises.astro
        modified:   src/pages/admin/ai/model-performance.astro
        modified:   src/pages/admin/ai/performance.astro
        modified:   src/pages/admin/ai/usage.astro
        modified:   src/pages/admin/flagged-messages.astro
        modified:   src/pages/admin/index.astro
        modified:   src/pages/admin/security-dashboard.astro
        modified:   src/pages/admin/zk-dashboard.astro
        modified:   src/pages/ai-chat.astro
        modified:   src/pages/api/ai/completion.ts
        modified:   src/pages/api/ai/crisis-detection.ts
        modified:   src/pages/api/ai/high-risk-detections.ts
        modified:   src/pages/api/ai/intervention-analysis.ts
        modified:   src/pages/api/ai/models.ts
        modified:   src/pages/api/ai/performance-metrics.ts
        modified:   src/pages/api/ai/response.ts
        modified:   src/pages/api/ai/sentiment.ts
        modified:   src/pages/api/ai/usage-stats.ts
        modified:   src/pages/api/ai/usage.ts
        modified:   src/pages/api/auth/callback.ts
        modified:   src/pages/api/auth/login.ts
        modified:   src/pages/api/auth/register.ts
        modified:   src/pages/api/auth/signin.ts
        modified:   src/pages/api/auth/signout.ts
        modified:   src/pages/api/chat/send.ts
        modified:   src/pages/api/contact.ts
        modified:   src/pages/api/health.ts
        modified:   src/pages/api/security/events.ts
        modified:   src/pages/blog/[...slug].astro
        modified:   src/pages/blog/[series].astro
        modified:   src/pages/blog/index.astro
        modified:   src/pages/blog/tag/[tag].astro
        modified:   src/pages/contact.astro
        modified:   src/pages/dashboard/index.astro
        modified:   src/pages/demo/chat.astro
        modified:   src/pages/dev/accessibility-test.astro
        modified:   src/pages/dev/browser-compatibility-test.astro
        modified:   src/pages/index.astro
        modified:   src/pages/login.astro
        modified:   src/pages/register.astro
        modified:   src/pages/settings/ai-preferences.astro
        modified:   src/pages/signin.astro
        new file:   src/scripts/record-deployment.ts
        new file:   src/scripts/rollback.ts
        modified:   src/scripts/rotateKeys.ts
        new file:   src/scripts/run-rollback.sh
        new file:   src/scripts/security-tests.ts
        modified:   src/scripts/update-deps.js
        new file:   src/scripts/verify-deployment.ts
        new file:   src/services/AIService.ts
        modified:   src/tests/ai/crisis-detection.test.ts
        modified:   src/tests/ai/intervention-analysis.test.ts
        modified:   src/tests/ai/response-generation.test.ts
        modified:   src/tests/ai/sentiment-analysis.test.ts
        new file:   src/tests/browser-compatibility.test.ts
        modified:   src/tests/crypto.test.ts
        new file:   src/tests/performance.test.ts
        modified:   src/types/supabase.ts
        modified:   src/utils/accessibilityPolyfills.ts
        modified:   src/utils/browserTesting.ts
        modified:   src/utils/date.ts
        modified:   src/utils/formatDate.ts
        new file:   src/utils/performance-optimization.ts
        new file:   src/utils/template.ts
        new file:   supabase/.branches/_current_branch
        new file:   supabase/.temp/cli-latest
        new file:   supabase/migrations/20250318153111_create_ai_metrics_table.sql
        new file:   templates/email/password-reset.html
        new file:   templates/email/welcome.html
        modified:   tests/security/ai-auth-bypass-tester.ts
        modified:   tests/security/ai-endpoint-scanner.ts
        modified:   tests/security/ai-vulnerability-scanner.ts
        modified:   tests/security/ai-web-vulnerability-scanner.ts
        modified:   tests/security/run-security-tests.sh
        deleted:    tools/README.md
        deleted:    tools/__pycache__/llm_api.cpython-310.pyc
        deleted:    tools/__pycache__/llm_api.cpython-311.pyc
        deleted:    tools/__pycache__/token_tracker.cpython-310.pyc
        deleted:    tools/__pycache__/token_tracker.cpython-311.pyc
        deleted:    tools/__pycache__/token_tracker.cpython-312.pyc
        deleted:    tools/direct_gemini.py
        deleted:    tools/llm_api.py
        deleted:    tools/plan_exec_llm.py
        deleted:    tools/preview-email.ts
        deleted:    tools/requirements.txt
        deleted:    tools/screenshot_utils.py
        deleted:    tools/search_engine.py
        deleted:    tools/simple_gemini.py
        deleted:    tools/test-emails.ts
        deleted:    tools/test_gemini.py
        deleted:    tools/test_tools.py
        deleted:    tools/token_tracker.py
        deleted:    tools/web_scraper.py

Changes not staged for commit:
  (use "git add/rm <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
  (commit or discard the untracked or modified content in submodules)
        deleted:    commit-message.txt
        deleted:    error-summary-fixed.mdx
        deleted:    error-summary.mdx
        modified:   fix-eslint.sh
        deleted:    fix_dates.sh
        deleted:    fix_frontmatter.sh
        deleted:    fix_mdx_quotes.sh
        deleted:    fix_shell_scripts.sh
        modified:   neon-chatbot (modified content, untracked content)
        modified:   security-updates-summary.md
        modified:   src/components/AIChat.tsx
        modified:   src/components/accessibility/ContrastChecker.tsx
        modified:   src/components/admin/PerformanceDashboard.astro
        modified:   src/components/admin/ZKSystemDashboard.tsx
        modified:   src/components/ai/AccessibleLoadingIndicator.tsx
        modified:   src/components/ai/PerformanceDashboard.tsx
        modified:   src/components/ai/chat/ChatContainer.tsx
        modified:   src/components/ai/chat/ChatInput.tsx
        modified:   src/components/ai/chat/ChatMessage.tsx
        modified:   src/components/ai/chat/useChatCompletion.ts
        modified:   src/components/ai/chat/useCrisisDetection.ts
        modified:   src/components/ai/chat/useResponseGeneration.ts
        modified:   src/components/ai/chat/useSentimentAnalysis.ts
        modified:   src/components/auth/ZKAuthStatus.tsx
        modified:   src/components/blog/ArticleCard.astro
        modified:   src/components/blog/ArticleHeader.astro
        modified:   src/components/blog/AuthorBio.astro
        modified:   src/components/blog/Divider.astro
        modified:   src/components/blog/SeriesNavigation.astro
        modified:   src/components/blog/SocialShare.astro
        modified:   src/components/blog/Subscribe.astro
        modified:   src/components/blog/TableOfContents.astro
        modified:   src/components/chat/ChatMessage.tsx
        modified:   src/components/chat/ZKChatStatus.tsx
        modified:   src/components/demo/ChatDemo.tsx
        modified:   src/components/layout/Layout.tsx
        modified:   src/components/security/SecurityDashboard.tsx
        modified:   src/components/testing/BrowserCompatibilityTester.tsx
        modified:   src/components/ui/AccessibilityAnnouncer.tsx
        modified:   src/components/ui/Button.astro
        modified:   src/components/ui/Footer.astro
        modified:   src/components/ui/Navigation.astro
        modified:   src/components/ui/ThemeToggle.astro
        modified:   src/components/widgets/SpinningGlobe.astro
        modified:   src/config.ts
        modified:   src/content/config.ts
        modified:   src/env.d.ts
        modified:   src/layouts/AdminLayout.astro
        modified:   src/layouts/AuthLayout.astro
        modified:   src/layouts/BaseLayout.astro
        modified:   src/layouts/BlogPostLayout.astro
        modified:   src/layouts/ChatLayout.astro
        modified:   src/layouts/StandardLayout.astro
        modified:   src/lib/access-control.ts
        modified:   src/lib/ai/__tests__/performance-optimizations.test.ts
        modified:   src/lib/ai/analytics.ts
        modified:   src/lib/ai/error-handling.ts
        modified:   src/lib/ai/factory.ts
        modified:   src/lib/ai/index.ts
        modified:   src/lib/ai/models/ai-types.ts
        modified:   src/lib/ai/models/registry.ts
        modified:   src/lib/ai/models/types.ts
        modified:   src/lib/ai/performance-optimizations.ts
        modified:   src/lib/ai/performance-tracker.ts
        modified:   src/lib/ai/performance.ts
        modified:   src/lib/ai/providers/together.ts
        modified:   src/lib/ai/services/ai-service.ts
        modified:   src/lib/ai/services/cache-service.ts
        modified:   src/lib/ai/services/connection-pool.ts
        modified:   src/lib/ai/services/crisis-detection.ts
        modified:   src/lib/ai/services/fallback-service.ts
        modified:   src/lib/ai/services/intervention-analysis.ts
        modified:   src/lib/ai/services/prompt-optimizer.ts
        modified:   src/lib/ai/services/response-generation.ts
        modified:   src/lib/ai/services/response.ts
        modified:   src/lib/ai/services/sentiment-analysis.ts
        modified:   src/lib/ai/services/together.ts
        modified:   src/lib/ai/types.ts
        modified:   src/lib/audit/log.ts
        modified:   src/lib/auth.ts
        modified:   src/lib/auth/middleware.ts
        modified:   src/lib/auth/session.d.ts
        modified:   src/lib/auth/session.ts
        modified:   src/lib/auth/types.ts
        modified:   src/lib/auth/zkAuth.ts
        modified:   src/lib/chat/zkChat.ts
        modified:   src/lib/crypto/encryption.ts
        modified:   src/lib/crypto/example.ts
        modified:   src/lib/crypto/index.ts
        modified:   src/lib/crypto/keyRotation.ts
        modified:   src/lib/crypto/keyStorage.ts
        modified:   src/lib/crypto/scheduledRotation.ts
        modified:   src/lib/crypto/types.ts
        modified:   src/lib/database.types.ts
        modified:   src/lib/db/ai-metrics.ts
        modified:   src/lib/db/ai/index.ts
        modified:   src/lib/db/ai/initialize.ts
        modified:   src/lib/db/ai/repository.ts
        modified:   src/lib/db/ai/schema.ts
        modified:   src/lib/db/ai/types.ts
        modified:   src/lib/db/index.ts
        modified:   src/lib/db/messages.ts
        modified:   src/lib/db/security/initialize.ts
        modified:   src/lib/db/security/schema.ts
        modified:   src/lib/db/supabase.ts
        modified:   src/lib/db/user-settings.ts
        modified:   src/lib/logging/index.ts
        modified:   src/lib/logging/rotation.ts
        modified:   src/lib/middleware/cors.ts
        modified:   src/lib/middleware/index.ts
        modified:   src/lib/middleware/logging.ts
        modified:   src/lib/middleware/rate-limit.ts
        modified:   src/lib/rate-limit.ts
        modified:   src/lib/security/index.ts
        modified:   src/lib/security/monitoring.ts
        modified:   src/lib/startup.ts
        modified:   src/lib/supabase.ts
        modified:   src/lib/supabase/client.ts
        modified:   src/lib/types/supabase.ts
        modified:   src/lib/validation/index.ts
        modified:   src/lib/validation/schemas.ts
        modified:   src/lib/zk/index.ts
        modified:   src/lib/zk/types.ts
        modified:   src/lib/zk/zkProofService.ts
        modified:   src/pages/_app.ts
        modified:   src/pages/about.astro
        modified:   src/pages/admin/ai-performance.astro
        modified:   src/pages/admin/ai/high-risk-crises.astro
        modified:   src/pages/admin/ai/model-performance.astro
        modified:   src/pages/admin/ai/performance.astro
        modified:   src/pages/admin/ai/usage.astro
        modified:   src/pages/admin/flagged-messages.astro
        modified:   src/pages/admin/index.astro
        modified:   src/pages/admin/security-dashboard.astro
        modified:   src/pages/admin/zk-dashboard.astro
        modified:   src/pages/api/ai/completion.ts
        modified:   src/pages/api/ai/crisis-detection.ts
        modified:   src/pages/api/ai/high-risk-detections.ts
        modified:   src/pages/api/ai/intervention-analysis.ts
        modified:   src/pages/api/ai/models.ts
        modified:   src/pages/api/ai/performance-metrics.ts
        modified:   src/pages/api/ai/response.ts
        modified:   src/pages/api/ai/sentiment.ts
        modified:   src/pages/api/ai/usage-stats.ts
        modified:   src/pages/api/ai/usage.ts
        modified:   src/pages/api/auth/callback.ts
        modified:   src/pages/api/auth/login.ts
        modified:   src/pages/api/auth/register.ts
        modified:   src/pages/api/auth/signin.ts
        modified:   src/pages/api/auth/signout.ts
        modified:   src/pages/api/chat/send.ts
        modified:   src/pages/api/contact.ts
        modified:   src/pages/api/health.ts
        modified:   src/pages/api/security/events.ts
        modified:   src/pages/blog/[...slug].astro
        modified:   src/pages/blog/[series].astro
        modified:   src/pages/blog/index.astro
        modified:   src/pages/blog/tag/[tag].astro
        modified:   src/pages/contact.astro
        modified:   src/pages/dashboard/index.astro
        modified:   src/pages/demo/chat.astro
        modified:   src/pages/dev/accessibility-test.astro
        modified:   src/pages/dev/browser-compatibility-test.astro
        modified:   src/pages/index.astro
        modified:   src/pages/login.astro
        modified:   src/pages/register.astro
        modified:   src/pages/settings/ai-preferences.astro
        modified:   src/pages/signin.astro
        modified:   src/scripts/record-deployment.ts
        modified:   src/scripts/rollback.ts
        modified:   src/scripts/rotateKeys.ts
        modified:   src/scripts/run-rollback.sh
        modified:   src/scripts/security-tests.ts
        modified:   src/scripts/verify-deployment.ts
        modified:   src/services/AIService.ts
        modified:   src/tests/ai/crisis-detection.test.ts
        modified:   src/tests/ai/intervention-analysis.test.ts
        modified:   src/tests/ai/response-generation.test.ts
        modified:   src/tests/ai/sentiment-analysis.test.ts
        modified:   src/tests/browser-compatibility.test.ts
        modified:   src/tests/crypto.test.ts
        modified:   src/tests/performance.test.ts
        modified:   src/types/supabase.ts
        modified:   src/utils/accessibilityPolyfills.ts
        modified:   src/utils/browserTesting.ts
        modified:   src/utils/date.ts
        modified:   src/utils/formatDate.ts
        modified:   src/utils/performance-optimization.ts
        modified:   src/utils/template.ts
        modified:   templates/email/password-reset.html
        modified:   templates/email/welcome.html
        modified:   tests/security/run-security-tests.sh

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        src/scripts/run-rollback.sh.bak
        tests/security/run-security-tests.sh.bak


```

---

Let's check if there's a larger version of the trunk.yaml file in your repo that might be causing the issue:

---

```bash
cd ~/astro && find . -type f -name "*.yaml" -not -path "./neon-chatbot/*" -exec grep -l "environment" {} \; | xargs wc -l | sort -nr
```

```
(base) ┌───(vivi@macattack)-[~/astro][main*] 

```

---

Let's look at the .trunk folder more deeply:

---

<details>
            <summary>Listed directory .trunk/plugins • **1** results</summary>
        
| Name |
|-------|
| 📁 `trunk` |

</details>

---

Let's check the config directory:

---

<details>
            <summary>Listed directory .trunk/configs • **7** results</summary>
        
| Name |
|-------|
| 📄 `.yamllint.yaml` |
| 📄 `.markdownlint.yaml` |
| 📄 `.shellcheckrc` |
| 📄 `gitleaks.toml` |
| 📄 `svgo.config.mjs` |
| 📄 `ruff.toml` |
| 📄 `.isort.cfg` |

</details>

---



---



---

