<!-- Generated by SpecStory -->

# Fixing Test Failures and Mock Issues (2025-03-27 19:54:08)

_**User**_

lets fix

---

_**Assistant**_

I'll help you fix the failing tests. Looking at the errors, there are several issues we need to address:

1. Redis mock issues - many tests are failing because Redis methods are undefined
2. `crypto.randomUUID` is not available
3. WebSocket server mocking issues
4. Logger mocking issues

Let me first search for the relevant test files to understand the setup.

---

<details>
            <summary>Searched codebase "AnalyticsService.test.ts NotificationService.test.ts WebSocketServer.test.ts EmailService.test.ts" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/lib/services/analytics/AnalyticsService.ts` | L307-325 |
| `src/lib/services/notification/__tests__/NotificationService.test.ts` | L289-332 |
| `src/lib/services/notification/NotificationService.ts` | L117-130 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L10-81 |
| `src/workers/__tests__/analytics-worker.test.ts` | L1-8 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L1-8 |
| `src/lib/services/notification/__tests__/NotificationService.test.ts` | L1-13 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L1-9 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L38-73 |
| `src/workers/__tests__/analytics-worker.test.ts` | L126-194 |
| `src/workers/__tests__/analytics-worker.test.ts` | L194-244 |
| `src/workers/__tests__/notification-worker.test.ts` | L1-8 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L73-129 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L255-324 |
| `src/lib/services/analytics/AnalyticsService.ts` | L258-269 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L9-10 |
| `src/workers/__tests__/notification-worker.test.ts` | L127-191 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L129-202 |
| `src/workers/__tests__/notification-worker.test.ts` | L8-9 |
| `src/lib/services/notification/NotificationService.ts` | L1-14 |
| `src/lib/services/notification/__tests__/NotificationService.test.ts` | L15-16 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L9-10 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L21-30 |
| `src/workers/__tests__/analytics-worker.test.ts` | L11-69 |
| `src/lib/services/notification/__tests__/WebSocketServer.test.ts` | L11-13 |

</details>

---

Let me check the Redis mock setup to understand how it's configured.

---

<details>
            <summary>Searched codebase "redis mock setup vitest" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/lib/services/email/__tests__/EmailService.test.ts` | L1-14 |
| `src/lib/services/notification/__tests__/NotificationService.test.ts` | L1-13 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L1-8 |
| `src/lib/analytics/__tests__/breach-analytics.test.ts` | L1-20 |
| `src/lib/services/redis/__tests__/RedisService.test.ts` | L1-14 |
| `src/lib/security/__tests__/breach-notification.test.ts` | L1-16 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L26-49 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L93-105 |
| `src/lib/services/redis/__tests__/test-utils.ts` | L186-253 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L67-93 |
| `src/lib/security/__tests__/breach-notification.integration.test.ts` | L1-10 |
| `src/lib/services/redis/__tests__/jest.global.setup.ts` | L1-45 |
| `src/lib/ai/services/__tests__/PatternRecognitionService.test.ts` | L1-8 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L1-7 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L7-26 |
| `src/lib/ai/services/__tests__/PatternRecognitionService.test.ts` | L8-9 |
| `src/lib/services/redis/__tests__/test-utils.ts` | L253-265 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L1-37 |
| `src/lib/redis.ts` | L44-59 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L49-67 |
| `src/lib/services/redis/__tests__/RedisService.test.ts` | L14-74 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L453-517 |
| `src/lib/services/redis/__tests__/RedisService.test.ts` | L74-142 |
| `src/lib/security/__tests__/breach-notification.integration.test.ts` | L14-58 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L255-324 |

</details>

---

Let me check the Redis mock implementation.

---

<details>
            <summary>Searched codebase "createMockRedisClient mock redis implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/lib/redis.ts` | L44-59 |
| `src/lib/services/redis/__tests__/RedisService.test.ts` | L1-14 |
| `src/lib/redis.ts` | L1-44 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L26-49 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L1-8 |
| `src/lib/services/redis/__tests__/test-utils.ts` | L186-253 |
| `src/lib/services/email/__tests__/EmailService.test.ts` | L1-14 |
| `src/lib/analytics/__tests__/breach-analytics.test.ts` | L1-20 |
| `src/lib/services/notification/__tests__/NotificationService.test.ts` | L1-13 |
| `src/lib/ehr/services/redis.storage.ts` | L1-58 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L453-517 |
| `src/lib/services/analytics/__tests__/AnalyticsService.test.ts` | L255-324 |
| `src/lib/services/redis/__tests__/PatternRecognition.integration.test.ts` | L1-51 |
| `src/lib/services/redis/index.ts` | L11-47 |
| `src/lib/services/redis/__tests__/RedisService.test.ts` | L14-74 |
| `src/lib/services/redis/__tests__/test-utils.ts` | L144-160 |
| `src/lib/services/redis/__tests__/Analytics.integration.test.ts` | L1-52 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L344-390 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L1-37 |
| `src/lib/services/redis/types.ts` | L49-86 |
| `src/lib/services/redis/__tests__/jest.global.setup.ts` | L1-45 |
| `src/lib/services/redis/__tests__/CacheInvalidation.integration.test.ts` | L1-51 |
| `src/lib/services/redis/__tests__/RedisService.integration.test.ts` | L260-296 |
| `src/lib/services/redis/__tests__/jest.setup.ts` | L93-105 |
| `src/lib/services/redis/__tests__/test-utils.ts` | L1-13 |

</details>

---

I see the issue. The Redis mock implementation is incomplete. Let me fix the Redis mock and other issues:

1. First, let's fix the Redis mock:

---

```diff
  
  // Mock dependencies
- vi.mock('@/lib/services/redis')
+ vi.mock('@/lib/services/redis', () => ({
+   redis: {
+     lpush: vi.fn(),
+     rpoplpush: vi.fn(),
+     lrem: vi.fn(),
+     llen: vi.fn(),
+     lrange: vi.fn(),
+     zadd: vi.fn(),
+     zrangebyscore: vi.fn(),
+     zremrangebyscore: vi.fn(),
+     keys: vi.fn(),
+     hget: vi.fn(),
+     hgetall: vi.fn(),
+     hset: vi.fn(),
+     hdel: vi.fn(),
+     del: vi.fn(),
+   },
+ }))
  vi.mock('@/lib/utils/logger')
  vi.mock('ws')
```

---

2. Now let's fix the crypto.randomUUID issue by adding a mock for it:

---

```diff
    },
  }))
+ 
+ vi.mock('crypto', () => ({
+   randomUUID: () => 'test-uuid',
+ }))
+ 
  vi.mock('@/lib/utils/logger')
  vi.mock('ws')
```

---

3. Let's fix the WebSocket server mock:

---

```diff
  
  // Mock dependencies
- vi.mock('ws')
+ vi.mock('ws', () => ({
+   WebSocket: vi.fn().mockImplementation(() => ({
+     send: vi.fn(),
+     close: vi.fn(),
+     on: vi.fn(),
+     emit: vi.fn(),
+   })),
+   WebSocketServer: vi.fn().mockImplementation(() => ({
+     on: vi.fn(),
+     emit: vi.fn(),
+     clients: new Set(),
+   })),
+ }))
+ 
  vi.mock('../NotificationService')
  vi.mock('@/lib/utils/logger', () => ({
        error: vi.fn(),
        warn: vi.fn(),
-       debug: vi.fn()
-     })
-   }
+       debug: vi.fn(),
+     }),
+   },
  }))
  
```

---

4. Let's fix the logger mock in the NotificationService test:

---

```diff
  
  // Mock dependencies
- vi.mock('@/lib/services/redis')
- vi.mock('@/config/env.config')
- vi.mock('ws')
+ vi.mock('@/lib/services/redis', () => ({
+   redis: {
+     lpush: vi.fn(),
+     rpoplpush: vi.fn(),
+     lrem: vi.fn(),
+     llen: vi.fn(),
+     lrange: vi.fn(),
+     zadd: vi.fn(),
+     zrangebyscore: vi.fn(),
+     zremrangebyscore: vi.fn(),
+     keys: vi.fn(),
+     hget: vi.fn(),
+     hgetall: vi.fn(),
+     hset: vi.fn(),
+     hdel: vi.fn(),
+     del: vi.fn(),
+   },
+ }))
+ 
+ vi.mock('@/lib/utils/logger', () => ({
+   logger: {
+     info: vi.fn(),
+     error: vi.fn(),
+     warn: vi.fn(),
+     debug: vi.fn(),
+   },
+ }))
+ 
  vi.mock('@/lib/services/email/EmailService')
  
```

---

5. Let's also fix the EmailService test:

---

```diff
      lrem: vi.fn(),
      llen: vi.fn(),
+     lrange: vi.fn(),
+     zadd: vi.fn(),
+     zrangebyscore: vi.fn(),
+     zremrangebyscore: vi.fn(),
+     keys: vi.fn(),
+     hget: vi.fn(),
+     hgetall: vi.fn(),
+     hset: vi.fn(),
+     hdel: vi.fn(),
+     del: vi.fn(),
+   },
+ }))
+ 
+ vi.mock('@/lib/utils/logger', () => ({
+   logger: {
+     info: vi.fn(),
+     error: vi.fn(),
+     warn: vi.fn(),
+     debug: vi.fn(),
    },
  }))
```

---

Now let's run the tests again to see if we've fixed the issues:

---

```bash
pnpm test
```

```
pnpm test
(base) ┌───(vivi@macattack)-[~/astro]
└─$ pnpm test

> gradiant-astro@0.0.1 test /Users/vivi/astro
> vitest

 Vitest  "deps.inline" is deprecated. If you rely on vite-node directly, use "server.deps.inline" instead. O
therwise, consider using "deps.optimizer.web.include"

 DEV  v3.0.9 /Users/vivi/astro

stderr | src/tests/ai/crisis-detection.test.ts > crisisDetectionService > detectCrisis > should handle inval
id JSON responses
Error parsing crisis detection result: SyntaxError: Unexpected token 'N', "Not a vali"... is not valid JSON
    at JSON.parse (<anonymous>)
    at CrisisDetectionService.detectCrisis (/Users/vivi/astro/src/lib/ai/services/crisis-detection.ts:97:27)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)

 ❯ src/lib/ehr/__tests__/allscripts.test.ts (0 test)
 ❯ src/tests/ai/crisis-detection.test.ts (11 tests | 7 failed) 175ms
   × crisisDetectionService > detectCrisis > should detect high-risk crisis correctly 50ms
     → expected { isCrisis: true, …(5) } to deeply equal { isCrisis: true, …(6) }
   × crisisDetectionService > detectCrisis > should detect medium-risk crisis correctly 5ms
     → expected { isCrisis: true, …(5) } to deeply equal { isCrisis: true, …(6) }
   × crisisDetectionService > detectCrisis > should detect low-risk crisis correctly 4ms
     → expected { isCrisis: true, …(5) } to deeply equal { isCrisis: true, …(6) }
   × crisisDetectionService > detectCrisis > should correctly identify non-crisis text 3ms
     → expected { isCrisis: false, …(5) } to deeply equal { isCrisis: false, …(6) }
   ✓ crisisDetectionService > detectCrisis > should handle invalid JSON responses
   ✓ crisisDetectionService > detectCrisis > should handle AI service errors
   × crisisDetectionService > detectCrisis > should respect sensitivity level 90ms
     → expected "spy" to be called with arguments: [ ArrayContaining{…}, …(1) ]

Received: 

  1st spy call:

  [
-   ArrayContaining [
-     ObjectContaining {
-       "content": StringContaining "high sensitivity",
+   [
+     {
+       "content": "You are a crisis detection system designed to identify potential crisis situations in te
xt.
+       Analyze the following text for signs of:
+       - Self-harm or suicidal ideation
+       - Harm to others
+       - Abuse or violence
+       - Medical emergencies
+       - Severe psychological distress
+
+       The current sensitivity level is set to: HIGH
+
+       LOW sensitivity: Only flag the most explicit and clear threats or emergencies.
+       MEDIUM sensitivity: Flag explicit threats and strong indicators of crisis.
+       HIGH sensitivity: Flag both explicit threats and subtle indicators of potential crisis.
+
+       Return the result as a JSON object with the following structure:
+       {
+         \"isCrisis\": boolean,
+         \"confidence\": number, // 0 to 1
+         \"category\": string, // e.g., \"self-harm\", \"suicide\", \"harm_to_others\", \"abuse\", \"medica
l_emergency\", \"psychological_distress\"
+         \"severity\": \"low\" | \"medium\" | \"high\",
+         \"recommendedAction\": string // Explanation of the reasoning behind the result
+       }",
+       "name": "",
        "role": "system",
      },
-     ObjectContaining {
+     {
+       "content": "I'm feeling really anxious about everything.",
+       "name": "",
        "role": "user",
      },
    ],
-   ObjectContaining {
+   {
      "model": "test-model",
    },
  ]


Number of calls: 1

   ✓ crisisDetectionService > detectBatch > should analyze multiple texts in parallel
   ✓ crisisDetectionService > detectBatch > should handle errors in batch processing
   × crisisDetectionService > constructor > should use default model if not provided 1ms
     → Cannot read properties of undefined (reading 'model')
   × crisisDetectionService > constructor > should use custom system prompt if provided 2ms
     → Cannot read properties of undefined (reading 'defaultPrompt')
 ❯ src/tests/crypto.test.ts (22 tests | 10 failed) 194ms
   ✓ encryption > should encrypt and decrypt data correctly
   ✓ encryption > should include version in encrypted data
   ✓ encryption > should throw error when decrypting with wrong key
   ✓ keyRotationManager > should add a new key
   ✓ keyRotationManager > should rotate a key
   ✓ keyRotationManager > should identify keys that need rotation
   × keyRotationManager > should re-encrypt data with the latest key version 16ms
     → Failed to decrypt data
   ✓ keyStorage > should generate and store a key
   ✓ keyStorage > should retrieve a stored key
   ✓ keyStorage > should rotate a key
   × keyStorage > should list keys by purpose 7ms
     → expected 1 to be 2 // Object.is equality
   ✓ keyStorage > should delete a key
   × scheduledKeyRotation > should start and stop scheduled rotation 89ms
     → [Function setInterval] is not a spy or a call to a spy!
   ✓ scheduledKeyRotation > should check and rotate expired keys
   ✓ scheduledKeyRotation > should force rotate a specific key
   × createCryptoSystem > should create a complete crypto system 11ms
     → expected undefined to be [Function Encryption] // Object.is equality
   × createCryptoSystem > should enable scheduled rotation when specified 3ms
     → crypto.stopScheduledRotation is not a function
   × createCryptoSystem > should encrypt and decrypt data with automatic key management 4ms
     → expected 'dGVzdDpwYXRpZW50LWRhdGE6ODMsMTAxLDExM…' to contain ':v1:'
   × createCryptoSystem > should rotate expired keys 0ms
     → Cannot read properties of undefined (reading 'getKey')
   × fully Homomorphic Encryption Integration Tests > should process data securely with FHE 0ms
     → (0 , createFHESystem) is not a function
   × fully Homomorphic Encryption Integration Tests > should verify sender identity securely 0ms
     → (0 , createFHESystem) is not a function
   × fully Homomorphic Encryption Integration Tests > should encrypt and decrypt data securely 0ms
     → (0 , createFHESystem) is not a function
 ❯ src/lib/services/redis/__tests__/RedisService.integration.test.ts (0 test)
stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Chrome Browser Tests > visu
al test - 
Failed to navigate to Home Page on Chrome

 ❯ src/tests/ai/intervention-analysis.test.ts (8 tests | 5 failed) 68ms
   × interventionAnalysisService > analyzeIntervention > should analyze intervention effectiveness correctly
 41ms
     → Failed to parse intervention analysis result
   × interventionAnalysisService > analyzeIntervention > should handle custom analysis prompt 8ms
     → customPrompt is not defined
   ✓ interventionAnalysisService > analyzeIntervention > should handle invalid JSON responses
   ✓ interventionAnalysisService > analyzeIntervention > should handle AI service errors
   × interventionAnalysisService > analyzeBatch > should analyze multiple interventions in parallel 2ms
     → Failed to parse intervention analysis result
   ✓ interventionAnalysisService > analyzeBatch > should handle errors in batch processing
   × interventionAnalysisService > constructor > should use default model if not provided 1ms
     → Cannot read properties of undefined (reading 'model')
   × interventionAnalysisService > constructor > should use custom system prompt if provided 1ms
     → Cannot read properties of undefined (reading 'systemPrompt')
stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Chrome Browser Tests > visu
al test - 
Failed to navigate to Dashboard on Chrome

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Chrome Browser Tests > visu
al test - 
Failed to navigate to Chat on Chrome

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Chrome Browser Tests > visu
al test - 
Failed to navigate to Settings on Chrome

 ❯ src/lib/services/redis/__tests__/PatternRecognition.integration.test.ts (0 test)
 ✓ src/tests/ai/response-generation.test.ts (13 tests) 27ms
 ❯ src/tests/performance.test.ts (11 tests | 10 failed) 2368ms
   × performance Tests > core Web Vitals -  450ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "networkidle"

   × performance Tests > first Input Delay -  71ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   × performance Tests > core Web Vitals -  79ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/dashboard
Call log:
  - navigating to "http://localhost:3000/app/dashboard", waiting until "networkidle"

   × performance Tests > first Input Delay -  99ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/dashboard
Call log:
  - navigating to "http://localhost:3000/app/dashboard", waiting until "load"

   × performance Tests > core Web Vitals -  71ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/chat
Call log:
  - navigating to "http://localhost:3000/app/chat", waiting until "networkidle"

   × performance Tests > first Input Delay -  110ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/chat
Call log:
  - navigating to "http://localhost:3000/app/chat", waiting until "load"

   × performance Tests > core Web Vitals -  146ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/settings
Call log:
  - navigating to "http://localhost:3000/app/settings", waiting until "networkidle"

   × performance Tests > first Input Delay -  113ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/app/settings
Call log:
  - navigating to "http://localhost:3000/app/settings", waiting until "load"

   × performance Tests > aPI Performance -  194ms
     → page.evaluate: TypeError: Failed to fetch
    at eval (eval at evaluate (:234:30), <anonymous>:2:20)
    at UtilityScript.evaluate (<anonymous>:236:17)
    at UtilityScript.<anonymous> (<anonymous>:1:44)
   × performance Tests > aPI Performance -  97ms
     → page.evaluate: TypeError: Failed to fetch
    at eval (eval at evaluate (:234:30), <anonymous>:2:35)
    at UtilityScript.evaluate (<anonymous>:236:17)
    at UtilityScript.<anonymous> (<anonymous>:1:44)
   ✓ performance Tests > performance regression test
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts (0 test)
 ❯ src/tests/ai/sentiment-analysis.test.ts (9 tests | 6 failed) 13ms
   × sentimentAnalysisService > analyzeSentiment > should analyze sentiment correctly for positive text 6ms
     → Failed to parse sentiment analysis result
   × sentimentAnalysisService > analyzeSentiment > should analyze sentiment correctly for negative text 0ms
     → Failed to parse sentiment analysis result
   × sentimentAnalysisService > analyzeSentiment > should analyze sentiment correctly for neutral text 1ms
     → Failed to parse sentiment analysis result
   ✓ sentimentAnalysisService > analyzeSentiment > should handle invalid JSON responses
   ✓ sentimentAnalysisService > analyzeSentiment > should handle AI service errors
   × sentimentAnalysisService > analyzeBatch > should analyze multiple texts in parallel 1ms
     → Failed to parse sentiment analysis result
   ✓ sentimentAnalysisService > analyzeBatch > should handle errors in batch processing
   × sentimentAnalysisService > constructor > should use default model if not provided 1ms
     → Cannot read properties of undefined (reading 'model')
   × sentimentAnalysisService > constructor > should use custom system prompt if provided 1ms
     → Cannot read properties of undefined (reading 'defaultPrompt')
stderr | src/e2e/breach-notification.spec.ts
Using mock Supabase client for audit logging in development. This should not be used in production.

stderr | src/e2e/breach-notification.spec.ts
Using mock Supabase client for development. This should not be used in production.
Using mock Supabase client for development. This should not be used in production.

 ❯ src/e2e/breach-notification.spec.ts (0 test)
 ❯ src/lib/services/redis/__tests__/Analytics.integration.test.ts (0 test)
 ❯ src/lib/security/__tests__/security-scanning.test.ts (5 tests | 4 failed) 45ms
   × security Scanning Configuration > gitHub Workflow Configuration > should have proper security scanning 
workflow configuration 29ms
     → expected [ 10, 110, 97, 109, 101, 58, …(1747) ] to include 'name: Security Scanning'
   × security Scanning Configuration > gitleaks Configuration > should have proper Gitleaks configuration wi
th healthcare patterns 7ms
     → expected [ Array(1025) ] to include 'title = "Gitleaks Healthcare Configur…'
   × security Scanning Configuration > codeQL Configuration > should have proper CodeQL configuration with E
HR security queries 2ms
     → expected [ 10, 110, 97, 109, 101, 58, …(493) ] to include 'name: "EHR Security Analysis"'
   × security Scanning Configuration > custom FHIR Security Queries > should have proper FHIR security queri
es 1ms
     → expected [ 10, 47, 42, 42, 10, 32, 42, …(575) ] to include '@name Unvalidated FHIR Resource Access'
   ✓ security Scanning Configuration > security Baseline > should have proper security baseline configuratio
n
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts (0 test)
 ❯ src/lib/services/redis/__tests__/CacheInvalidation.integration.test.ts (0 test)
stderr | src/lib/ai/__tests__/performance-optimizations.test.ts
[2025-03-27T23:57:04.241Z] [INFO] HIPAA Audit logging service initialized

 ❯ src/lib/ai/__tests__/performance-optimizations.test.ts (6 tests | 5 failed) 29ms
   ✓ advanced performance optimizations > should pass through requests to the underlying service
   × advanced performance optimizations > should track performance metrics 5ms
     → expected "spy" to be called 1 times, but got 0 times
   × advanced performance optimizations > should cache responses and return cached results 2ms
     → expected "spy" to be called 1 times, but got 2 times
   × advanced performance optimizations > should optimize tokens for long conversations 6ms
     → expected 'You are a helpful assistant.' to be 'Final message that should be included…' // Object.is e
quality
   × advanced performance optimizations > should handle rate limiting 6ms
     → promise resolved "{ id: 'test-id', …(5) }" instead of rejecting
   × advanced performance optimizations > should try fallback models when primary model fails 3ms
     → expected "spy" to be called with arguments: [ ObjectContaining{…} ]

Received: 

  1st spy call:

  [
-   ObjectContaining {
-     "model": "fallback-model-1",
+   [
+     {
+       "content": "Hello",
+       "name": "user",
+       "role": "user",
+     },
+   ],
+   {
+     "model": "primary-model",
+     "temperature": 1,
    },
  ]


Number of calls: 1

 ❯ src/lib/security/__tests__/breach-notification.test.ts (0 test)
 ❯ src/lib/services/analytics/__tests__/AnalyticsService.test.ts (17 tests | 5 failed) 34ms
   × analyticsService > trackEvent > should track an event successfully 12ms
     → crypto.randomUUID is not a function
   ✓ analyticsService > trackEvent > should validate event data
   × analyticsService > trackEvent > should notify WebSocket subscribers 2ms
     → crypto.randomUUID is not a function
   ✓ analyticsService > trackMetric > should track a metric successfully
   ✓ analyticsService > trackMetric > should store metric tags
   ✓ analyticsService > trackMetric > should validate metric data
   ✓ analyticsService > processEvents > should process queued events
   ✓ analyticsService > processEvents > should handle empty queue
   ✓ analyticsService > processEvents > should handle processing errors
   ✓ analyticsService > getEvents > should get events by type and time range
   × analyticsService > getEvents > should handle time range and pagination 0ms
     → Cannot read properties of undefined (reading 'map')
   ✓ analyticsService > getMetrics > should get metrics by name and time range
   ✓ analyticsService > getMetrics > should filter metrics by tags
   ✓ analyticsService > cleanup > should clean up old events and metrics
   ✓ analyticsService > cleanup > should handle cleanup errors
   × analyticsService > webSocket integration > should register and unregister WebSocket clients 4ms
     → expected WebSocket{ …(27) } to be undefined
   × analyticsService > webSocket integration > should notify only relevant subscribers 3ms
     → crypto.randomUUID is not a function
stderr | src/components/chat/__tests__/AnalyticsDashboard.test.tsx
[2025-03-27T23:57:05.523Z] [INFO] Homomorphic Operations initialized in client environment

stderr | src/components/chat/__tests__/AnalyticsDashboard.test.tsx
[2025-03-27T23:57:05.541Z] [INFO] Key Rotation Service initialized in client environment

stderr | src/components/chat/__tests__/AnalyticsDashboard.test.tsx
[2025-03-27T23:57:05.566Z] [INFO] FHE Service initialized in client environment

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Firefox Browser Tests > vis
ual test - 
Failed to navigate to Home Page on Firefox

stderr | src/components/chat/__tests__/AnalyticsDashboard.test.tsx > analyticsDashboard > handles errors gra
cefully
Analytics error: Error: Test error
    at /Users/vivi/astro/src/components/chat/__tests__/AnalyticsDashboard.test.tsx:185:7
    at file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:182:14
    at file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:573:28
    at file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:64:24
    at new Promise (<anonymous>)
    at runWithTimeout (file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:41:12)
    at runTest (file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:1202:17)
    at runSuite (file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:1356:15)
    at runSuite (file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:1356:15)
    at runFiles (file:///Users/vivi/astro/node_modules/@vitest/runner/dist/index.js:1413:5)

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Firefox Browser Tests > vis
ual test - 
Failed to navigate to Dashboard on Firefox

 ❯ src/workers/__tests__/analytics-worker.test.ts (13 tests | 13 failed) 41ms
   × analytics-worker > startWorker > should start processing analytics events at the specified interval 19m
s
     → crypto.randomUUID is not a function
   × analytics-worker > startWorker > should handle startup errors gracefully 2ms
     → crypto.randomUUID is not a function
   × analytics-worker > startWorker > should handle processing errors gracefully 0ms
     → Startup error
   × analytics-worker > shutdown handling > should handle SIGTERM signal 2ms
     → crypto.randomUUID is not a function
   × analytics-worker > shutdown handling > should handle SIGINT signal 1ms
     → crypto.randomUUID is not a function
   × analytics-worker > shutdown handling > should close WebSocket server on shutdown 5ms
     → crypto.randomUUID is not a function
   × analytics-worker > environment configuration > should use default WebSocket port if not configured 1ms
     → crypto.randomUUID is not a function
   × analytics-worker > environment configuration > should use configured WebSocket port 1ms
     → crypto.randomUUID is not a function
   × analytics-worker > webSocket handling > should handle client authentication 1ms
     → crypto.randomUUID is not a function
   × analytics-worker > webSocket handling > should handle invalid authentication 2ms
     → crypto.randomUUID is not a function
   × analytics-worker > webSocket handling > should handle WebSocket server errors 2ms
     → crypto.randomUUID is not a function
   × analytics-worker > cleanup handling > should run cleanup at specified interval 1ms
     → crypto.randomUUID is not a function
   × analytics-worker > cleanup handling > should handle cleanup errors gracefully 1ms
     → crypto.randomUUID is not a function
stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Firefox Browser Tests > vis
ual test - 
Failed to navigate to Chat on Firefox

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Firefox Browser Tests > vis
ual test - 
Failed to navigate to Settings on Firefox

 ❯ src/lib/ai/services/__tests__/PatternRecognition.integration.test.ts (7 tests | 7 skipped) 7ms
 ❯ src/lib/ai/services/__tests__/PatternRecognitionService.test.ts (6 tests | 6 failed) 5ms
   × patternRecognitionService > analyzeLongTermTrends > should analyze trends with sufficient data points 3
ms
     → FHEService is not a constructor
   × patternRecognitionService > analyzeLongTermTrends > should throw error when FHE processing fails 0ms
     → FHEService is not a constructor
   × patternRecognitionService > detectCrossSessionPatterns > should detect patterns across multiple session
s 0ms
     → FHEService is not a constructor
   × patternRecognitionService > detectCrossSessionPatterns > should filter out low confidence patterns 0ms
     → FHEService is not a constructor
   × patternRecognitionService > analyzeRiskFactorCorrelations > should analyze risk factors and their corre
lations 0ms
     → FHEService is not a constructor
   × patternRecognitionService > analyzeRiskFactorCorrelations > should handle empty analysis data 0ms
     → FHEService is not a constructor
 ❯ src/lib/services/redis/__tests__/RedisService.perf.test.ts (0 test)

 ❯ src/lib/websocket/__tests__/server.test.ts (10 tests | 10 failed) 15ms
   × therapyChatWebSocketServer > handleConnection > should add new client on connection 9ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > handleConnection > should handle message events 0ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > handleConnection > should handle encrypted messages with FHE 0ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > handleConnection > should handle status updates 0ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > handleConnection > should handle client disconnection 0ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > handleConnection > should handle message parsing errors 1ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > broadcast methods > should broadcast to specific session 1ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > broadcast methods > should broadcast to all clients 0ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > error handling > should handle FHE initialization errors 1ms
     → Cannot read properties of undefined (reading 'info')
   × therapyChatWebSocketServer > error handling > should handle missing session ID 1ms
     → Cannot read properties of undefined (reading 'info')

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Safari Browser Tests > visu
al test - 
Failed to navigate to Home Page on Safari


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Safari Browser Tests > visu
al test - 
Failed to navigate to Dashboard on Safari


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Safari Browser Tests > visu
al test - 
Failed to navigate to Chat on Safari


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Safari Browser Tests > visu
al test - 
Failed to navigate to Settings on Safari




 ✓ src/hooks/__tests__/useNotificationPreferences.test.ts (7 tests) 43ms

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > iPhone 12 Mobile Tests > re
sponsive design - 
Failed to navigate to Home Page on iPhone 12

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > iPhone 12 Mobile Tests > re
sponsive design - 
Failed to navigate to Dashboard on iPhone 12


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > iPhone 12 Mobile Tests > re
sponsive design - 
Failed to navigate to Chat on iPhone 12

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > iPhone 12 Mobile Tests > re
sponsive design - 
Failed to navigate to Settings on iPhone 12



stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Pixel 5 Mobile Tests > resp
onsive design - 
Failed to navigate to Home Page on Pixel 5


 ❯ src/lib/services/email/__tests__/EmailService.test.ts (7 tests | 3 failed) 13ms
   × emailService > queueEmail > should queue a valid email 6ms
     → crypto.randomUUID is not a function
   ✓ emailService > queueEmail > should throw error for invalid email data
   × emailService > processQueue > should process queued email successfully 2ms
     → expected "spy" to be called with arguments: [ { from: 'test@example.com', …(4) } ]

Received: 



Number of calls: 0

   ✓ emailService > processQueue > should handle email sending failure
   × emailService > upsertTemplate > should store a valid template 0ms
     → crypto.randomUUID is not a function
   ✓ emailService > upsertTemplate > should throw error for invalid template
   ✓ emailService > getQueueStats > should return queue statistics

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Pixel 5 Mobile Tests > resp
onsive design - 
Failed to navigate to Dashboard on Pixel 5


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Pixel 5 Mobile Tests > resp
onsive design - 
Failed to navigate to Chat on Pixel 5

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Pixel 5 Mobile Tests > resp
onsive design - 
Failed to navigate to Settings on Pixel 5




 ❯ src/lib/services/notification/__tests__/WebSocketServer.test.ts (7 tests | 7 failed) 15ms
   × WebSocketServer > constructor > should initialize with provided port and notification service 6ms
     → expected "spy" to be called with arguments: [ { port: 8082 } ]

Received: 



Number of calls: 0

   × WebSocketServer > constructor > should set up connection handler 1ms
     → Cannot read properties of undefined (reading 'on')
   × WebSocketServer > constructor > should set up error handler 1ms
     → Cannot read properties of undefined (reading 'on')
   × WebSocketServer > connection handling > should handle client authentication 1ms
     → Cannot read properties of undefined (reading 'on')
   × WebSocketServer > connection handling > should handle client messages 1ms
     → Cannot read properties of undefined (reading 'on')
   × WebSocketServer > connection handling > should handle client disconnection 1ms
     → Cannot read properties of undefined (reading 'on')
   × WebSocketServer > error handling > should log server errors 1ms
     → Cannot read properties of undefined (reading 'on')



 ❯ src/workers/__tests__/notification-worker.test.ts (10 tests | 10 failed) 77ms
   × notification-worker > startWorker > should start processing notifications at the specified interval 41m
s
     → crypto.randomUUID is not a function
   × notification-worker > startWorker > should handle startup errors gracefully 4ms
     → crypto.randomUUID is not a function
   × notification-worker > startWorker > should handle processing errors gracefully 1ms
     → Startup error
   × notification-worker > shutdown handling > should handle SIGTERM signal 4ms
     → crypto.randomUUID is not a function
   × notification-worker > shutdown handling > should handle SIGINT signal 4ms
     → crypto.randomUUID is not a function
   × notification-worker > shutdown handling > should close WebSocket server on shutdown 6ms
     → crypto.randomUUID is not a function
   × notification-worker > environment configuration > should use default WebSocket port if not configured 3
ms
     → crypto.randomUUID is not a function
   × notification-worker > environment configuration > should use configured WebSocket port 5ms
     → crypto.randomUUID is not a function
   × notification-worker > error handling > should continue processing after non-fatal errors 7ms
     → crypto.randomUUID is not a function
   × notification-worker > error handling > should handle WebSocket server errors 1ms
     → Cannot read properties of undefined (reading 'emit')

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Galaxy Tab S4 Mobile Tests 
> responsive design - 
Failed to navigate to Home Page on Galaxy Tab S4

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Galaxy Tab S4 Mobile Tests 
> responsive design - 
Failed to navigate to Dashboard on Galaxy Tab S4


stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Galaxy Tab S4 Mobile Tests 
> responsive design - 
Failed to navigate to Chat on Galaxy Tab S4

stderr | src/tests/browser-compatibility.test.ts > browser Compatibility Tests > Galaxy Tab S4 Mobile Tests 
> responsive design - 
Failed to navigate to Settings on Galaxy Tab S4


 ❯ src/tests/browser-compatibility.test.ts (35 tests | 6 failed | 5 skipped) 21055ms
   × browser Compatibility Tests > Chrome Browser Tests > feature detection 1107ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > Chrome Browser Tests > visual test -  556ms
   ✓ browser Compatibility Tests > Chrome Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Chrome Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Chrome Browser Tests > visual test - 
   × browser Compatibility Tests > Firefox Browser Tests > feature detection 1834ms
     → page.goto: NS_ERROR_CONNECTION_REFUSED
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > Firefox Browser Tests > visual test -  1201ms
   ✓ browser Compatibility Tests > Firefox Browser Tests > visual test -  310ms
   ✓ browser Compatibility Tests > Firefox Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Firefox Browser Tests > visual test -  305ms
   × browser Compatibility Tests > Safari Browser Tests > feature detection 964ms
     → page.goto: Could not connect to the server.
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > Safari Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Safari Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Safari Browser Tests > visual test - 
   ✓ browser Compatibility Tests > Safari Browser Tests > visual test - 
   × browser Compatibility Tests > iPhone 12 Mobile Tests > feature detection 294ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > iPhone 12 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > iPhone 12 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > iPhone 12 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > iPhone 12 Mobile Tests > responsive design - 
   × browser Compatibility Tests > Pixel 5 Mobile Tests > feature detection 98ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > Pixel 5 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Pixel 5 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Pixel 5 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Pixel 5 Mobile Tests > responsive design - 
   ↓ browser Compatibility Tests > iPad Air Mobile Tests > feature detection
   ↓ browser Compatibility Tests > iPad Air Mobile Tests > responsive design - 
   ↓ browser Compatibility Tests > iPad Air Mobile Tests > responsive design - 
   ↓ browser Compatibility Tests > iPad Air Mobile Tests > responsive design - 
   ↓ browser Compatibility Tests > iPad Air Mobile Tests > responsive design - 
   × browser Compatibility Tests > Galaxy Tab S4 Mobile Tests > feature detection 88ms
     → page.goto: net::ERR_CONNECTION_REFUSED at http://localhost:3000/
Call log:
  - navigating to "http://localhost:3000/", waiting until "load"

   ✓ browser Compatibility Tests > Galaxy Tab S4 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Galaxy Tab S4 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Galaxy Tab S4 Mobile Tests > responsive design - 
   ✓ browser Compatibility Tests > Galaxy Tab S4 Mobile Tests > responsive design - 

 ❯ src/lib/security/__tests__/breach-notification.integration.test.ts (0 test)


 ❯ src/components/chat/__tests__/AnalyticsDashboard.test.tsx 11/16

 ❯ src/components/chat/__tests__/AnalyticsDashboard.test.tsx 11/16
 ❯ src/lib/services/redis/__tests__/RedisService.test.ts (0 test)
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx (0 test)

 ❯ src/components/chat/__tests__/AnalyticsDashboard.test.tsx 11/16

 ❯ src/components/chat/__tests__/AnalyticsDashboard.test.tsx 11/16
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/security/__tests__/breach-notification.integration.test.ts [queued]
 ❯ src/lib/security/__tests__/breach-notification.test.ts [queued]
 ❯ src/lib/services/notification/__tests__/NotificationService.test.ts 0/14
 ❯ src/lib/services/redis/__tests__/Analytics.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/CacheInvalidation.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/PatternRecognition.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.perf.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.test.ts [queued]

 Test Files 16 failed | 2 passed (41)
      Tests 110 failed | 93 passed | 17 skipped (234)
   Start at 19:56:45
   Duration 28.08s
```

---

I see several categories of test failures that we need to address:

1. `crypto.randomUUID` issues in multiple services
2. WebSocket server initialization and handling issues
3. FHE (Fully Homomorphic Encryption) service issues
4. Redis mock implementation issues
5. Browser compatibility test failures
6. AI service response parsing issues
7. Performance test failures

Let's address these issues one by one, starting with the most critical ones that are causing cascading failures.

First, let's fix the `crypto.randomUUID` issues since they're affecting multiple services. We need to update our mock implementation:

---

```diff
  
  vi.mock('crypto', () => ({
-   randomUUID: () => 'test-uuid',
+   randomUUID: () => 'test-uuid'
  }))
  
```

---

Now let's fix the WebSocket server issues. We need to properly mock the WebSocket server and its methods:

---

```diff
  
  // Mock dependencies
- vi.mock('ws', () => ({
-   WebSocket: vi.fn().mockImplementation(() => ({
-     send: vi.fn(),
+ vi.mock('ws', () => {
+   const mockServer = {
+     on: vi.fn(),
      close: vi.fn(),
-     on: vi.fn(),
-     emit: vi.fn(),
-   })),
-   WebSocketServer: vi.fn().mockImplementation(() => ({
-     on: vi.fn(),
-     emit: vi.fn(),
      clients: new Set(),
-   })),
- }))
+     emit: vi.fn()
+   };
+ 
+   return {
+     WebSocketServer: vi.fn(() => mockServer),
+     WebSocket: vi.fn()
+   };
+ })
  
  vi.mock('../NotificationService')
  vi.mock('@/lib/utils/logger', () => ({
-   default: {
-     getLogger: vi.fn().mockReturnValue({
+   logger: {
      info: vi.fn(),
      error: vi.fn(),
      warn: vi.fn(),
-       debug: vi.fn(),
-     }),
-   },
+     debug: vi.fn()
+   }
  }))
  
      it('should initialize with provided port and notification service', () => {
        expect(WSServer).toHaveBeenCalledWith({ port: mockPort })
-       expect(logger.getLogger('websocket').info).toHaveBeenCalledWith(
+       expect(logger.logger.info).toHaveBeenCalledWith(
          'WebSocket server started',
          { port: mockPort },
        errorHandler.bind(wsInstance)(mockError)
  
-       expect(logger.getLogger('websocket').error).toHaveBeenCalledWith(
+       expect(logger.logger.error).toHaveBeenCalledWith(
          'WebSocket server error',
          { error: mockError.message },
```

---

Now let's fix the FHE service issues by implementing the mock:

---

```diff
  
  // Mock services
- vi.mock('../../../fhe')
+ vi.mock('@/lib/security/fhe', () => ({
+   FHEService: vi.fn().mockImplementation(() => ({
+     encrypt: vi.fn().mockImplementation(data => ({ encrypted: data })),
+     decrypt: vi.fn().mockImplementation(data => data.encrypted),
+     process: vi.fn().mockImplementation(data => data),
+     initialize: vi.fn().mockResolvedValue(true)
+   }))
+ }))
+ 
  vi.mock('../../../services/redis')
  vi.mock('../../../utils/logger')
```

---

Let's also fix the Redis mock implementation to ensure all required methods are available:

---

```diff
    verifyRedisConnection,
  } from './test-utils'
- 
- // Mock ioredis
- jest.mock('ioredis')
+ import { vi } from 'vitest'
+ 
+ const createMockRedis = () => ({
+   lpush: vi.fn().mockResolvedValue(1),
+   rpoplpush: vi.fn().mockResolvedValue('test-value'),
+   lrem: vi.fn().mockResolvedValue(1),
+   llen: vi.fn().mockResolvedValue(1),
+   lrange: vi.fn().mockResolvedValue(['test-value']),
+   zadd: vi.fn().mockResolvedValue(1),
+   zrangebyscore: vi.fn().mockResolvedValue(['test-value']),
+   zremrangebyscore: vi.fn().mockResolvedValue(1),
+   keys: vi.fn().mockResolvedValue(['test-key']),
+   hget: vi.fn().mockResolvedValue('test-value'),
+   hgetall: vi.fn().mockResolvedValue({ key: 'value' }),
+   hset: vi.fn().mockResolvedValue(1),
+   hdel: vi.fn().mockResolvedValue(1),
+   del: vi.fn().mockResolvedValue(1),
+   get: vi.fn().mockResolvedValue('test-value'),
+   set: vi.fn().mockResolvedValue('OK'),
+   quit: vi.fn().mockResolvedValue('OK'),
+   on: vi.fn(),
+   connect: vi.fn().mockResolvedValue(undefined)
+ })
+ 
+ vi.mock('ioredis', () => ({
+   default: vi.fn().mockImplementation(() => createMockRedis())
+ }))
  
  describe('redisService', () => {
```

---

Now let's fix the browser compatibility test failures. These failures are occurring because the server isn't running during the tests. We need to start a test server before running the browser tests:

---



---

Let me try to reapply the edit:

---

**Apply failed**

---

Let me check the current content of the file first:

---

Read file: src/tests/browser-compatibility.test.ts

---

I see that the server setup code is already there. Let's check if the app import is working correctly:

---

Could not find file 'src/app.ts'. Did you mean one of:
- src/app/(dashboard)/page.tsx
- src/app/api/analytics/route.ts
- src/app/api/ai/therapy-chat/route.ts

---

I see the issue. The app is using Next.js, so we need to modify the browser compatibility test to use the Next.js development server instead:

---

```diff
  import { FEATURES } from '../lib/browser/feature-detection'
  import { beforeAll, afterAll } from 'vitest';
- import { createServer } from 'http';
- import { app } from '../app';
+ import { spawn } from 'child_process';
  
  let server;
  
  beforeAll(async () => {
-   server = createServer(app);
+   // Start Next.js dev server
+   server = spawn('pnpm', ['dev'], {
+     stdio: 'pipe',
+     env: { ...process.env, PORT: '3000' }
+   });
+ 
+   // Wait for server to be ready
    await new Promise((resolve) => {
-     server.listen(3000, () => {
-       console.log('Test server started on port 3000');
+     server.stdout.on('data', (data) => {
+       if (data.toString().includes('ready')) {
+         console.log('Next.js dev server started on port 3000');
          resolve();
+       }
      });
    });
  });
  
  afterAll(async () => {
-   await new Promise((resolve) => {
-     server.close(() => {
-       console.log('Test server closed');
-       resolve();
-     });
-   });
+   if (server) {
+     server.kill();
+     console.log('Next.js dev server closed');
+   }
  });
  
```

---

Now let's fix the AI service response parsing issues. We need to update the mock responses to match the expected format:

---

```diff
    dispose: vi.fn(),
  } as unknown as AIService
+ 
+ vi.mock('@/lib/ai/services/openai', () => ({
+   default: {
+     chat: vi.fn().mockImplementation(async (messages, options) => {
+       const text = messages[messages.length - 1].content;
+ 
+       if (text.includes('high-risk')) {
+         return {
+           content: JSON.stringify({
+             isCrisis: true,
+             confidence: 0.95,
+             category: 'self-harm',
+             severity: 'high',
+             recommendedAction: 'Immediate intervention required'
+           })
+         };
+       }
+ 
+       if (text.includes('medium-risk')) {
+         return {
+           content: JSON.stringify({
+             isCrisis: true,
+             confidence: 0.75,
+             category: 'psychological_distress',
+             severity: 'medium',
+             recommendedAction: 'Schedule follow-up within 24 hours'
+           })
+         };
+       }
+ 
+       if (text.includes('low-risk')) {
+         return {
+           content: JSON.stringify({
+             isCrisis: true,
+             confidence: 0.6,
+             category: 'anxiety',
+             severity: 'low',
+             recommendedAction: 'Monitor and provide coping strategies'
+           })
+         };
+       }
+ 
+       if (text === 'Not a valid JSON') {
+         return { content: 'Not a valid JSON' };
+       }
+ 
+       if (text.includes('error')) {
+         throw new Error('AI service error');
+       }
+ 
+       return {
+         content: JSON.stringify({
+           isCrisis: false,
+           confidence: 0.9,
+           category: 'none',
+           severity: 'none',
+           recommendedAction: 'Continue regular support'
+         })
+       };
+     })
+   }
+ }));
  
  describe('crisisDetectionService', () => {
```

---

Let's run the tests again to see if our fixes have improved the situation:

---

```bash
pnpm test
```

```
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]

 ❯ src/components/notification/__tests__/NotificationCenter.test.tsx [queued]
 ❯ src/components/notification/__tests__/NotificationPreferences.test.tsx [queued]
 ❯ src/e2e/breach-notification.spec.ts [queued]
 ❯ src/lib/analytics/__tests__/breach-analytics.test.ts [queued]
 ❯ src/lib/ehr/__tests__/allscripts.test.ts [queued]
 ❯ src/lib/ehr/__tests__/athenahealth.test.ts [queued]
 ❯ src/lib/ehr/__tests__/cerner.test.ts [queued]
 ❯ src/lib/ehr/__tests__/ehr.test.ts [queued]
 ❯ src/lib/providers/__tests__/providers.test.tsx [queued]
 ❯ src/lib/security/__tests__/audit.logging.test.ts [queued]
 ❯ src/lib/security/__tests__/breach-notification.integration.test.ts [queued]
 ❯ src/lib/security/__tests__/breach-notification.test.ts [queued]
 ❯ src/lib/security/__tests__/token.encryption.test.ts [queued]
 ❯ src/lib/services/notification/__tests__/NotificationService.test.ts 0/14
 ❯ src/lib/services/redis/__tests__/Analytics.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/CacheInvalidation.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/PatternRecognition.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.integration.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.perf.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/RedisService.test.ts [queued]
 ❯ src/lib/services/redis/__tests__/WebSocket.integration.test.ts [queued]
 ❯ src/tests/browser-compatibility.test.ts 30/35

 Test Files 17 failed | 2 passed (41)
      Tests 135 failed | 72 passed | 12 skipped (238)
   Start at 19:59:12
   Duration 111.16s
```

---

Let's try running the tests again:

---

```bash
pnpm test
```

---



---



---

