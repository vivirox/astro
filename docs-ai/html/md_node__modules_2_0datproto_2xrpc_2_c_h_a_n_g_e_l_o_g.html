<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gradiant Ascent: @atproto/xrpc</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Gradiant Ascent
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_node__modules_2_0datproto_2xrpc_2_c_h_a_n_g_e_l_o_g.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">@atproto/xrpc</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md2295"></a></p>
<h1><a class="anchor" id="autotoc_md2296"></a>
0.6.11</h1>
<h2><a class="anchor" id="autotoc_md2297"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.4.9</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2298"></a>
0.6.10</h1>
<h2><a class="anchor" id="autotoc_md2299"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.4.8</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2300"></a>
0.6.9</h1>
<h2><a class="anchor" id="autotoc_md2301"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/c53d943c8be5b8886254e020970a68c0f745b14c"><code>c53d943c8</code></a>, <a href="https://github.com/bluesky-social/atproto/commit/c53d943c8be5b8886254e020970a68c0f745b14c"><code>c53d943c8</code></a>]:<ul>
<li>@atproto/lexicon@0.4.7</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2302"></a>
0.6.8</h1>
<h2><a class="anchor" id="autotoc_md2303"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/3220">#3220</a> <a href="https://github.com/bluesky-social/atproto/commit/61dc0d60e19b88c6427a54c6d95a391b5f4da7bd"><code>61dc0d60e</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Apply new linting rules regarding import order</li>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/61dc0d60e19b88c6427a54c6d95a391b5f4da7bd"><code>61dc0d60e</code></a>]:<ul>
<li>@atproto/lexicon@0.4.6</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2304"></a>
0.6.7</h1>
<h2><a class="anchor" id="autotoc_md2305"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/3456">#3456</a> <a href="https://github.com/bluesky-social/atproto/commit/fb64d50ee220316b9f1183e5c3259629489734c9"><code>fb64d50ee</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Explicitly allow "undefined" values in <code>headers</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md2306"></a>
0.6.6</h1>
<h2><a class="anchor" id="autotoc_md2307"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.4.5</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2308"></a>
0.6.5</h1>
<h2><a class="anchor" id="autotoc_md2309"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/9fd65ba0fa4caca59fd0e6156145e4c2618e3a95"><code>9fd65ba0f</code></a>]:<ul>
<li>@atproto/lexicon@0.4.4</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2310"></a>
0.6.4</h1>
<h2><a class="anchor" id="autotoc_md2311"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/bac9be2d3ec904d1f984a871f43cf89aca17289d"><code>bac9be2d3</code></a>]:<ul>
<li>@atproto/lexicon@0.4.3</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2312"></a>
0.6.3</h1>
<h2><a class="anchor" id="autotoc_md2313"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2770">#2770</a> <a href="https://github.com/bluesky-social/atproto/commit/a07b21151f1850340c4b7797ebb11521b1a6cdf3"><code>a07b21151</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Add NotAcceptable response type</li>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/87a1f24262e0e644b6cf31cc7a0446d9127ffa94"><code>87a1f2426</code></a>]:<ul>
<li>@atproto/lexicon@0.4.2</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2314"></a>
0.6.2</h1>
<h2><a class="anchor" id="autotoc_md2315"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2464">#2464</a> <a href="https://github.com/bluesky-social/atproto/commit/98711a147a8674337f605c6368f39fc10c2fae93"><code>98711a147</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Add UnsupportedMediaType response type</li>
</ul>
<h1><a class="anchor" id="autotoc_md2316"></a>
0.6.1</h1>
<h2><a class="anchor" id="autotoc_md2317"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2714">#2714</a> <a href="https://github.com/bluesky-social/atproto/commit/d9ffa3c460924010d7002b616cb7a0c66111cc6c"><code>d9ffa3c46</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Improve handling of fetchHandler errors when turning them into <code>XrpcError</code>.</li>
<li><a href="https://github.com/bluesky-social/atproto/pull/2714">#2714</a> <a href="https://github.com/bluesky-social/atproto/commit/d9ffa3c460924010d7002b616cb7a0c66111cc6c"><code>d9ffa3c46</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Add ability to instantiate XrpcClient from FetchHandlerObject type</li>
<li><a href="https://github.com/bluesky-social/atproto/pull/2714">#2714</a> <a href="https://github.com/bluesky-social/atproto/commit/d9ffa3c460924010d7002b616cb7a0c66111cc6c"><code>d9ffa3c46</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Add global headers to <code>XrpcClient</code> instances</li>
</ul>
<h1><a class="anchor" id="autotoc_md2318"></a>
0.6.0</h1>
<h2><a class="anchor" id="autotoc_md2319"></a>
Minor Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2483">#2483</a> <a href="https://github.com/bluesky-social/atproto/commit/b934b396b13ba32bf2bf7e75ecdf6871e5f310dd"><code>b934b396b</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>!</li>
</ul>
<h3><a class="anchor" id="autotoc_md2320"></a>
Motivation</h3>
<p>The motivation for these changes is the need to make the <code>@atproto/api</code> package compatible with OAuth session management. We don't have OAuth client support "launched" and documented quite yet, so you can keep using the current app password authentication system. When we do "launch" OAuth support and begin encouraging its usage in the near future (see the <a href="https://github.com/bluesky-social/atproto/discussions/2656">OAuth Roadmap</a>), these changes will make it easier to migrate.</p>
<p>In addition, the redesigned session management system fixes a bug that could cause the session data to become invalid when Agent clones are created (e.g. using <code>agent.withProxy()</code>).</p>
<h3><a class="anchor" id="autotoc_md2321"></a>
New Features</h3>
<p>We've restructured the <code>XrpcClient</code> HTTP fetch handler to be specified during the instantiation of the XRPC client, through the constructor, instead of using a default implementation (which was statically defined).</p>
<p>With this refactor, the XRPC client is now more modular and reusable. Session management, retries, cryptographic signing, and other request-specific logic can be implemented in the fetch handler itself rather than by the calling code.</p>
<p>A new abstract class named <code>Agent</code>, has been added to <code>@atproto/api</code>. This class will be the base class for all Bluesky agents classes in the <code>@atproto</code> ecosystem. It is meant to be extended by implementations that provide session management and fetch handling.</p>
<p>As you adapt your code to these changes, make sure to use the <code>Agent</code> type wherever you expect to receive an agent, and use the <code>AtpAgent</code> type (class) only to instantiate your client. The reason for this is to be forward compatible with the OAuth agent implementation that will also extend <code>Agent</code>, and not <code>AtpAgent</code>.</p>
<div class="fragment"><div class="line">import { Agent, AtpAgent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">async function setupAgent(</div>
<div class="line">  service: string,</div>
<div class="line">  username: string,</div>
<div class="line">  password: string,</div>
<div class="line">): Promise&lt;Agent&gt; {</div>
<div class="line">  const agent = new AtpAgent({</div>
<div class="line">    service,</div>
<div class="line">    persistSession: (evt, session) =&gt; {</div>
<div class="line">      // handle session update</div>
<div class="line">    },</div>
<div class="line">  });</div>
<div class="line"> </div>
<div class="line">  await agent.login(username, password);</div>
<div class="line"> </div>
<div class="line">  return agent;</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line">import { Agent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">async function doStuffWithAgent(agent: Agent, arg: string) {</div>
<div class="line">  return agent.resolveHandle(arg);</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line">import { Agent, AtpAgent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">class MyClass {</div>
<div class="line">  agent: Agent;</div>
<div class="line"> </div>
<div class="line">  constructor() {</div>
<div class="line">    this.agent = new AtpAgent();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md2322"></a>
Breaking changes</h3>
<p>Most of the changes introduced in this version are backward-compatible. However, there are a couple of breaking changes you should be aware of:</p>
<ul>
<li>Customizing <code>fetch</code>: The ability to customize the <code>fetch: FetchHandler</code> property of <code>@atproto/xrpc</code>'s <code>Client</code> and <code>@atproto/api</code>'s <code>AtpAgent</code> classes has been removed. Previously, the <code>fetch</code> property could be set to a function that would be used as the fetch handler for that instance, and was initialized to a default fetch handler. That property is still accessible in a read-only fashion through the <code>fetchHandler</code> property and can only be set during the instance creation. Attempting to set/get the <code>fetch</code> property will now result in an error.</li>
<li>The <code>fetch()</code> method, as well as WhatWG compliant <code>Request</code> and <code>Headers</code> constructors, must be globally available in your environment. Use a polyfill if necessary.</li>
<li>The <code>AtpBaseClient</code> has been removed. The <code>AtpServiceClient</code> has been renamed <code>AtpBaseClient</code>. Any code using either of these classes will need to be updated.</li>
<li>Instead of <em>wrapping</em> an <code>XrpcClient</code> in its <code>xrpc</code> property, the <code>AtpBaseClient</code> (formerly <code>AtpServiceClient</code>) class - created through <code>lex-cli</code> - now <em>extends</em> the <code>XrpcClient</code> class. This means that a client instance now passes the <code>instanceof XrpcClient</code> check. The <code>xrpc</code> property now returns the instance itself and has been deprecated.</li>
<li><code>setSessionPersistHandler</code> is no longer available on the <code>AtpAgent</code> or <code>BskyAgent</code> classes. The session handler can only be set though the <code>persistSession</code> options of the <code>AtpAgent</code> constructor.</li>
<li>The new class hierarchy is as follows:<ul>
<li><code>BskyAgent</code> extends <code>AtpAgent</code>: but add no functionality (hence its deprecation).</li>
<li><code>AtpAgent</code> extends <code>Agent</code>: adds password based session management.</li>
<li><code>Agent</code> extends <code>AtpBaseClient</code>: this abstract class that adds syntactic sugar methods <code>app.bsky</code> lexicons. It also adds abstract session management methods and adds atproto specific utilities (<code>labelers</code> &amp; <code>proxy</code> headers, cloning capability)</li>
<li><code>AtpBaseClient</code> extends <code>XrpcClient</code>: automatically code that adds fully typed lexicon defined namespaces (<code>instance.app.bsky.feed.getPosts()</code>) to the <code>XrpcClient</code>.</li>
<li><code>XrpcClient</code> is the base class.</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md2323"></a>
Non-breaking changes</h3>
<ul>
<li>The <code>com.*</code> and <code>app.*</code> namespaces have been made directly available to every <code>Agent</code> instances.</li>
</ul>
<h3><a class="anchor" id="autotoc_md2324"></a>
Deprecations</h3>
<ul>
<li>The default export of the <code>@atproto/xrpc</code> package has been deprecated. Use named exports instead.</li>
<li>The <code>Client</code> and <code>ServiceClient</code> classes are now deprecated. They are replaced by a single <code>XrpcClient</code> class.</li>
<li>The default export of the <code>@atproto/api</code> package has been deprecated. Use named exports instead.</li>
<li>The <code>BskyAgent</code> has been deprecated. Use the <code>AtpAgent</code> class instead.</li>
<li>The <code>xrpc</code> property of the <code>AtpClient</code> instances has been deprecated. The instance itself should be used as the XRPC client.</li>
<li>The <code>api</code> property of the <code>AtpAgent</code> and <code>BskyAgent</code> instances has been deprecated. Use the instance itself instead.</li>
</ul>
<h3><a class="anchor" id="autotoc_md2325"></a>
Migration</h3>
<h4><a class="anchor" id="autotoc_md2326"></a>
The <code>@atproto/api</code> package</h4>
<p>If you were relying on the <code>AtpBaseClient</code> solely to perform validation, use this:</p>
<table class="doxtable">
<tr>
<td><center>Before</center> </td><td><center>After</center>  </td></tr>
<tr>
<td><p class="starttd"></p>
<div class="fragment"><div class="line">import { AtpBaseClient, ComAtprotoSyncSubscribeRepos } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">const baseClient = new AtpBaseClient();</div>
<div class="line"> </div>
<div class="line">baseClient.xrpc.lex.assertValidXrpcMessage(&quot;io.example.doStuff&quot;, {</div>
<div class="line">  // ...</div>
<div class="line">});</div>
</div><!-- fragment --><p class="endtd"></p>
</td><td><p class="starttd"></p>
<div class="fragment"><div class="line">import { lexicons } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">lexicons.assertValidXrpcMessage(&quot;io.example.doStuff&quot;, {</div>
<div class="line">  // ...</div>
<div class="line">});</div>
</div><!-- fragment --><p class="endtd"></p>
</td></tr>
</table>
<p>If you are extending the <code>BskyAgent</code> to perform custom <code>session</code> manipulation, define your own <code>Agent</code> subclass instead:</p>
<table class="doxtable">
<tr>
<td><center>Before</center> </td><td><center>After</center>  </td></tr>
<tr>
<td><p class="starttd"></p>
<div class="fragment"><div class="line">import { BskyAgent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">class MyAgent extends BskyAgent {</div>
<div class="line">  private accessToken?: string;</div>
<div class="line"> </div>
<div class="line">  async createOrRefreshSession(identifier: string, password: string) {</div>
<div class="line">    // custom logic here</div>
<div class="line"> </div>
<div class="line">    this.accessToken = &quot;my-access-jwt&quot;;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  async doStuff() {</div>
<div class="line">    return this.call(&quot;io.example.doStuff&quot;, {</div>
<div class="line">      headers: {</div>
<div class="line">        Authorization: this.accessToken &amp;&amp; `Bearer ${this.accessToken}`,</div>
<div class="line">      },</div>
<div class="line">    });</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endtd"></p>
</td><td><p class="starttd"></p>
<div class="fragment"><div class="line">import { Agent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">class MyAgent extends Agent {</div>
<div class="line">  private accessToken?: string;</div>
<div class="line">  public did?: string;</div>
<div class="line"> </div>
<div class="line">  constructor(private readonly service: string | URL) {</div>
<div class="line">    super({</div>
<div class="line">      service,</div>
<div class="line">      headers: {</div>
<div class="line">        Authorization: () =&gt;</div>
<div class="line">          this.accessToken ? `Bearer ${this.accessToken}` : null,</div>
<div class="line">      },</div>
<div class="line">    });</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  clone(): MyAgent {</div>
<div class="line">    const agent = new MyAgent(this.service);</div>
<div class="line">    agent.accessToken = this.accessToken;</div>
<div class="line">    agent.did = this.did;</div>
<div class="line">    return this.copyInto(agent);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  async createOrRefreshSession(identifier: string, password: string) {</div>
<div class="line">    // custom logic here</div>
<div class="line"> </div>
<div class="line">    this.did = &quot;did:example:123&quot;;</div>
<div class="line">    this.accessToken = &quot;my-access-jwt&quot;;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endtd"></p>
</td></tr>
</table>
<p>If you are monkey patching the <code>xrpc</code> service client to perform client-side rate limiting, you can now do this in the <code>FetchHandler</code> function:</p>
<table class="doxtable">
<tr>
<td><center>Before</center> </td><td><center>After</center>  </td></tr>
<tr>
<td><p class="starttd"></p>
<div class="fragment"><div class="line">import { BskyAgent } from &quot;@atproto/api&quot;;</div>
<div class="line">import { RateLimitThreshold } from &quot;rate-limit-threshold&quot;;</div>
<div class="line"> </div>
<div class="line">const agent = new BskyAgent();</div>
<div class="line">const limiter = new RateLimitThreshold(3000, 300_000);</div>
<div class="line"> </div>
<div class="line">const origCall = agent.api.xrpc.call;</div>
<div class="line">agent.api.xrpc.call = async function (...args) {</div>
<div class="line">  await limiter.wait();</div>
<div class="line">  return origCall.call(this, ...args);</div>
<div class="line">};</div>
</div><!-- fragment --><p class="endtd"></p>
</td><td><p class="starttd"></p>
<div class="fragment"><div class="line">import { AtpAgent } from &quot;@atproto/api&quot;;</div>
<div class="line">import { RateLimitThreshold } from &quot;rate-limit-threshold&quot;;</div>
<div class="line"> </div>
<div class="line">class LimitedAtpAgent extends AtpAgent {</div>
<div class="line">  constructor(options: AtpAgentOptions) {</div>
<div class="line">    const fetch: typeof globalThis.fetch = options.fetch ?? globalThis.fetch;</div>
<div class="line">    const limiter = new RateLimitThreshold(3000, 300_000);</div>
<div class="line"> </div>
<div class="line">    super({</div>
<div class="line">      ...options,</div>
<div class="line">      fetch: async (...args) =&gt; {</div>
<div class="line">        await limiter.wait();</div>
<div class="line">        return fetch(...args);</div>
<div class="line">      },</div>
<div class="line">    });</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endtd"></p>
</td></tr>
</table>
<p>If you configure a static <code>fetch</code> handler on the <code>BskyAgent</code> class - for example to modify the headers of every request - you can now do this by providing your own <code>fetch</code> function:</p>
<table class="doxtable">
<tr>
<td><center>Before</center> </td><td><center>After</center>  </td></tr>
<tr>
<td><p class="starttd"></p>
<div class="fragment"><div class="line">import { BskyAgent, defaultFetchHandler } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">BskyAgent.configure({</div>
<div class="line">  fetch: async (httpUri, httpMethod, httpHeaders, httpReqBody) =&gt; {</div>
<div class="line">    const ua = httpHeaders[&quot;User-Agent&quot;];</div>
<div class="line"> </div>
<div class="line">    httpHeaders[&quot;User-Agent&quot;] = ua ? `${ua} ${userAgent}` : userAgent;</div>
<div class="line"> </div>
<div class="line">    return defaultFetchHandler(httpUri, httpMethod, httpHeaders, httpReqBody);</div>
<div class="line">  },</div>
<div class="line">});</div>
</div><!-- fragment --><p class="endtd"></p>
</td><td><p class="starttd"></p>
<div class="fragment"><div class="line">import { AtpAgent } from &quot;@atproto/api&quot;;</div>
<div class="line"> </div>
<div class="line">class MyAtpAgent extends AtpAgent {</div>
<div class="line">  constructor(options: AtpAgentOptions) {</div>
<div class="line">    const fetch = options.fetch ?? globalThis.fetch;</div>
<div class="line"> </div>
<div class="line">    super({</div>
<div class="line">      ...options,</div>
<div class="line">      fetch: async (url, init) =&gt; {</div>
<div class="line">        const headers = new Headers(init.headers);</div>
<div class="line"> </div>
<div class="line">        const ua = headersList.get(&quot;User-Agent&quot;);</div>
<div class="line">        headersList.set(&quot;User-Agent&quot;, ua ? `${ua} ${userAgent}` : userAgent);</div>
<div class="line"> </div>
<div class="line">        return fetch(url, { ...init, headers });</div>
<div class="line">      },</div>
<div class="line">    });</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p class="endtd"></p>
</td></tr>
</table>
<h4><a class="anchor" id="autotoc_md2327"></a>
The <code>@atproto/xrpc</code> package</h4>
<p>The <code>Client</code> and <code>ServiceClient</code> classes are now <b>deprecated</b>. If you need a lexicon based client, you should update the code to use the <code>XrpcClient</code> class instead.</p>
<p>The deprecated <code>ServiceClient</code> class now extends the new <code>XrpcClient</code> class. Because of this, the <code>fetch</code> <code>FetchHandler</code> can no longer be configured on the <code>Client</code> instances (including the default export of the package). If you are not relying on the <code>fetch</code> <code>FetchHandler</code>, the new changes should have no impact on your code. Beware that the deprecated classes will eventually be removed in a future version.</p>
<p>Since its use has completely changed, the <code>FetchHandler</code> type has also completely changed. The new <code>FetchHandler</code> type is now a function that receives a <code>url</code> pathname and a <code>RequestInit</code> object and returns a <code>Promise&lt;Response&gt;</code>. This function is responsible for making the actual request to the server.</p>
<div class="fragment"><div class="line">export type FetchHandler = (</div>
<div class="line">  this: void,</div>
<div class="line">  /**</div>
<div class="line">   * The URL (pathname + query parameters) to make the request to, without the</div>
<div class="line">   * origin. The origin (protocol, hostname, and port) must be added by this</div>
<div class="line">   * {@link FetchHandler}, typically based on authentication or other factors.</div>
<div class="line">   */</div>
<div class="line">  url: string,</div>
<div class="line">  init: RequestInit,</div>
<div class="line">) =&gt; Promise&lt;Response&gt;;</div>
</div><!-- fragment --><p>A noticeable change that has been introduced is that the <code>uri</code> field of the <code>ServiceClient</code> class has <em>not</em> been ported to the new <code>XrpcClient</code> class. It is now the responsibility of the <code>FetchHandler</code> to determine the full URL to make the request to. The same goes for the <code>headers</code>, which should now be set through the <code>FetchHandler</code> function.</p>
<p>If you <em>do</em> rely on the legacy <code>Client.fetch</code> property to perform custom logic upon request, you will need to migrate your code to use the new <code>XrpcClient</code> class. The <code>XrpcClient</code> class has a similar API to the old <code>ServiceClient</code> class, but with a few differences:</p>
<ul>
<li>The <code>Client</code> + <code>ServiceClient</code> duality was removed in favor of a single <code>XrpcClient</code> class. This means that:<ul>
<li>There no longer exists a centralized lexicon registry. If you need a global lexicon registry, you can maintain one yourself using a <code>new Lexicons</code> (from <code>@atproto/lexicon</code>).</li>
<li>The <code>FetchHandler</code> is no longer a statically defined property of the <code>Client</code> class. Instead, it is passed as an argument to the <code>XrpcClient</code> constructor.</li>
</ul>
</li>
<li>The <code>XrpcClient</code> constructor now requires a <code>FetchHandler</code> function as the first argument, and an optional <code>Lexicon</code> instance as the second argument.</li>
<li>The <code>setHeader</code> and <code>unsetHeader</code> methods were not ported to the new <code>XrpcClient</code> class. If you need to set or unset headers, you should do so in the <code>FetchHandler</code> function provided in the constructor arg.</li>
</ul>
<table class="doxtable">
<tr>
<td><center>Before</center> </td><td><center>After</center>  </td></tr>
<tr>
<td><p class="starttd"></p>
<div class="fragment"><div class="line">import client, { defaultFetchHandler } from &quot;@atproto/xrpc&quot;;</div>
<div class="line"> </div>
<div class="line">client.fetch = function (</div>
<div class="line">  httpUri: string,</div>
<div class="line">  httpMethod: string,</div>
<div class="line">  httpHeaders: Headers,</div>
<div class="line">  httpReqBody: unknown,</div>
<div class="line">) {</div>
<div class="line">  // Custom logic here</div>
<div class="line">  return defaultFetchHandler(httpUri, httpMethod, httpHeaders, httpReqBody);</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">client.addLexicon({</div>
<div class="line">  lexicon: 1,</div>
<div class="line">  id: &quot;io.example.doStuff&quot;,</div>
<div class="line">  defs: {},</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">const instance = client.service(&quot;http://my-service.com&quot;);</div>
<div class="line"> </div>
<div class="line">instance.setHeader(&quot;my-header&quot;, &quot;my-value&quot;);</div>
<div class="line"> </div>
<div class="line">await instance.call(&quot;io.example.doStuff&quot;);</div>
</div><!-- fragment --><p class="endtd"></p>
</td><td><p class="starttd"></p>
<div class="fragment"><div class="line">import { XrpcClient } from &quot;@atproto/xrpc&quot;;</div>
<div class="line"> </div>
<div class="line">const instance = new XrpcClient(</div>
<div class="line">  async (url, init) =&gt; {</div>
<div class="line">    const headers = new Headers(init.headers);</div>
<div class="line"> </div>
<div class="line">    headers.set(&quot;my-header&quot;, &quot;my-value&quot;);</div>
<div class="line"> </div>
<div class="line">    // Custom logic here</div>
<div class="line"> </div>
<div class="line">    const fullUrl = new URL(url, &quot;http://my-service.com&quot;);</div>
<div class="line"> </div>
<div class="line">    return fetch(fullUrl, { ...init, headers });</div>
<div class="line">  },</div>
<div class="line">  [</div>
<div class="line">    {</div>
<div class="line">      lexicon: 1,</div>
<div class="line">      id: &quot;io.example.doStuff&quot;,</div>
<div class="line">      defs: {},</div>
<div class="line">    },</div>
<div class="line">  ],</div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line">await instance.call(&quot;io.example.doStuff&quot;);</div>
</div><!-- fragment --><p class="endtd"></p>
</td></tr>
</table>
<p>If your fetch handler does not require any "custom logic", and all you need is an <code>XrpcClient</code> that makes its HTTP requests towards a static service URL, the previous example can be simplified to:</p>
<div class="fragment"><div class="line">import { XrpcClient } from &quot;@atproto/xrpc&quot;;</div>
<div class="line"> </div>
<div class="line">const instance = new XrpcClient(&quot;http://my-service.com&quot;, [</div>
<div class="line">  {</div>
<div class="line">    lexicon: 1,</div>
<div class="line">    id: &quot;io.example.doStuff&quot;,</div>
<div class="line">    defs: {},</div>
<div class="line">  },</div>
<div class="line">]);</div>
</div><!-- fragment --><p>If you need to add static headers to all requests, you can instead instantiate the <code>XrpcClient</code> as follows:</p>
<div class="fragment"><div class="line">import { XrpcClient } from &quot;@atproto/xrpc&quot;;</div>
<div class="line"> </div>
<div class="line">const instance = new XrpcClient(</div>
<div class="line">  {</div>
<div class="line">    service: &quot;http://my-service.com&quot;,</div>
<div class="line">    headers: {</div>
<div class="line">      &quot;my-header&quot;: &quot;my-value&quot;,</div>
<div class="line">    },</div>
<div class="line">  },</div>
<div class="line">  [</div>
<div class="line">    {</div>
<div class="line">      lexicon: 1,</div>
<div class="line">      id: &quot;io.example.doStuff&quot;,</div>
<div class="line">      defs: {},</div>
<div class="line">    },</div>
<div class="line">  ],</div>
<div class="line">);</div>
</div><!-- fragment --><p>If you need the headers or service url to be dynamic, you can define them using functions:</p>
<div class="fragment"><div class="line">import { XrpcClient } from &quot;@atproto/xrpc&quot;;</div>
<div class="line"> </div>
<div class="line">const instance = new XrpcClient(</div>
<div class="line">  {</div>
<div class="line">    service: () =&gt; &quot;http://my-service.com&quot;,</div>
<div class="line">    headers: {</div>
<div class="line">      &quot;my-header&quot;: () =&gt; &quot;my-value&quot;,</div>
<div class="line">      &quot;my-ignored-header&quot;: () =&gt; null, // ignored</div>
<div class="line">    },</div>
<div class="line">  },</div>
<div class="line">  [</div>
<div class="line">    {</div>
<div class="line">      lexicon: 1,</div>
<div class="line">      id: &quot;io.example.doStuff&quot;,</div>
<div class="line">      defs: {},</div>
<div class="line">    },</div>
<div class="line">  ],</div>
<div class="line">);</div>
</div><!-- fragment --><ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2483">#2483</a> <a href="https://github.com/bluesky-social/atproto/commit/b934b396b13ba32bf2bf7e75ecdf6871e5f310dd"><code>b934b396b</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Add the ability to use <code>fetch()</code> compatible <code>BodyInit</code> body when making XRPC calls.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2328"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/b934b396b13ba32bf2bf7e75ecdf6871e5f310dd"><code>b934b396b</code></a>, <a href="https://github.com/bluesky-social/atproto/commit/2bdf75d7a63924c10e7a311f16cb447d595b933e"><code>2bdf75d7a</code></a>]:<ul>
<li>@atproto/lexicon@0.4.1</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2329"></a>
0.5.0</h1>
<h2><a class="anchor" id="autotoc_md2330"></a>
Minor Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/2169">#2169</a> <a href="https://github.com/bluesky-social/atproto/commit/f689bd51a2f4e02d4eca40eb2568a1fcb95494e9"><code>f689bd51a</code></a> Thanks <a href="https://github.com/matthieusieben">@matthieusieben</a>! - Build system rework, stop bundling dependencies.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2331"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/f689bd51a2f4e02d4eca40eb2568a1fcb95494e9"><code>f689bd51a</code></a>]:<ul>
<li>@atproto/lexicon@0.4.0</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2332"></a>
0.4.3</h1>
<h2><a class="anchor" id="autotoc_md2333"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.3.3</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2334"></a>
0.4.2</h1>
<h2><a class="anchor" id="autotoc_md2335"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.3.2</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2336"></a>
0.4.1</h1>
<h2><a class="anchor" id="autotoc_md2337"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.3.1</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2338"></a>
0.4.0</h1>
<h2><a class="anchor" id="autotoc_md2339"></a>
Minor Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/1801">#1801</a> <a href="https://github.com/bluesky-social/atproto/commit/ce49743d7f8800d33116b88001d7b512553c2c89"><code>ce49743d</code></a> Thanks <a href="https://github.com/gaearon">@gaearon</a>! - Methods that accepts lexicons now take <code>LexiconDoc</code> type instead of <code>unknown</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md2340"></a>
Patch Changes</h2>
<ul>
<li><a href="https://github.com/bluesky-social/atproto/pull/1788">#1788</a> <a href="https://github.com/bluesky-social/atproto/commit/84e2d4d2b6694f344d80c18672c78b650189d423"><code>84e2d4d2</code></a> Thanks <a href="https://github.com/bnewbold">@bnewbold</a>! - update license to "MIT or Apache2"</li>
<li>Updated dependencies [<a href="https://github.com/bluesky-social/atproto/commit/ce49743d7f8800d33116b88001d7b512553c2c89"><code>ce49743d</code></a>, <a href="https://github.com/bluesky-social/atproto/commit/84e2d4d2b6694f344d80c18672c78b650189d423"><code>84e2d4d2</code></a>]:<ul>
<li>@atproto/lexicon@0.3.0</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2341"></a>
0.3.3</h1>
<h2><a class="anchor" id="autotoc_md2342"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.2.3</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2343"></a>
0.3.2</h1>
<h2><a class="anchor" id="autotoc_md2344"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.2.2</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2345"></a>
0.3.1</h1>
<h2><a class="anchor" id="autotoc_md2346"></a>
Patch Changes</h2>
<ul>
<li>Updated dependencies []:<ul>
<li>@atproto/lexicon@0.2.1 </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
