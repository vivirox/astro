<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gradiant Ascent: OAuth Client Quickstart</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Gradiant Ascent
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_node__modules_2_0datproto_2api_2_o_a_u_t_h.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">OAuth Client Quickstart</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1956"></a></p>
<p>This document describes how to implement OAuth based authentication in a browser-based Single Page App (SPA), to communicate with <a href="https://atproto.com">atproto</a> API services.</p>
<h1><a class="anchor" id="autotoc_md1957"></a>
Prerequisites</h1>
<ul>
<li>You need a web server - or at the very least a static file server - to host your SPA.</li>
</ul>
<dl class="section remark"><dt>Remarks</dt><dd><br  />
 During development, you can use a local server to host your client metadata. You will need to use a tunneling service like <a href="https://ngrok.com/">ngrok</a> to make your local server accessible from the internet.</dd>
<dd>
<br  />
 You can use a service like <a href="https://pages.github.com/">GitHub Pages</a> to host your client metadata and SPA for free.</dd></dl>
<ul>
<li>You must be able to build and deploy a SPA to your server.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1958"></a>
Step 1: Create your client metadata</h1>
<p>Based on your hosting server endpoint, you will first need to choose a <code>client_id</code>. That <code>client_id</code> will be used to identify your client to Authorization Servers. A <code>client_id</code> must be a URL pointing to a JSON file which contains your client metadata. The client metadata <b>must</b> contain a <code>client_id</code> that is the URL used to access the metadata.</p>
<p>Here is an example client metadata.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;client_id&quot;: &quot;https://example.com/client-metadata.json&quot;,</div>
<div class="line">  &quot;client_name&quot;: &quot;Example atproto Browser App&quot;,</div>
<div class="line">  &quot;client_uri&quot;: &quot;https://example.com&quot;,</div>
<div class="line">  &quot;logo_uri&quot;: &quot;https://example.com/logo.png&quot;,</div>
<div class="line">  &quot;tos_uri&quot;: &quot;https://example.com/tos&quot;,</div>
<div class="line">  &quot;policy_uri&quot;: &quot;https://example.com/policy&quot;,</div>
<div class="line">  &quot;redirect_uris&quot;: [&quot;https://example.com/callback&quot;],</div>
<div class="line">  &quot;scope&quot;: &quot;atproto&quot;,</div>
<div class="line">  &quot;grant_types&quot;: [&quot;authorization_code&quot;, &quot;refresh_token&quot;],</div>
<div class="line">  &quot;response_types&quot;: [&quot;code&quot;],</div>
<div class="line">  &quot;token_endpoint_auth_method&quot;: &quot;none&quot;,</div>
<div class="line">  &quot;application_type&quot;: &quot;web&quot;,</div>
<div class="line">  &quot;dpop_bound_access_tokens&quot;: true</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li><code>redirect_uris</code>: An array of URLs that will be used as the redirect URIs for the OAuth flow. This should typically contain a single URL that points to a page on your SPA that will handle the OAuth response. This URL must be HTTPS.</li>
<li><code>client_id</code>: The URL where the client metadata is hosted. This field must be the exact same as the URL used to access the metadata.</li>
<li><code>client_name</code>: The name of your client. Will be displayed to the user during the authentication process.</li>
<li><code>client_uri</code>: The URL of your client. Whether or not this value is actually displayed / used is up to the Authorization Server.</li>
<li><code>logo_uri</code>: The URL of your client's logo. Should be displayed to the user during the authentication process. Whether your logo is actually displayed during the authentication process or not is up to the Authorization Server.</li>
<li><code>tos_uri</code>: The URL of your client's terms of service. Will be displayed to the user during the authentication process.</li>
<li><code>policy_uri</code>: The URL of your client's privacy policy. Will be displayed to the user during the authentication process.</li>
<li>If you don't want or need the user to stay authenticated for long periods (better for security), you can remove <code>refresh_token</code> from the <code>grant_types</code>.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><br  />
 To mitigate phishing attacks, the Authentication Server will typically <em>not</em> display the <code>client_uri</code> or <code>logo_uri</code> to the user. If you don't see your logo or client name during the authentication process, don't worry. This is normal. The <code>client_name</code> <em>is</em> generally displayed for all clients.</dd></dl>
<p>Upload this JSON file so that it is accessible at the URL you chose for your <code>client_id</code>.</p>
<h1><a class="anchor" id="autotoc_md1959"></a>
Step 2: Setup your SPA</h1>
<p>Start by setting up your SPA. You can use any framework you like, or none at all. In this example, we will use TypeScript and Parcel, with plain JavaScript.</p>
<div class="fragment"><div class="line">npm init -y</div>
<div class="line">npm install --save-dev @atproto/oauth-client-browser</div>
<div class="line">npm install --save-dev @atproto/api</div>
<div class="line">npm install --save-dev parcel</div>
<div class="line">npm install --save-dev parcel-reporter-static-files-copy</div>
<div class="line">mkdir -p src</div>
<div class="line">mkdir -p static</div>
</div><!-- fragment --><p>Create a <code>.parcelrc</code> file with the following (exact) content:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;extends&quot;: [&quot;@parcel/config-default&quot;],</div>
<div class="line">  &quot;reporters&quot;: [&quot;...&quot;, &quot;parcel-reporter-static-files-copy&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><p>Create an <code>src/index.html</code> file with the following content:</p>
<div class="fragment"><div class="line">&lt;!doctype html&gt;</div>
<div class="line">&lt;html lang=&quot;en&quot;&gt;</div>
<div class="line">  &lt;head&gt;</div>
<div class="line">    &lt;meta charset=&quot;utf-8&quot; /&gt;</div>
<div class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</div>
<div class="line">    &lt;title&gt;My First OAuth App&lt;/title&gt;</div>
<div class="line">    &lt;script type=&quot;module&quot; src=&quot;app.ts&quot;&gt;&lt;/script&gt;</div>
<div class="line">  &lt;/head&gt;</div>
<div class="line">  &lt;body&gt;</div>
<div class="line">    Loading...</div>
<div class="line">  &lt;/body&gt;</div>
<div class="line">&lt;/html&gt;</div>
</div><!-- fragment --><p>And an <code>src/app.ts</code> file, with the following content:</p>
<div class="fragment"><div class="line">console.log(&#39;Hello from atproto OAuth example app!&#39;)</div>
</div><!-- fragment --><p>Start the app in development mode:</p>
<div class="fragment"><div class="line">npx parcel src/index.html</div>
</div><!-- fragment --><p>In another terminal, open a tunnel to your local server:</p>
<div class="fragment"><div class="line">ngrok http 1234</div>
</div><!-- fragment --><p>Create a <code>static/client-metadata.json</code> file with the client metadata you created in Step 1. Use the hostname provided by ngrok as the <code>client_id</code>:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;client_id&quot;: &quot;https://&lt;RANDOM_VALUE&gt;.ngrok.app/client-metadata.json&quot;,</div>
<div class="line">  &quot;client_name&quot;: &quot;My First atproto OAuth App&quot;,</div>
<div class="line">  &quot;client_uri&quot;: &quot;https://&lt;RANDOM_VALUE&gt;.ngrok.app&quot;,</div>
<div class="line">  &quot;redirect_uris&quot;: [&quot;https://&lt;RANDOM_VALUE&gt;.ngrok.app/&quot;],</div>
<div class="line">  &quot;grant_types&quot;: [&quot;authorization_code&quot;],</div>
<div class="line">  &quot;response_types&quot;: [&quot;code&quot;],</div>
<div class="line">  &quot;token_endpoint_auth_method&quot;: &quot;none&quot;,</div>
<div class="line">  &quot;application_type&quot;: &quot;web&quot;,</div>
<div class="line">  &quot;dpop_bound_access_tokens&quot;: true</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1960"></a>
Step 3: Implement the OAuth flow</h1>
<p>Replace the content of the <code>src/app.ts</code> file, with the following content:</p>
<div class="fragment"><div class="line">import { Agent } from &#39;@atproto/api&#39;</div>
<div class="line">import { BrowserOAuthClient } from &#39;@atproto/oauth-client-browser&#39;</div>
<div class="line"> </div>
<div class="line">async function main() {</div>
<div class="line">  const oauthClient = await BrowserOAuthClient.load({</div>
<div class="line">    clientId: &#39;&lt;YOUR_CLIENT_ID&gt;&#39;,</div>
<div class="line">    handleResolver: &#39;https://bsky.social/&#39;,</div>
<div class="line">  })</div>
<div class="line"> </div>
<div class="line">  // TO BE CONTINUED</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">document.addEventListener(&#39;DOMContentLoaded&#39;, main)</div>
</div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd><br  />
 Using Bluesky-hosted services for handle resolution (eg, the <code>bsky.social</code> endpoint) will leak both user IP addresses and handle identifier to Bluesky, a third party. While Bluesky has a declared privacy policy, both developers and users of applications need to be informed of and aware of the privacy implications of this arrangement. Application developers are encouraged to improve user privacy by operating their own handle resolution service when possible. If you are a PDS self-hoster, you can use your PDS's URL for <code>handleResolver</code>.</dd></dl>
<p>The <code>oauthClient</code> is now configured to communicate with the user's Authorization Service. You can now initialize it in order to detect if the user is already authenticated. Replace the <code>// TO BE CONTINUED</code> comment with the following code:</p>
<div class="fragment"><div class="line">const result = await oauthClient.init()</div>
<div class="line"> </div>
<div class="line">if (result) {</div>
<div class="line">  if (&#39;state&#39; in result) {</div>
<div class="line">    console.log(&#39;The user was just redirected back from the authorization page&#39;)</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  console.log(`The user is currently signed in as ${result.session.did}`)</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">const session = result?.session</div>
<div class="line"> </div>
<div class="line">// TO BE CONTINUED</div>
</div><!-- fragment --><p>At this point you can detect if the user is already authenticated or not (by checking if <code>session</code> is <code>undefined</code>).</p>
<p>Let's initiate an authentication flow if the user is not authenticated. Replace the <code>// TO BE CONTINUED</code> comment with the following code:</p>
<div class="fragment"><div class="line">if (!session) {</div>
<div class="line">  const handle = prompt(&#39;Enter your atproto handle to authenticate&#39;)</div>
<div class="line">  if (!handle) throw new Error(&#39;Authentication process canceled by the user&#39;)</div>
<div class="line"> </div>
<div class="line">  const url = await oauthClient.authorize(handle)</div>
<div class="line"> </div>
<div class="line">  // Redirect the user to the authorization page</div>
<div class="line">  window.open(url, &#39;_self&#39;, &#39;noopener&#39;)</div>
<div class="line"> </div>
<div class="line">  // Protect against browser&#39;s back-forward cache</div>
<div class="line">  await new Promise&lt;never&gt;((resolve, reject) =&gt; {</div>
<div class="line">    setTimeout(</div>
<div class="line">      reject,</div>
<div class="line">      10_000,</div>
<div class="line">      new Error(&#39;User navigated back from the authorization page&#39;),</div>
<div class="line">    )</div>
<div class="line">  })</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// TO BE CONTINUED</div>
</div><!-- fragment --><p>At this point in the script, the user <b>will</b> be authenticated. Authenticated API calls can be made using the <code>session</code>. The <code>session</code> can be used to instantiate the <code>Agent</code> class from <code>@atproto/api</code>. Let's make a simple call to the API to retrieve the user's profile. Replace the <code>// TO BE CONTINUED</code> comment with the following code:</p>
<div class="fragment"><div class="line">if (session) {</div>
<div class="line">  const agent = new Agent(session)</div>
<div class="line"> </div>
<div class="line">  const fetchProfile = async () =&gt; {</div>
<div class="line">    const profile = await agent.getProfile({ actor: agent.did })</div>
<div class="line">    return profile.data</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  // Update the user interface</div>
<div class="line"> </div>
<div class="line">  document.body.textContent = `Authenticated as ${agent.did}`</div>
<div class="line"> </div>
<div class="line">  const profileBtn = document.createElement(&#39;button&#39;)</div>
<div class="line">  document.body.appendChild(profileBtn)</div>
<div class="line">  profileBtn.textContent = &#39;Fetch Profile&#39;</div>
<div class="line">  profileBtn.onclick = async () =&gt; {</div>
<div class="line">    const profile = await fetchProfile()</div>
<div class="line">    outputPre.textContent = JSON.stringify(profile, null, 2)</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  const logoutBtn = document.createElement(&#39;button&#39;)</div>
<div class="line">  document.body.appendChild(logoutBtn)</div>
<div class="line">  logoutBtn.textContent = &#39;Logout&#39;</div>
<div class="line">  logoutBtn.onclick = async () =&gt; {</div>
<div class="line">    await session.signOut()</div>
<div class="line">    window.location.reload()</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  const outputPre = document.createElement(&#39;pre&#39;)</div>
<div class="line">  document.body.appendChild(outputPre)</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
