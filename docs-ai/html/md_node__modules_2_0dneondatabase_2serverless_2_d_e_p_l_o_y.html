<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gradiant Ascent: Deploying a WebSocket proxy in front of your own Postgres instance</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Gradiant Ascent
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Deploying a WebSocket proxy in front of your own Postgres instance</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md5012"></a></p>
<p><b>This package comes configured to connect to a Neon database over a secure (<code>wss:</code>) WebSocket. If you're using a Neon database, you can ignore what follows.</b></p>
<p>But you can also run your own WebSocket proxy, and configure it to allow onward connections to your own Postgres instances.</p>
<p>First, you'll need to set up the proxy itself somewhere public-facing (or on <code>localhost</code> for development). See <a href="https://github.com/neondatabase/wsproxy">https://github.com/neondatabase/wsproxy</a> for the Go code and instructions.</p>
<p>There are then two ways you can secure this:</p>
<ol type="1">
<li>Set up nginx as a TLS proxy in front of <code>wsproxy</code>. Example shell commands to achieve this can be found below. Onward traffic to Postgres is not secured by this method, so Postgres should be running on the same machine or be reached over a private network.</li>
<li>Use experimental pure-JS Postgres connection encryption via <a href="https://github.com/jawj/subtls">subtls</a>. There's no need for nginx in this scenario, and the Postgres connection is encrypted end-to-end. You get this form of encryption if you set both <code>neonConfig.useSecureWebSocket</code> and <code>neonConfig.forceDisablePgSSL</code> to <code>false</code>, and append <code>?sslmode=verify-full</code> (or similar) to your connection string. TLS version 1.3 must be supported by the Postgres back-end. <b>Please note that subtls is experimental software and this configuration is not recommended for production use.</b></li>
</ol>
<p>Second, you'll need to set some <a class="el" href="md_node__modules_2_0dneondatabase_2serverless_2_c_o_n_f_i_g.html">configuration options</a> on this package: at a minimum theÂ <code>wsProxy</code> option and (if using experimental encryption) <code>subtls</code> and <code>rootCerts</code>.</p>
<h1><a class="anchor" id="autotoc_md5013"></a>
Example shell commands</h1>
<p>To deploy <code>wsproxy</code> behind nginx (for TLS) on a host <code>ws.example.com</code> running Ubuntu 22.04 (and Postgres locally), you'd do something similar to the following.</p>
<p>Before you start:</p>
<ol type="1">
<li>Ensure port 443 is accessible on this machine. You might need to change firewall settings with your platform provider.</li>
<li>Upgrade to Ubuntu 22.04 if on an earlier version (golang is too old on older releases):</li>
</ol>
<div class="fragment"><div class="line">sudo su  # do this all as root</div>
<div class="line">apt update -y &amp;&amp; apt upgrade -y &amp;&amp; apt dist-upgrade -y</div>
<div class="line">apt autoremove -y &amp;&amp; apt autoclean -y</div>
<div class="line">apt install -y update-manager-core</div>
<div class="line">do-release-upgrade  # and answer yes to all defaults</div>
</div><!-- fragment --><p>Then:</p>
<div class="fragment"><div class="line">sudo su  # do this all as root</div>
<div class="line"> </div>
<div class="line">export HOSTDOMAIN=ws.example.com  # edit the domain name for your case</div>
<div class="line"> </div>
<div class="line"># if required: install postgres + create a password-auth user</div>
<div class="line"> </div>
<div class="line">apt install -y postgresql</div>
<div class="line"> </div>
<div class="line">echo &#39;create database wstest; create user wsclear; grant all privileges on database wstest to wsclear;&#39; | sudo -u postgres psql</div>
<div class="line"> </div>
<div class="line">sudo -u postgres psql  # and run: \password wsclear</div>
<div class="line"> </div>
<div class="line">perl -pi -e &#39;s/^# IPv4 local connections:\n/# IPv4 local connections:\nhost all wsclear 127.0.0.1\/32 password\n/&#39; /etc/postgresql/14/main/pg_hba.conf</div>
<div class="line"> </div>
<div class="line">service postgresql restart</div>
<div class="line"> </div>
<div class="line"># install wsproxy</div>
<div class="line"> </div>
<div class="line">adduser wsproxy --disabled-login</div>
<div class="line"> </div>
<div class="line">sudo su wsproxy</div>
<div class="line">cd</div>
<div class="line">git clone https://github.com/neondatabase/wsproxy.git</div>
<div class="line">cd wsproxy</div>
<div class="line">go build</div>
<div class="line">exit</div>
<div class="line"> </div>
<div class="line">echo &quot;</div>
<div class="line">[Unit]</div>
<div class="line">Description=wsproxy</div>
<div class="line"> </div>
<div class="line">[Service]</div>
<div class="line">Type=simple</div>
<div class="line">Restart=always</div>
<div class="line">RestartSec=5s</div>
<div class="line">User=wsproxy</div>
<div class="line">Environment=LISTEN_PORT=:6543 ALLOW_ADDR_REGEX=&#39;^${HOSTDOMAIN}:5432\$&#39;</div>
<div class="line">ExecStart=/home/wsproxy/wsproxy/wsproxy</div>
<div class="line"> </div>
<div class="line">[Install]</div>
<div class="line">WantedBy=multi-user.target</div>
<div class="line">&quot; &gt; /lib/systemd/system/wsproxy.service</div>
<div class="line"> </div>
<div class="line">systemctl enable wsproxy</div>
<div class="line">service wsproxy start</div>
<div class="line"> </div>
<div class="line"># install nginx as tls proxy</div>
<div class="line"> </div>
<div class="line">apt install -y golang nginx certbot python3-certbot-nginx</div>
<div class="line"> </div>
<div class="line">echo &quot;127.0.0.1 ${HOSTDOMAIN}&quot; &gt;&gt; /etc/hosts</div>
<div class="line"> </div>
<div class="line">echo &quot;                                                                       </div>
<div class="line">server {</div>
<div class="line">  listen 80;</div>
<div class="line">  listen [::]:80;</div>
<div class="line">  server_name ${HOSTDOMAIN};</div>
<div class="line">  location / {</div>
<div class="line">    proxy_pass http://127.0.0.1:6543/;</div>
<div class="line">    proxy_set_header Upgrade \$http_upgrade;</div>
<div class="line">    proxy_set_header Connection Upgrade;</div>
<div class="line">    proxy_set_header Host \$host;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line">&quot; &gt; /etc/nginx/sites-available/wsproxy   </div>
<div class="line"> </div>
<div class="line">ln -s /etc/nginx/sites-available/wsproxy /etc/nginx/sites-enabled/wsproxy</div>
<div class="line"> </div>
<div class="line">certbot --nginx -d ${HOSTDOMAIN}</div>
<div class="line"> </div>
<div class="line">echo &quot;</div>
<div class="line">server {</div>
<div class="line">  server_name ${HOSTDOMAIN};</div>
<div class="line"> </div>
<div class="line">  location / {</div>
<div class="line">    proxy_pass http://127.0.0.1:6543/;</div>
<div class="line">    proxy_set_header Upgrade \$http_upgrade;</div>
<div class="line">    proxy_set_header Connection Upgrade;</div>
<div class="line">    proxy_set_header Host \$host;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  listen [::]:80 ipv6only=on;</div>
<div class="line">  listen 80;</div>
<div class="line"> </div>
<div class="line">  listen [::]:443 ssl ipv6only=on; # managed by Certbot</div>
<div class="line">  listen 443 ssl; # managed by Certbot</div>
<div class="line">  ssl_certificate /etc/letsencrypt/live/${HOSTDOMAIN}/fullchain.pem; # managed by Certbot</div>
<div class="line">  ssl_certificate_key /etc/letsencrypt/live/${HOSTDOMAIN}/privkey.pem; # managed by Certbot</div>
<div class="line">  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</div>
<div class="line">  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</div>
<div class="line">}</div>
<div class="line">&quot; &gt; /etc/nginx/sites-available/wsproxy</div>
<div class="line"> </div>
<div class="line">service nginx restart</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
