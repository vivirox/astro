\doxysection{node\+\_\+modules/@mapbox/node-\/pre-\/gyp Directory Reference}
\hypertarget{dir_fc08e7201cb75f0024284d9f735fd2ec}{}\label{dir_fc08e7201cb75f0024284d9f735fd2ec}\index{node\_modules/"@mapbox/node-\/pre-\/gyp Directory Reference@{node\_modules/"@mapbox/node-\/pre-\/gyp Directory Reference}}


\doxysubsection{Detailed Description}
\hypertarget{README.md_autotoc_md4820}{}\doxysubsubsubsection{\texorpdfstring{@mapbox/node-\/pre-\/gyp makes it easy to publish and install Node.\+js C++ addons from binaries}{@mapbox/node-\/pre-\/gyp makes it easy to publish and install Node.\+js C++ addons from binaries}}\label{README.md_autotoc_md4820}
\href{https://ci.appveyor.com/project/Mapbox/node-pre-gyp}{\texttt{ }}

{\ttfamily @mapbox/node-\/pre-\/gyp} stands between \href{https://github.com/npm/npm}{\texttt{ npm}} and \href{https://github.com/Tootallnate/node-gyp}{\texttt{ node-\/gyp}} and offers a cross-\/platform method of binary deployment.\hypertarget{README.md_autotoc_md4821}{}\doxysubsubsection{\texorpdfstring{Special note on previous package}{Special note on previous package}}\label{README.md_autotoc_md4821}
On Feb 9th, 2021 {\ttfamily @mapbox/node-\/pre-\/gyp@1.\+0.\+0} was \doxysectlink{md_node__modules_2_0dmapbox_2node-pre-gyp_2_c_h_a_n_g_e_l_o_g}{released}{0}. Older, unscoped versions that are not part of the {\ttfamily @mapbox} org are deprecated and only {\ttfamily @mapbox/node-\/pre-\/gyp} will see updates going forward. To upgrade to the new package do\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{npm\ uninstall\ node-\/pre-\/gyp\ -\/-\/save}
\DoxyCodeLine{npm\ install\ @mapbox/node-\/pre-\/gyp\ -\/-\/save}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md4822}{}\doxysubsubsection{\texorpdfstring{Features}{Features}}\label{README.md_autotoc_md4822}

\begin{DoxyItemize}
\item A command line tool called {\ttfamily node-\/pre-\/gyp} that can install your package\textquotesingle{}s C++ module from a binary.
\item A variety of developer targeted commands for packaging, testing, and publishing binaries.
\item A Java\+Script module that can dynamically require your installed binary\+: `require('@mapbox/node-\/pre-\/gyp\textquotesingle{}).find\`{}
\end{DoxyItemize}

For a hello world example of a module packaged with {\ttfamily node-\/pre-\/gyp} see \href{https://github.com/springmeyer/node-addon-example}{\texttt{ https\+://github.\+com/springmeyer/node-\/addon-\/example}} and \href{https://github.com/mapbox/node-pre-gyp/wiki/Modules-using-node-pre-gyp}{\texttt{ the wiki}} for real world examples.\hypertarget{README.md_autotoc_md4823}{}\doxysubsection{\texorpdfstring{Credits}{Credits}}\label{README.md_autotoc_md4823}

\begin{DoxyItemize}
\item The module is modeled after \href{https://github.com/Tootallnate/node-gyp}{\texttt{ node-\/gyp}} by \href{https://github.com/Tootallnate}{\texttt{ @\+Tootallnate}}
\item Motivation for initial development came from \href{https://github.com/ErisDS}{\texttt{ @\+Eris\+DS}} and the \href{https://github.com/TryGhost/Ghost}{\texttt{ Ghost Project}}.
\item Development is sponsored by \href{https://www.mapbox.com/}{\texttt{ Mapbox}}
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4824}{}\doxysubsection{\texorpdfstring{FAQ}{FAQ}}\label{README.md_autotoc_md4824}
See the \href{https://github.com/mapbox/node-pre-gyp/wiki/FAQ}{\texttt{ Frequently Ask Questions}}.\hypertarget{README.md_autotoc_md4825}{}\doxysubsection{\texorpdfstring{Depends}{Depends}}\label{README.md_autotoc_md4825}
We will attempt to track the \href{https://github.com/nodejs/release\#release-schedule}{\texttt{ Node.\+js release schedule}} and will regularly retire support for versions that have reached EOL.


\begin{DoxyItemize}
\item v2\+: Node.\+js \texorpdfstring{$>$}{>}= 18.\+x (unreleased)
\item v1\+: Node.\+js \texorpdfstring{$>$}{>}= 8.\+x
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4826}{}\doxysubsection{\texorpdfstring{Install}{Install}}\label{README.md_autotoc_md4826}
{\ttfamily node-\/pre-\/gyp} is designed to be installed as a local dependency of your Node.\+js C++ addon and accessed like\+: \begin{DoxyVerb}./node_modules/.bin/node-pre-gyp --help
\end{DoxyVerb}


But you can also install it globally\+: \begin{DoxyVerb}npm install @mapbox/node-pre-gyp -g
\end{DoxyVerb}
\hypertarget{README.md_autotoc_md4827}{}\doxysubsection{\texorpdfstring{Usage}{Usage}}\label{README.md_autotoc_md4827}
\hypertarget{README.md_autotoc_md4828}{}\doxysubsubsection{\texorpdfstring{Commands}{Commands}}\label{README.md_autotoc_md4828}
View all possible commands\+: \begin{DoxyVerb}node-pre-gyp --help
\end{DoxyVerb}



\begin{DoxyItemize}
\item clean -\/ Remove the entire folder containing the compiled .node module
\item install -\/ Install pre-\/built binary for module
\item reinstall -\/ Run "{}clean"{} and "{}install"{} at once
\item build -\/ Compile the module by dispatching to node-\/gyp or nw-\/gyp
\item rebuild -\/ Run "{}clean"{} and "{}build"{} at once
\item package -\/ Pack binary into tarball
\item testpackage -\/ Test that the staged package is valid
\item publish -\/ Publish pre-\/built binary
\item unpublish -\/ Unpublish pre-\/built binary
\item info -\/ Fetch info on published binaries
\end{DoxyItemize}

You can also chain commands\+: \begin{DoxyVerb}node-pre-gyp clean build unpublish publish info
\end{DoxyVerb}
\hypertarget{README.md_autotoc_md4829}{}\doxysubsubsection{\texorpdfstring{Options}{Options}}\label{README.md_autotoc_md4829}
Options include\+:


\begin{DoxyItemize}
\item {\ttfamily -\/C/-\/-\/directory}\+: run the command in this directory
\item {\ttfamily -\/-\/build-\/from-\/source}\+: build from source instead of using pre-\/built binary
\item {\ttfamily -\/-\/update-\/binary}\+: reinstall by replacing previously installed local binary with remote binary
\item {\ttfamily -\/-\/runtime=node-\/webkit}\+: customize the runtime\+: {\ttfamily node}, {\ttfamily electron} and {\ttfamily node-\/webkit} are the valid options
\item {\ttfamily -\/-\/fallback-\/to-\/build}\+: fallback to building from source if pre-\/built binary is not available
\item {\ttfamily -\/-\/target=0.\+4.\+0}\+: Pass the target node or node-\/webkit version to compile against
\item {\ttfamily -\/-\/target\+\_\+arch=ia32}\+: Pass the target arch and override the host {\ttfamily arch}. Any value that is \href{https://nodejs.org/api/os.html\#osarch}{\texttt{ supported by Node.\+js}} is valid.
\item {\ttfamily -\/-\/target\+\_\+platform=win32}\+: Pass the target platform and override the host {\ttfamily platform}. Valid values are {\ttfamily linux}, {\ttfamily darwin}, {\ttfamily win32}, {\ttfamily sunos}, {\ttfamily freebsd}, {\ttfamily openbsd}, and {\ttfamily aix}.
\end{DoxyItemize}

Both {\ttfamily -\/-\/build-\/from-\/source} and {\ttfamily -\/-\/fallback-\/to-\/build} can be passed alone or they can provide values. You can pass {\ttfamily -\/-\/fallback-\/to-\/build=false} to override the option as declared in package.\+json. In addition to being able to pass {\ttfamily -\/-\/build-\/from-\/source} you can also pass {\ttfamily -\/-\/build-\/from-\/source=myapp} where {\ttfamily myapp} is the name of your module.

For example\+: {\ttfamily npm install -\/-\/build-\/from-\/source=myapp}. This is useful if\+:


\begin{DoxyItemize}
\item {\ttfamily myapp} is referenced in the package.\+json of a larger app and therefore {\ttfamily myapp} is being installed as a dependency with {\ttfamily npm install}.
\item The larger app also depends on other modules installed with {\ttfamily node-\/pre-\/gyp}
\item You only want to trigger a source compile for {\ttfamily myapp} and the other modules.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4830}{}\doxysubsubsection{\texorpdfstring{Configuring}{Configuring}}\label{README.md_autotoc_md4830}
This is a guide to configuring your module to use node-\/pre-\/gyp.\hypertarget{README.md_autotoc_md4831}{}\doxysubsubsubsection{\texorpdfstring{1) Add new entries to your {\ttfamily package.\+json}}{1) Add new entries to your {\ttfamily package.\+json}}}\label{README.md_autotoc_md4831}

\begin{DoxyItemize}
\item Add {\ttfamily @mapbox/node-\/pre-\/gyp} to {\ttfamily dependencies}
\item Add {\ttfamily aws-\/sdk} as a {\ttfamily dev\+Dependency}
\item Add a custom {\ttfamily install} script
\item Declare a {\ttfamily binary} object
\end{DoxyItemize}

This looks like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{"{}dependencies"{}\ \ :\ \{}
\DoxyCodeLine{\ \ "{}@mapbox/node-\/pre-\/gyp"{}:\ "{}1.x"{}}
\DoxyCodeLine{\},}
\DoxyCodeLine{"{}devDependencies"{}:\ \{}
\DoxyCodeLine{\ \ "{}aws-\/sdk"{}:\ "{}2.x"{}}
\DoxyCodeLine{\}}
\DoxyCodeLine{"{}scripts"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}install"{}:\ "{}node-\/pre-\/gyp\ install\ -\/-\/fallback-\/to-\/build"{}}
\DoxyCodeLine{\},}
\DoxyCodeLine{"{}binary"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}module\_name"{}:\ "{}your\_module"{},}
\DoxyCodeLine{\ \ \ \ "{}module\_path"{}:\ "{}./lib/binding/"{},}
\DoxyCodeLine{\ \ \ \ "{}host"{}:\ "{}https://your\_module.s3-\/us-\/west-\/1.amazonaws.com"{}}
\DoxyCodeLine{\}}

\end{DoxyCode}


For a full example see \href{https://github.com/springmeyer/node-addon-example/blob/master/package.json}{\texttt{ node-\/addon-\/examples\textquotesingle{}s package.\+json}}.

Let\textquotesingle{}s break this down\+:


\begin{DoxyItemize}
\item Dependencies need to list {\ttfamily node-\/pre-\/gyp}
\item Your dev\+Dependencies should list {\ttfamily aws-\/sdk} so that you can run {\ttfamily node-\/pre-\/gyp publish} locally or a CI system. We recommend using {\ttfamily dev\+Dependencies} only since {\ttfamily aws-\/sdk} is large and not needed for {\ttfamily node-\/pre-\/gyp install} since it only uses http to fetch binaries
\item Your {\ttfamily scripts} section should override the {\ttfamily install} target with {\ttfamily "{}install"{}\+: "{}node-\/pre-\/gyp install -\/-\/fallback-\/to-\/build"{}}. This allows node-\/pre-\/gyp to be used instead of the default npm behavior of always source compiling with {\ttfamily node-\/gyp} directly.
\item Your package.\+json should contain a {\ttfamily binary} section describing key properties you provide to allow node-\/pre-\/gyp to package optimally. They are detailed below.
\end{DoxyItemize}

Note\+: in the past we recommended putting {\ttfamily @mapbox/node-\/pre-\/gyp} in the {\ttfamily bundled\+Dependencies}, but we no longer recommend this. In the past there were npm bugs (with node versions 0.\+10.\+x) that could lead to node-\/pre-\/gyp not being available at the right time during install (unless we bundled). This should no longer be the case. Also, for a time we recommended using {\ttfamily "{}preinstall"{}\+: "{}npm install @mapbox/node-\/pre-\/gyp"{}} as an alternative method to avoid needing to bundle. But this did not behave predictably across all npm versions -\/ see \href{https://github.com/mapbox/node-pre-gyp/issues/260}{\texttt{ https\+://github.\+com/mapbox/node-\/pre-\/gyp/issues/260}} for the details. So we do not recommend using {\ttfamily preinstall} to install {\ttfamily @mapbox/node-\/pre-\/gyp}. More history on this at \href{https://github.com/strongloop/fsevents/issues/157\#issuecomment-265545908}{\texttt{ https\+://github.\+com/strongloop/fsevents/issues/157\#issuecomment-\/265545908}}.\hypertarget{README.md_autotoc_md4832}{}\doxysubsubsubsubsection{\texorpdfstring{The {\ttfamily binary} object has three required properties}{The {\ttfamily binary} object has three required properties}}\label{README.md_autotoc_md4832}
\hypertarget{README.md_autotoc_md4833}{}\doxysubsubsubsubsubsection{\texorpdfstring{module\+\_\+name}{module\+\_\+name}}\label{README.md_autotoc_md4833}
The name of your native node module. This value must\+:


\begin{DoxyItemize}
\item Match the name passed to \href{http://nodejs.org/api/addons.html\#addons_hello_world}{\texttt{ the NODE\+\_\+\+MODULE macro}}
\item Must be a valid C variable name (e.\+g. it cannot contain {\ttfamily -\/})
\item Should not include the {\ttfamily .node} extension.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4834}{}\doxysubsubsubsubsubsection{\texorpdfstring{module\+\_\+path}{module\+\_\+path}}\label{README.md_autotoc_md4834}
The location your native module is placed after a build. This should be an empty directory without other Javascript files. This entire directory will be packaged in the binary tarball. When installing from a remote package this directory will be overwritten with the contents of the tarball.

Note\+: This property supports variables based on Versioning.\hypertarget{README.md_autotoc_md4835}{}\doxysubsubsubsubsubsection{\texorpdfstring{host}{host}}\label{README.md_autotoc_md4835}
A url to the remote location where you\textquotesingle{}ve published tarball binaries (must be {\ttfamily https} not {\ttfamily http}).

It is highly recommended that you use Amazon S3. The reasons are\+:


\begin{DoxyItemize}
\item Various node-\/pre-\/gyp commands like {\ttfamily publish} and {\ttfamily info} only work with an S3 host.
\item S3 is a very solid hosting platform for distributing large files.
\item We provide detail documentation for using S3 hosting with node-\/pre-\/gyp.
\end{DoxyItemize}

Why then not require S3? Because while some applications using node-\/pre-\/gyp need to distribute binaries as large as 20-\/30 MB, others might have very small binaries and might wish to store them in a Git\+Hub repo. This is not recommended, but if an author really wants to host in a non-\/\+S3 location then it should be possible.

It should also be mentioned that there is an optional and entirely separate npm module called \href{https://github.com/bchr02/node-pre-gyp-github}{\texttt{ node-\/pre-\/gyp-\/github}} which is intended to complement node-\/pre-\/gyp and be installed along with it. It provides the ability to store and publish your binaries within your repositories Git\+Hub Releases if you would rather not use S3 directly. Installation and usage instructions can be found \href{https://github.com/bchr02/node-pre-gyp-github}{\texttt{ here}}, but the basic premise is that instead of using the {\ttfamily node-\/pre-\/gyp publish} command you would use {\ttfamily node-\/pre-\/gyp-\/github publish}.\hypertarget{README.md_autotoc_md4836}{}\doxysubsubsubsubsection{\texorpdfstring{The {\ttfamily binary} object other optional S3 properties}{The {\ttfamily binary} object other optional S3 properties}}\label{README.md_autotoc_md4836}
If you are not using a standard s3 path like {\ttfamily bucket\+\_\+name.\+s3(.-\/)region.\+amazonaws.\+com}, you might get an error on {\ttfamily publish} because node-\/pre-\/gyp extracts the region and bucket from the {\ttfamily host} url. For example, you may have an on-\/premises s3-\/compatible storage server, or may have configured a specific dns redirecting to an s3 endpoint. In these cases, you can explicitly set the {\ttfamily region} and {\ttfamily bucket} properties to tell node-\/pre-\/gyp to use these values instead of guessing from the {\ttfamily host} property. The following values can be used in the {\ttfamily binary} section\+:\hypertarget{README.md_autotoc_md4837}{}\doxysubsubsubsubsubsection{\texorpdfstring{host}{host}}\label{README.md_autotoc_md4837}
The url to the remote server root location (must be {\ttfamily https} not {\ttfamily http}).\hypertarget{README.md_autotoc_md4838}{}\doxysubsubsubsubsubsection{\texorpdfstring{bucket}{bucket}}\label{README.md_autotoc_md4838}
The bucket name where your tarball binaries should be located.\hypertarget{README.md_autotoc_md4839}{}\doxysubsubsubsubsubsection{\texorpdfstring{region}{region}}\label{README.md_autotoc_md4839}
Your S3 server region.\hypertarget{README.md_autotoc_md4840}{}\doxysubsubsubsubsubsection{\texorpdfstring{s3\+Force\+Path\+Style}{s3\+Force\+Path\+Style}}\label{README.md_autotoc_md4840}
Set {\ttfamily s3\+Force\+Path\+Style} to true if the endpoint url should not be prefixed with the bucket name. If false (default), the server endpoint would be constructed as {\ttfamily bucket\+\_\+name.\+your\+\_\+server.\+com}.\hypertarget{README.md_autotoc_md4841}{}\doxysubsubsubsubsection{\texorpdfstring{The {\ttfamily binary} object has optional properties}{The {\ttfamily binary} object has optional properties}}\label{README.md_autotoc_md4841}
\hypertarget{README.md_autotoc_md4842}{}\doxysubsubsubsubsubsection{\texorpdfstring{remote\+\_\+path}{remote\+\_\+path}}\label{README.md_autotoc_md4842}
It {\bfseries{is recommended}} that you customize this property. This is an extra path to use for publishing and finding remote tarballs. The default value for {\ttfamily remote\+\_\+path} is {\ttfamily "{}"{}} meaning that if you do not provide it then all packages will be published at the base of the {\ttfamily host}. It is recommended to provide a value like {\ttfamily ./\{name\}/v\{version\}} to help organize remote packages in the case that you choose to publish multiple node addons to the same {\ttfamily host}.

Note\+: This property supports variables based on Versioning.\hypertarget{README.md_autotoc_md4843}{}\doxysubsubsubsubsubsection{\texorpdfstring{package\+\_\+name}{package\+\_\+name}}\label{README.md_autotoc_md4843}
It is {\bfseries{not recommended}} to override this property unless you are also overriding the {\ttfamily remote\+\_\+path}. This is the versioned name of the remote tarball containing the binary {\ttfamily .node} module and any supporting files you\textquotesingle{}ve placed inside the {\ttfamily module\+\_\+path} directory. Unless you specify {\ttfamily package\+\_\+name} in your {\ttfamily package.\+json} then it defaults to {\ttfamily \{module\+\_\+name\}-\/v\{version\}-\/\{node\+\_\+abi\}-\/\{platform\}-\/\{arch\}.tar.\+gz} which allows your binary to work across node versions, platforms, and architectures. If you are using {\ttfamily remote\+\_\+path} that is also versioned by {\ttfamily ./\{module\+\_\+name\}/v\{version\}} then you could remove these variables from the {\ttfamily package\+\_\+name} and just use\+: {\ttfamily \{node\+\_\+abi\}-\/\{platform\}-\/\{arch\}.tar.\+gz}. Then your remote tarball will be looked up at, for example, {\ttfamily \href{https://example.com/your-module/v0.1.0/node-v11-linux-x64.tar.gz}{\texttt{ https\+://example.\+com/your-\/module/v0.\+1.\+0/node-\/v11-\/linux-\/x64.\+tar.\+gz}}}.

Avoiding the version of your module in the {\ttfamily package\+\_\+name} and instead only embedding in a directory name can be useful when you want to make a quick tag of your module that does not change any C++ code. In this case you can just copy binaries to the new version behind the scenes like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{aws\ s3\ sync\ -\/-\/acl\ public-\/read\ s3://mapbox-\/node-\/binary/sqlite3/v3.0.3/\ s3://mapbox-\/node-\/binary/sqlite3/v3.0.4/}

\end{DoxyCode}


Note\+: This property supports variables based on Versioning.\hypertarget{README.md_autotoc_md4844}{}\doxysubsubsubsection{\texorpdfstring{2) Add a new target to binding.\+gyp}{2) Add a new target to binding.\+gyp}}\label{README.md_autotoc_md4844}
{\ttfamily node-\/pre-\/gyp} calls out to {\ttfamily node-\/gyp} to compile the module and passes variables along like module\+\_\+name and module\+\_\+path.

A new target must be added to {\ttfamily binding.\+gyp} that moves the compiled {\ttfamily .node} module from {\ttfamily ./build/\+Release/module\+\_\+name.node} into the directory specified by {\ttfamily module\+\_\+path}.

Add a target like this at the end of your {\ttfamily targets} list\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}target\_name"{}:\ "{}action\_after\_build"{},}
\DoxyCodeLine{\ \ "{}type"{}:\ "{}none"{},}
\DoxyCodeLine{\ \ "{}dependencies"{}:\ [\ "{}<(module\_name)"{}\ ],}
\DoxyCodeLine{\ \ "{}copies"{}:\ [}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ "{}files"{}:\ [\ "{}<(PRODUCT\_DIR)/<(module\_name).node"{}\ ],}
\DoxyCodeLine{\ \ \ \ \ \ "{}destination"{}:\ "{}<(module\_path)"{}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ ]}
\DoxyCodeLine{\}}

\end{DoxyCode}


For a full example see \href{https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/binding.gyp}{\texttt{ node-\/addon-\/example\textquotesingle{}s binding.\+gyp}}.\hypertarget{README.md_autotoc_md4845}{}\doxysubsubsubsection{\texorpdfstring{3) Dynamically require your {\ttfamily .node}}{3) Dynamically require your {\ttfamily .node}}}\label{README.md_autotoc_md4845}
Inside the main js file that requires your addon module you are likely currently doing\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{var\ binding\ =\ require('../build/Release/binding.node');}

\end{DoxyCode}


or\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{var\ bindings\ =\ require('./bindings')}

\end{DoxyCode}


Change those lines to\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{var\ binary\ =\ require('@mapbox/node-\/pre-\/gyp');}
\DoxyCodeLine{var\ path\ =\ require('path');}
\DoxyCodeLine{var\ binding\_path\ =\ binary.find(path.resolve(path.join(\_\_dirname,'./package.json')));}
\DoxyCodeLine{var\ binding\ =\ require(binding\_path);}

\end{DoxyCode}


For a full example see \href{https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/index.js\#L1-L4}{\texttt{ node-\/addon-\/example\textquotesingle{}s index.\+js}}\hypertarget{README.md_autotoc_md4846}{}\doxysubsubsubsection{\texorpdfstring{4) Build and package your app}{4) Build and package your app}}\label{README.md_autotoc_md4846}
Now build your module from source\+: \begin{DoxyVerb}npm install --build-from-source
\end{DoxyVerb}


The {\ttfamily -\/-\/build-\/from-\/source} tells {\ttfamily node-\/pre-\/gyp} to not look for a remote package and instead dispatch to node-\/gyp to build.

Now {\ttfamily node-\/pre-\/gyp} should now also be installed as a local dependency so the command line tool it offers can be found at {\ttfamily ./node\+\_\+modules/.bin/node-\/pre-\/gyp}.\hypertarget{README.md_autotoc_md4847}{}\doxysubsubsubsection{\texorpdfstring{5) Test}{5) Test}}\label{README.md_autotoc_md4847}
Now {\ttfamily npm test} should work just as it did before.\hypertarget{README.md_autotoc_md4848}{}\doxysubsubsubsection{\texorpdfstring{6) Publish the tarball}{6) Publish the tarball}}\label{README.md_autotoc_md4848}
Then package your app\+: \begin{DoxyVerb}./node_modules/.bin/node-pre-gyp package
\end{DoxyVerb}


Once packaged, now you can publish\+: \begin{DoxyVerb}./node_modules/.bin/node-pre-gyp publish
\end{DoxyVerb}


Currently the {\ttfamily publish} command pushes your binary to S3. This requires\+:


\begin{DoxyItemize}
\item You have installed {\ttfamily aws-\/sdk} with {\ttfamily npm install aws-\/sdk}
\item You have created a bucket already.
\item The {\ttfamily host} points to an S3 http or https endpoint.
\item You have configured node-\/pre-\/gyp to read your S3 credentials (see S3 hosting for details).
\end{DoxyItemize}

You can also host your binaries elsewhere. To do this requires\+:


\begin{DoxyItemize}
\item You manually publish the binary created by the {\ttfamily package} command to an {\ttfamily https} endpoint
\item Ensure that the {\ttfamily host} value points to your custom {\ttfamily https} endpoint.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4849}{}\doxysubsubsubsection{\texorpdfstring{7) Automate builds}{7) Automate builds}}\label{README.md_autotoc_md4849}
Now you need to publish builds for all the platforms and node versions you wish to support. This is best automated.


\begin{DoxyItemize}
\item See Appveyor Automation for how to auto-\/publish builds on Windows.
\item See Travis Automation for how to auto-\/publish builds on OS X and Linux.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md4850}{}\doxysubsubsubsection{\texorpdfstring{8) You\textquotesingle{}re done!}{8) You\textquotesingle{}re done!}}\label{README.md_autotoc_md4850}
Now publish your module to the npm registry. Users will now be able to install your module from a binary.

What will happen is this\+:


\begin{DoxyEnumerate}
\item {\ttfamily npm install \texorpdfstring{$<$}{<}your package\texorpdfstring{$>$}{>}} will pull from the npm registry
\item npm will run the {\ttfamily install} script which will call out to {\ttfamily node-\/pre-\/gyp}
\item {\ttfamily node-\/pre-\/gyp} will fetch the binary {\ttfamily .node} module and unpack in the right place
\item Assuming that all worked, you are done
\end{DoxyEnumerate}

If a a binary was not available for a given platform and {\ttfamily -\/-\/fallback-\/to-\/build} was used then {\ttfamily node-\/gyp rebuild} will be called to try to source compile the module.\hypertarget{README.md_autotoc_md4851}{}\doxysubsubsubsection{\texorpdfstring{9) One more option}{9) One more option}}\label{README.md_autotoc_md4851}
It may be that you want to work with two s3 buckets, one for staging and one for production; this arrangement makes it less likely to accidentally overwrite a production binary. It also allows the production environment to have more restrictive permissions than staging while still enabling publishing when developing and testing.

The binary.\+host property can be set at execution time. In order to do so all of the following conditions must be true.


\begin{DoxyItemize}
\item binary.\+host is falsey or not present
\item binary.\+staging\+\_\+host is not empty
\item binary.\+production\+\_\+host is not empty
\end{DoxyItemize}

If any of these checks fail then the operation will not perform execution time determination of the s3 target.

If the command being executed is either "{}publish"{} or "{}unpublish"{} then the default is set to {\ttfamily binary.\+staging\+\_\+host}. In all other cases the default is {\ttfamily binary.\+production\+\_\+host}.

The command-\/line options {\ttfamily -\/-\/s3\+\_\+host=staging} or {\ttfamily -\/-\/s3\+\_\+host=production} override the default. If {\ttfamily s3\+\_\+host} is present and not {\ttfamily staging} or {\ttfamily production} an exception is thrown.

This allows installing from staging by specifying {\ttfamily -\/-\/s3\+\_\+host=staging}. And it requires specifying {\ttfamily -\/-\/s3\+\_\+option=production} in order to publish to, or unpublish from, production, making accidental errors less likely.\hypertarget{README.md_autotoc_md4852}{}\doxysubsection{\texorpdfstring{Node-\/\+API Considerations}{Node-\/\+API Considerations}}\label{README.md_autotoc_md4852}
\href{https://nodejs.org/api/n-api.html\#n_api_node_api}{\texttt{ Node-\/\+API}}, which was previously known as N-\/\+API, is an ABI-\/stable alternative to previous technologies such as \href{https://github.com/nodejs/nan}{\texttt{ nan}} which are tied to a specific Node runtime engine. Node-\/\+API is Node runtime engine agnostic and guarantees modules created today will continue to run, without changes, into the future.

Using {\ttfamily node-\/pre-\/gyp} with Node-\/\+API projects requires a handful of additional configuration values and imposes some additional requirements.

The most significant difference is that an Node-\/\+API module can be coded to target multiple Node-\/\+API versions. Therefore, an Node-\/\+API module must declare in its {\ttfamily package.\+json} file which Node-\/\+API versions the module is designed to run against. In addition, since multiple builds may be required for a single module, path and file names must be specified in way that avoids naming conflicts.\hypertarget{README.md_autotoc_md4853}{}\doxysubsubsection{\texorpdfstring{The {\ttfamily napi\+\_\+versions} array property}{The {\ttfamily napi\+\_\+versions} array property}}\label{README.md_autotoc_md4853}
A Node-\/\+API module must declare in its {\ttfamily package.\+json} file, the Node-\/\+API versions the module is intended to support. This is accomplished by including an {\ttfamily napi-\/versions} array property in the {\ttfamily binary} object. For example\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{"{}binary"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}module\_name"{}:\ "{}your\_module"{},}
\DoxyCodeLine{\ \ \ \ "{}module\_path"{}:\ "{}your\_module\_path"{},}
\DoxyCodeLine{\ \ \ \ "{}host"{}:\ "{}https://your\_bucket.s3-\/us-\/west-\/1.amazonaws.com"{},}
\DoxyCodeLine{\ \ \ \ "{}napi\_versions"{}:\ [1,3]}
\DoxyCodeLine{\ \ \}}

\end{DoxyCode}


If the {\ttfamily napi\+\_\+versions} array property is {\itshape not} present, {\ttfamily node-\/pre-\/gyp} operates as it always has. Including the {\ttfamily napi\+\_\+versions} array property instructs {\ttfamily node-\/pre-\/gyp} that this is a Node-\/\+API module build.

When the {\ttfamily napi\+\_\+versions} array property is present, {\ttfamily node-\/pre-\/gyp} fires off multiple operations, one for each of the Node-\/\+API versions in the array. In the example above, two operations are initiated, one for Node-\/\+API version 1 and second for Node-\/\+API version 3. How this version number is communicated is described next.\hypertarget{README.md_autotoc_md4854}{}\doxysubsubsection{\texorpdfstring{The {\ttfamily napi\+\_\+build\+\_\+version} value}{The {\ttfamily napi\+\_\+build\+\_\+version} value}}\label{README.md_autotoc_md4854}
For each of the Node-\/\+API module operations {\ttfamily node-\/pre-\/gyp} initiates, it ensures that the {\ttfamily napi\+\_\+build\+\_\+version} is set appropriately.

This value is of importance in two areas\+:


\begin{DoxyEnumerate}
\item The C/\+C++ code which needs to know against which Node-\/\+API version it should compile.
\item {\ttfamily node-\/pre-\/gyp} itself which must assign appropriate path and file names to avoid collisions.
\end{DoxyEnumerate}\hypertarget{README.md_autotoc_md4855}{}\doxysubsubsection{\texorpdfstring{Defining {\ttfamily NAPI\+\_\+\+VERSION} for the C/\+C++ code}{Defining {\ttfamily NAPI\+\_\+\+VERSION} for the C/\+C++ code}}\label{README.md_autotoc_md4855}
The {\ttfamily napi\+\_\+build\+\_\+version} value is communicated to the C/\+C++ code by adding this code to the {\ttfamily binding.\+gyp} file\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{"{}defines"{}:\ [}
\DoxyCodeLine{\ \ \ \ "{}NAPI\_VERSION=<(napi\_build\_version)"{},}
\DoxyCodeLine{]}

\end{DoxyCode}


This ensures that {\ttfamily NAPI\+\_\+\+VERSION}, an integer value, is declared appropriately to the C/\+C++ code for each build.

\begin{quote}
Note that earlier versions of this document recommended defining the symbol {\ttfamily NAPI\+\_\+\+BUILD\+\_\+\+VERSION}. {\ttfamily NAPI\+\_\+\+VERSION} is preferred because it used by the Node-\/\+API C/\+C++ headers to configure the specific Node-\/\+API versions being requested. \end{quote}
\hypertarget{README.md_autotoc_md4856}{}\doxysubsubsection{\texorpdfstring{Path and file naming requirements in {\ttfamily package.\+json}}{Path and file naming requirements in {\ttfamily package.\+json}}}\label{README.md_autotoc_md4856}
Since {\ttfamily node-\/pre-\/gyp} fires off multiple operations for each request, it is essential that path and file names be created in such a way as to avoid collisions. This is accomplished by imposing additional path and file naming requirements.

Specifically, when performing Node-\/\+API builds, the {\ttfamily \{napi\+\_\+build\+\_\+version\}} text configuration value {\itshape must} be present in the {\ttfamily module\+\_\+path} property. In addition, the {\ttfamily \{napi\+\_\+build\+\_\+version\}} text configuration value {\itshape must} be present in either the {\ttfamily remote\+\_\+path} or {\ttfamily package\+\_\+name} property. (No problem if it\textquotesingle{}s in both.)

Here\textquotesingle{}s an example\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{"{}binary"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}module\_name"{}:\ "{}your\_module"{},}
\DoxyCodeLine{\ \ \ \ "{}module\_path"{}:\ "{}./lib/binding/napi-\/v\{napi\_build\_version\}"{},}
\DoxyCodeLine{\ \ \ \ "{}remote\_path"{}:\ "{}./\{module\_name\}/v\{version\}/\{configuration\}/"{},}
\DoxyCodeLine{\ \ \ \ "{}package\_name"{}:\ "{}\{platform\}-\/\{arch\}-\/napi-\/v\{napi\_build\_version\}.tar.gz"{},}
\DoxyCodeLine{\ \ \ \ "{}host"{}:\ "{}https://your\_bucket.s3-\/us-\/west-\/1.amazonaws.com"{},}
\DoxyCodeLine{\ \ \ \ "{}napi\_versions"{}:\ [1,3]}
\DoxyCodeLine{\ \ \}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md4857}{}\doxysubsection{\texorpdfstring{Supporting both Node-\/\+API and NAN builds}{Supporting both Node-\/\+API and NAN builds}}\label{README.md_autotoc_md4857}
You may have a legacy native add-\/on that you wish to continue supporting for those versions of Node that do not support Node-\/\+API, as you add Node-\/\+API support for later Node versions. This can be accomplished by specifying the {\ttfamily node\+\_\+napi\+\_\+label} configuration value in the package.\+json {\ttfamily binary.\+package\+\_\+name} property.

Placing the configuration value {\ttfamily node\+\_\+napi\+\_\+label} in the package.\+json {\ttfamily binary.\+package\+\_\+name} property instructs {\ttfamily node-\/pre-\/gyp} to build all viable Node-\/\+API binaries supported by the current Node instance. If the current Node instance does not support Node-\/\+API, {\ttfamily node-\/pre-\/gyp} will request a traditional, non-\/\+Node-\/\+API build.

The configuration value {\ttfamily node\+\_\+napi\+\_\+label} is set by {\ttfamily node-\/pre-\/gyp} to the type of build created, {\ttfamily napi} or {\ttfamily node}, and the version number. For Node-\/\+API builds, the string contains the Node-\/\+API version nad has values like {\ttfamily napi-\/v3}. For traditional, non-\/\+Node-\/\+API builds, the string contains the ABI version with values like {\ttfamily node-\/v46}.

Here\textquotesingle{}s how the {\ttfamily binary} configuration above might be changed to support both Node-\/\+API and NAN builds\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{"{}binary"{}:\ \{}
\DoxyCodeLine{\ \ \ \ "{}module\_name"{}:\ "{}your\_module"{},}
\DoxyCodeLine{\ \ \ \ "{}module\_path"{}:\ "{}./lib/binding/\{node\_napi\_label\}"{},}
\DoxyCodeLine{\ \ \ \ "{}remote\_path"{}:\ "{}./\{module\_name\}/v\{version\}/\{configuration\}/"{},}
\DoxyCodeLine{\ \ \ \ "{}package\_name"{}:\ "{}\{platform\}-\/\{arch\}-\/\{node\_napi\_label\}.tar.gz"{},}
\DoxyCodeLine{\ \ \ \ "{}host"{}:\ "{}https://your\_bucket.s3-\/us-\/west-\/1.amazonaws.com"{},}
\DoxyCodeLine{\ \ \ \ "{}napi\_versions"{}:\ [1,3]}
\DoxyCodeLine{\ \ \}}

\end{DoxyCode}


The C/\+C++ symbol {\ttfamily NAPI\+\_\+\+VERSION} can be used to distinguish Node-\/\+API and non-\/\+Node-\/\+API builds. The value of {\ttfamily NAPI\+\_\+\+VERSION} is set to the integer Node-\/\+API version for Node-\/\+API builds and is set to {\ttfamily 0} for non-\/\+Node-\/\+API builds.

For example\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#if\ NAPI\_VERSION}}
\DoxyCodeLine{\textcolor{comment}{//\ Node-\/API\ code\ goes\ here}}
\DoxyCodeLine{\textcolor{preprocessor}{\#else}}
\DoxyCodeLine{\textcolor{comment}{//\ NAN\ code\ goes\ here}}
\DoxyCodeLine{\textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md4858}{}\doxysubsubsection{\texorpdfstring{Two additional configuration values}{Two additional configuration values}}\label{README.md_autotoc_md4858}
The following two configuration values, which were implemented in previous versions of {\ttfamily node-\/pre-\/gyp}, continue to exist, but have been replaced by the {\ttfamily node\+\_\+napi\+\_\+label} configuration value described above.


\begin{DoxyEnumerate}
\item {\ttfamily napi\+\_\+version} If Node-\/\+API is supported by the currently executing Node instance, this value is the Node-\/\+API version number supported by Node. If Node-\/\+API is not supported, this value is an empty string.
\item {\ttfamily node\+\_\+abi\+\_\+napi} If the value returned for {\ttfamily napi\+\_\+version} is non empty, this value is `\textquotesingle{}napi'{\ttfamily . If the value returned for}napi\+\_\+version{\ttfamily is empty, this value is the value returned for}node\+\_\+abi\`{}.
\end{DoxyEnumerate}

These values are present for use in the {\ttfamily binding.\+gyp} file and may be used as {\ttfamily \{napi\+\_\+version\}} and {\ttfamily \{node\+\_\+abi\+\_\+napi\}} for text substitution in the {\ttfamily binary} properties of the {\ttfamily package.\+json} file.\hypertarget{README.md_autotoc_md4859}{}\doxysubsection{\texorpdfstring{S3 Hosting}{S3 Hosting}}\label{README.md_autotoc_md4859}
You can host wherever you choose but S3 is cheap, {\ttfamily node-\/pre-\/gyp publish} expects it, and S3 can be integrated well with \href{http://travis-ci.org}{\texttt{ Travis.\+ci}} to automate builds for OS X and Ubuntu, and with \href{http://appveyor.com}{\texttt{ Appveyor}} to automate builds for Windows. Here is an approach to do this\+:

First, get setup locally and test the workflow\+:\hypertarget{README.md_autotoc_md4860}{}\doxysubsubsubsection{\texorpdfstring{1) Create an S3 bucket}{1) Create an S3 bucket}}\label{README.md_autotoc_md4860}
And have your {\bfseries{key}} and {\bfseries{secret key}} ready for writing to the bucket.

It is recommended to create a IAM user with a policy that only gives permissions to the specific bucket you plan to publish to. This can be done in the \href{https://console.aws.amazon.com/iam/}{\texttt{ IAM console}} by\+: 1) adding a new user, 2) choosing {\ttfamily Attach User Policy}, 3) Using the {\ttfamily Policy Generator}, 4) selecting {\ttfamily Amazon S3} for the service, 5) adding the actions\+: {\ttfamily Delete\+Object}, {\ttfamily Get\+Object}, {\ttfamily Get\+Object\+Acl}, {\ttfamily List\+Bucket}, {\ttfamily Head\+Bucket}, {\ttfamily Put\+Object}, {\ttfamily Put\+Object\+Acl}, 6) adding an ARN of {\ttfamily arn\+:aws\+:s3\+:\+::bucket/\texorpdfstring{$\ast$}{*}} (replacing {\ttfamily bucket} with your bucket name), and finally 7) clicking {\ttfamily Add Statement} and saving the policy. It should generate a policy like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ "{}Version"{}:\ "{}2012-\/10-\/17"{},}
\DoxyCodeLine{\ \ \ \ "{}Statement"{}:\ [}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Sid"{}:\ "{}objects"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Effect"{}:\ "{}Allow"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Action"{}:\ [}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}s3:PutObject"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}s3:GetObjectAcl"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}s3:GetObject"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}s3:DeleteObject"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ "{}s3:PutObjectAcl"{}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ ],}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Resource"{}:\ "{}arn:aws:s3:::your-\/bucket-\/name/*"{}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Sid"{}:\ "{}bucket"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Effect"{}:\ "{}Allow"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Action"{}:\ "{}s3:ListBucket"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Resource"{}:\ "{}arn:aws:s3:::your-\/bucket-\/name"{}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Sid"{}:\ "{}buckets"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Effect"{}:\ "{}Allow"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Action"{}:\ "{}s3:HeadBucket"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ "{}Resource"{}:\ "{}*"{}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ ]}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md4861}{}\doxysubsubsubsection{\texorpdfstring{2) Install node-\/pre-\/gyp}{2) Install node-\/pre-\/gyp}}\label{README.md_autotoc_md4861}
Either install it globally\+: \begin{DoxyVerb}npm install node-pre-gyp -g
\end{DoxyVerb}


Or put the local version on your PATH \begin{DoxyVerb}export PATH=`pwd`/node_modules/.bin/:$PATH
\end{DoxyVerb}
\hypertarget{README.md_autotoc_md4862}{}\doxysubsubsubsection{\texorpdfstring{3) Configure AWS credentials}{3) Configure AWS credentials}}\label{README.md_autotoc_md4862}
It is recommended to configure the AWS JS SDK v2 used internally by {\ttfamily node-\/pre-\/gyp} by setting these environment variables\+:


\begin{DoxyItemize}
\item AWS\+\_\+\+ACCESS\+\_\+\+KEY\+\_\+\+ID
\item AWS\+\_\+\+SECRET\+\_\+\+ACCESS\+\_\+\+KEY
\end{DoxyItemize}

But also you can also use the {\ttfamily Shared Config File} mentioned \href{https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/configuring-the-jssdk.html}{\texttt{ in the AWS JS SDK v2 docs}}\hypertarget{README.md_autotoc_md4863}{}\doxysubsubsubsection{\texorpdfstring{4) Package and publish your build}{4) Package and publish your build}}\label{README.md_autotoc_md4863}
Install the {\ttfamily aws-\/sdk}\+: \begin{DoxyVerb}npm install aws-sdk
\end{DoxyVerb}


Then publish\+: \begin{DoxyVerb}node-pre-gyp package publish
\end{DoxyVerb}


Note\+: if you hit an error like {\ttfamily Hostname/\+IP doesn\textquotesingle{}t match certificate\textquotesingle{}s altnames} it may mean that you need to provide the {\ttfamily region} option in your config.\hypertarget{README.md_autotoc_md4864}{}\doxysubsection{\texorpdfstring{Appveyor Automation}{Appveyor Automation}}\label{README.md_autotoc_md4864}
\href{http://www.appveyor.com/}{\texttt{ Appveyor}} can build binaries and publish the results per commit and supports\+:


\begin{DoxyItemize}
\item Windows Visual Studio 2013 and related compilers
\item Both 64 bit (x64) and 32 bit (x86) build configurations
\item Multiple Node.\+js versions
\end{DoxyItemize}

For an example of doing this see \href{https://github.com/mapbox/node-sqlite3/blob/master/appveyor.yml}{\texttt{ node-\/sqlite3\textquotesingle{}s appveyor.\+yml}}.

Below is a guide to getting set up\+:\hypertarget{README.md_autotoc_md4865}{}\doxysubsubsubsection{\texorpdfstring{1) Create a free Appveyor account}{1) Create a free Appveyor account}}\label{README.md_autotoc_md4865}
Go to \href{https://ci.appveyor.com/signup/free}{\texttt{ https\+://ci.\+appveyor.\+com/signup/free}} and sign in with your Git\+Hub account.\hypertarget{README.md_autotoc_md4866}{}\doxysubsubsubsection{\texorpdfstring{2) Create a new project}{2) Create a new project}}\label{README.md_autotoc_md4866}
Go to \href{https://ci.appveyor.com/projects/new}{\texttt{ https\+://ci.\+appveyor.\+com/projects/new}} and select the Git\+Hub repo for your module\hypertarget{README.md_autotoc_md4867}{}\doxysubsubsubsection{\texorpdfstring{3) Add appveyor.\+yml and push it}{3) Add appveyor.\+yml and push it}}\label{README.md_autotoc_md4867}
Once you have committed an {\ttfamily appveyor.\+yml} (\href{http://www.appveyor.com/docs/appveyor-yml}{\texttt{ appveyor.\+yml reference}}) to your Git\+Hub repo and pushed it App\+Veyor should automatically start building your project.\hypertarget{README.md_autotoc_md4868}{}\doxysubsubsubsection{\texorpdfstring{4) Create secure variables}{4) Create secure variables}}\label{README.md_autotoc_md4868}
Encrypt your S3 AWS keys by going to \href{https://ci.appveyor.com/tools/encrypt}{\texttt{ https\+://ci.\+appveyor.\+com/tools/encrypt}} and hitting the {\ttfamily encrypt} button.

Then paste the result into your {\ttfamily appveyor.\+yml}


\begin{DoxyCode}{0}
\DoxyCodeLine{environment:}
\DoxyCodeLine{\ \ AWS\_ACCESS\_KEY\_ID:}
\DoxyCodeLine{\ \ \ \ secure:\ Dn9HKdLNYvDgPdQOzRq/DqZ/MPhjknRHB1o+/lVU8MA=}
\DoxyCodeLine{\ \ AWS\_SECRET\_ACCESS\_KEY:}
\DoxyCodeLine{\ \ \ \ secure:\ W1rwNoSnOku1r+28gnoufO8UA8iWADmL1LiiwH9IOkIVhDTNGdGPJqAlLjNqwLnL}

\end{DoxyCode}


NOTE\+: keys are per account but not per repo (this is difference than Travis where keys are per repo but not related to the account used to encrypt them).\hypertarget{README.md_autotoc_md4869}{}\doxysubsubsubsection{\texorpdfstring{5) Hook up publishing}{5) Hook up publishing}}\label{README.md_autotoc_md4869}
Just put {\ttfamily node-\/pre-\/gyp package publish} in your {\ttfamily appveyor.\+yml} after {\ttfamily npm install}.\hypertarget{README.md_autotoc_md4870}{}\doxysubsubsubsection{\texorpdfstring{6) Publish when you want}{6) Publish when you want}}\label{README.md_autotoc_md4870}
You might wish to publish binaries only on a specific commit. To do this you could borrow from the \href{http://about.travis-ci.org/docs/user/how-to-skip-a-build/}{\texttt{ Travis CI idea of commit keywords}} and add special handling for commit messages with {\ttfamily \mbox{[}publish binary\mbox{]}}\+: \begin{DoxyVerb}SET CM=%APPVEYOR_REPO_COMMIT_MESSAGE%
if not "%CM%" == "%CM:[publish binary]=%" node-pre-gyp --msvs_version=2013 publish
\end{DoxyVerb}


If your commit message contains special characters (e.\+g. {\ttfamily \&}) this method might fail. An alternative is to use Power\+Shell, which gives you additional possibilities, like ignoring case by using {\ttfamily To\+Lower()}\+: \begin{DoxyVerb}ps: if($env:APPVEYOR_REPO_COMMIT_MESSAGE.ToLower().Contains('[publish binary]')) { node-pre-gyp --msvs_version=2013 publish }
\end{DoxyVerb}


Remember this publishing is not the same as {\ttfamily npm publish}. We\textquotesingle{}re just talking about the binary module here and not your entire npm package.\hypertarget{README.md_autotoc_md4871}{}\doxysubsection{\texorpdfstring{Travis Automation}{Travis Automation}}\label{README.md_autotoc_md4871}
\href{https://travis-ci.org/}{\texttt{ Travis}} can push to S3 after a successful build and supports both\+:


\begin{DoxyItemize}
\item Ubuntu Precise and OS X (64 bit)
\item Multiple Node.\+js versions
\end{DoxyItemize}

For an example of doing this see \href{https://github.com/springmeyer/node-addon-example/blob/2ff60a8ded7f042864ad21db00c3a5a06cf47075/.travis.yml}{\texttt{ node-\/add-\/example\textquotesingle{}s .travis.\+yml}}.

Note\+: if you need 32 bit binaries, this can be done from a 64 bit Travis machine. See \href{https://github.com/mapbox/node-sqlite3/blob/bae122aa6a2b8a45f6b717fab24e207740e32b5d/scripts/build_against_node.sh\#L54-L74}{\texttt{ the node-\/sqlite3 scripts for an example of doing this}}.

Below is a guide to getting set up\+:\hypertarget{README.md_autotoc_md4872}{}\doxysubsubsubsection{\texorpdfstring{1) Install the Travis gem}{1) Install the Travis gem}}\label{README.md_autotoc_md4872}
\begin{DoxyVerb}gem install travis
\end{DoxyVerb}
\hypertarget{README.md_autotoc_md4873}{}\doxysubsubsubsection{\texorpdfstring{2) Create secure variables}{2) Create secure variables}}\label{README.md_autotoc_md4873}
Make sure you run this command from within the directory of your module.

Use {\ttfamily travis-\/encrypt} like\+: \begin{DoxyVerb}travis encrypt AWS_ACCESS_KEY_ID=${node_pre_gyp_accessKeyId}
travis encrypt AWS_SECRET_ACCESS_KEY=${node_pre_gyp_secretAccessKey}
\end{DoxyVerb}


Then put those values in your {\ttfamily .travis.\+yml} like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{env:}
\DoxyCodeLine{\ \ global:}
\DoxyCodeLine{\ \ \ \ -\/\ secure:\ F+sEL/v56CzHqmCSSES4pEyC9NeQlkoR0Gs/ZuZxX1ytrj8SKtp3MKqBj7zhIclSdXBz4Ev966Da5ctmcTd410p0b240MV6BVOkLUtkjZJyErMBOkeb8n8yVfSoeMx8RiIhBmIvEn+rlQq+bSFis61/JkE9rxsjkGRZi14hHr4M=}
\DoxyCodeLine{\ \ \ \ -\/\ secure:\ o2nkUQIiABD139XS6L8pxq3XO5gch27hvm/gOdV+dzNKc/s2KomVPWcOyXNxtJGhtecAkABzaW8KHDDi5QL1kNEFx6BxFVMLO8rjFPsMVaBG9Ks6JiDQkkmrGNcnVdxI/6EKTLHTH5WLsz8+J7caDBzvKbEfTux5EamEhxIWgrI=}

\end{DoxyCode}


More details on Travis encryption at \href{http://about.travis-ci.org/docs/user/encryption-keys/}{\texttt{ http\+://about.\+travis-\/ci.\+org/docs/user/encryption-\/keys/}}.\hypertarget{README.md_autotoc_md4874}{}\doxysubsubsubsection{\texorpdfstring{3) Hook up publishing}{3) Hook up publishing}}\label{README.md_autotoc_md4874}
Just put {\ttfamily node-\/pre-\/gyp package publish} in your {\ttfamily .travis.\+yml} after {\ttfamily npm install}.\hypertarget{README.md_autotoc_md4875}{}\doxysubsubsubsubsection{\texorpdfstring{OS X publishing}{OS X publishing}}\label{README.md_autotoc_md4875}
If you want binaries for OS X in addition to linux you can enable \href{http://docs.travis-ci.com/user/multi-os/\#Setting-.travis.yml}{\texttt{ multi-\/os for Travis}}

Use a configuration like\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{language:\ cpp}
\DoxyCodeLine{}
\DoxyCodeLine{os:}
\DoxyCodeLine{-\/\ linux}
\DoxyCodeLine{-\/\ osx}
\DoxyCodeLine{}
\DoxyCodeLine{env:}
\DoxyCodeLine{\ \ matrix:}
\DoxyCodeLine{\ \ \ \ -\/\ NODE\_VERSION="{}4"{}}
\DoxyCodeLine{\ \ \ \ -\/\ NODE\_VERSION="{}6"{}}
\DoxyCodeLine{}
\DoxyCodeLine{before\_install:}
\DoxyCodeLine{-\/\ rm\ -\/rf\ \string~/.nvm/\ \&\&\ git\ clone\ -\/-\/depth\ 1\ https://github.com/creationix/nvm.git\ \string~/.nvm}
\DoxyCodeLine{-\/\ source\ \string~/.nvm/nvm.sh}
\DoxyCodeLine{-\/\ nvm\ install\ \$NODE\_VERSION}
\DoxyCodeLine{-\/\ nvm\ use\ \$NODE\_VERSION}

\end{DoxyCode}


See Travis OS X Gotchas for why we replace {\ttfamily language\+: node\+\_\+js} and {\ttfamily node\+\_\+js\+:} sections with {\ttfamily language\+: cpp} and a custom matrix.

Also create platform specific sections for any deps that need install. For example if you need libpng\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{-\/\ if\ [\ \$(uname\ -\/s)\ ==\ 'Linux'\ ];\ then\ apt-\/get\ install\ libpng-\/dev;\ fi;}
\DoxyCodeLine{-\/\ if\ [\ \$(uname\ -\/s)\ ==\ 'Darwin'\ ];\ then\ brew\ install\ libpng;\ fi;}

\end{DoxyCode}


For detailed multi-\/\+OS examples see \href{https://github.com/mapnik/node-mapnik/blob/master/.travis.yml}{\texttt{ node-\/mapnik}} and \href{https://github.com/mapbox/node-sqlite3/blob/master/.travis.yml}{\texttt{ node-\/sqlite3}}.\hypertarget{README.md_autotoc_md4876}{}\doxysubsubsubsubsection{\texorpdfstring{Travis OS X Gotchas}{Travis OS X Gotchas}}\label{README.md_autotoc_md4876}
First, unlike the Travis Linux machines, the OS X machines do not put {\ttfamily node-\/pre-\/gyp} on PATH by default. To do so you will need to\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{export\ PATH=\$(pwd)/node\_modules/.bin:\$\{PATH\}}

\end{DoxyCode}


Second, the OS X machines do not support using a matrix for installing different Node.\+js versions. So you need to bootstrap the installation of Node.\+js in a cross platform way.

By doing\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{env:}
\DoxyCodeLine{\ \ matrix:}
\DoxyCodeLine{\ \ \ \ -\/\ NODE\_VERSION="{}4"{}}
\DoxyCodeLine{\ \ \ \ -\/\ NODE\_VERSION="{}6"{}}
\DoxyCodeLine{}
\DoxyCodeLine{before\_install:}
\DoxyCodeLine{\ -\/\ rm\ -\/rf\ \string~/.nvm/\ \&\&\ git\ clone\ -\/-\/depth\ 1\ https://github.com/creationix/nvm.git\ \string~/.nvm}
\DoxyCodeLine{\ -\/\ source\ \string~/.nvm/nvm.sh}
\DoxyCodeLine{\ -\/\ nvm\ install\ \$NODE\_VERSION}
\DoxyCodeLine{\ -\/\ nvm\ use\ \$NODE\_VERSION}

\end{DoxyCode}


You can easily recreate the previous behavior of this matrix\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{node\_js:}
\DoxyCodeLine{\ \ -\/\ "{}4"{}}
\DoxyCodeLine{\ \ -\/\ "{}6"{}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md4877}{}\doxysubsubsubsection{\texorpdfstring{4) Publish when you want}{4) Publish when you want}}\label{README.md_autotoc_md4877}
You might wish to publish binaries only on a specific commit. To do this you could borrow from the \href{http://about.travis-ci.org/docs/user/how-to-skip-a-build/}{\texttt{ Travis CI idea of commit keywords}} and add special handling for commit messages with {\ttfamily \mbox{[}publish binary\mbox{]}}\+: \begin{DoxyVerb}COMMIT_MESSAGE=$(git log --format=%B --no-merges -n 1 | tr -d '\n')
if [[ ${COMMIT_MESSAGE} =~ "[publish binary]" ]]; then node-pre-gyp publish; fi;
\end{DoxyVerb}


Then you can trigger new binaries to be built like\+: \begin{DoxyVerb}git commit -a -m "[publish binary]"
\end{DoxyVerb}


Or, if you don\textquotesingle{}t have any changes to make simply run\+: \begin{DoxyVerb}git commit --allow-empty -m "[publish binary]"
\end{DoxyVerb}


WARNING\+: if you are working in a pull request and publishing binaries from there then you will want to avoid double publishing when Travis CI builds both the {\ttfamily push} and {\ttfamily pr}. You only want to run the publish on the {\ttfamily push} commit. See \href{https://github.com/Project-OSRM/node-osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/is_pr_merge.sh}{\texttt{ https\+://github.\+com/\+Project-\/\+OSRM/node-\/osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/is\+\_\+pr\+\_\+merge.\+sh}} which is called from \href{https://github.com/Project-OSRM/node-osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/publish.sh}{\texttt{ https\+://github.\+com/\+Project-\/\+OSRM/node-\/osrm/blob/8eb837abe2e2e30e595093d16e5354bc5c573575/scripts/publish.\+sh}} for an example of how to do this.

Remember this publishing is not the same as {\ttfamily npm publish}. We\textquotesingle{}re just talking about the binary module here and not your entire npm package. To automate the publishing of your entire package to npm on Travis see \href{http://about.travis-ci.org/docs/user/deployment/npm/}{\texttt{ http\+://about.\+travis-\/ci.\+org/docs/user/deployment/npm/}}\hypertarget{README.md_autotoc_md4878}{}\doxysubsection{\texorpdfstring{Versioning}{Versioning}}\label{README.md_autotoc_md4878}
The {\ttfamily binary} properties of {\ttfamily module\+\_\+path}, {\ttfamily remote\+\_\+path}, and {\ttfamily package\+\_\+name} support variable substitution. The strings are evaluated by {\ttfamily node-\/pre-\/gyp} depending on your system and any custom build flags you passed.


\begin{DoxyItemize}
\item {\ttfamily node\+\_\+abi}\+: The node C++ {\ttfamily ABI} number. This value is available in Javascript as {\ttfamily process.\+versions.\+modules} as of \href{https://github.com/joyent/node/commit/ccabd4a6fa8a6eb79d29bc3bbe9fe2b6531c2d8e}{\texttt{ {\ttfamily \texorpdfstring{$>$}{>}= v0.\+10.\+4 \texorpdfstring{$>$}{>}= v0.\+11.\+7}}} and in C++ as the {\ttfamily NODE\+\_\+\+MODULE\+\_\+\+VERSION} define much earlier. For versions of Node before this was available we fallback to the V8 major and minor version.
\item {\ttfamily platform} matches node\textquotesingle{}s {\ttfamily process.\+platform} like {\ttfamily linux}, {\ttfamily darwin}, and {\ttfamily win32} unless the user passed the {\ttfamily -\/-\/target\+\_\+platform} option to override.
\item {\ttfamily arch} matches node\textquotesingle{}s {\ttfamily process.\+arch} like {\ttfamily x64} or {\ttfamily ia32} unless the user passes the {\ttfamily -\/-\/target\+\_\+arch} option to override.
\item {\ttfamily libc} matches `require(\textquotesingle{}detect-\/libc').family{\ttfamily like}glibc{\ttfamily or}musl{\ttfamily unless the user passes the}--target\+\_\+libc{\ttfamily option to override. -\/}configuration` -\/ Either \textquotesingle{}Release' or \textquotesingle{}Debug\textquotesingle{} depending on if {\ttfamily -\/-\/debug} is passed during the build.
\item {\ttfamily module\+\_\+name} -\/ the {\ttfamily binary.\+module\+\_\+name} attribute from {\ttfamily package.\+json}.
\item {\ttfamily version} -\/ the semver {\ttfamily version} value for your module from {\ttfamily package.\+json} (NOTE\+: ignores the {\ttfamily semver.\+build} property).
\item {\ttfamily major}, {\ttfamily minor}, {\ttfamily patch}, and {\ttfamily prelease} match the individual semver values for your module\textquotesingle{}s {\ttfamily version}
\item {\ttfamily build} -\/ the sevmer {\ttfamily build} value. For example it would be {\ttfamily this.\+that} if your package.\+json {\ttfamily version} was {\ttfamily v1.\+0.\+0+this.\+that}
\item {\ttfamily prerelease} -\/ the semver {\ttfamily prerelease} value. For example it would be {\ttfamily alpha.\+beta} if your package.\+json {\ttfamily version} was {\ttfamily v1.\+0.\+0-\/alpha.\+beta}
\end{DoxyItemize}

The options are visible in the code at \href{https://github.com/mapbox/node-pre-gyp/blob/612b7bca2604508d881e1187614870ba19a7f0c5/lib/util/versioning.js\#L114-L127}{\texttt{ https\+://github.\+com/mapbox/node-\/pre-\/gyp/blob/612b7bca2604508d881e1187614870ba19a7f0c5/lib/util/versioning.\+js\#\+L114-\/\+L127}}\hypertarget{README.md_autotoc_md4879}{}\doxysubsection{\texorpdfstring{Download binary files from a mirror}{Download binary files from a mirror}}\label{README.md_autotoc_md4879}
S3 is broken in China for the well known reason.

Using the {\ttfamily npm} config argument\+: {\ttfamily -\/-\/\{module\+\_\+name\}\+\_\+binary\+\_\+host\+\_\+mirror} can download binary files through a mirror, {\ttfamily -\/} in {\ttfamily module\+\_\+name} will be replaced with {\ttfamily \+\_\+}.

e.\+g.\+: Install \href{https://www.npmjs.com/package/v8-profiler}{\texttt{ v8-\/profiler}} from {\ttfamily npm}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\$\ npm\ install\ v8-\/profiler\ -\/-\/profiler\_binary\_host\_mirror=https://npm.taobao.org/mirrors/node-\/inspector/}

\end{DoxyCode}


e.\+g.\+: Install \href{https://www.npmjs.com/package/canvas-prebuilt}{\texttt{ canvas-\/prebuilt}} from {\ttfamily npm}.


\begin{DoxyCode}{0}
\DoxyCodeLine{\$\ npm\ install\ canvas-\/prebuilt\ -\/-\/canvas\_prebuilt\_binary\_host\_mirror=https://npm.taobao.org/mirrors/canvas-\/prebuilt/}

\end{DoxyCode}
 