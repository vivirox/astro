\doxysection{node\+\_\+modules/async-\/sema Directory Reference}
\hypertarget{dir_bd1a4967581b0d683c2110a4e2f0775e}{}\label{dir_bd1a4967581b0d683c2110a4e2f0775e}\index{node\_modules/async-\/sema Directory Reference@{node\_modules/async-\/sema Directory Reference}}


\doxysubsection{Detailed Description}
This is a semaphore implementation for use with {\ttfamily async} and {\ttfamily await}. The implementation follows the traditional definition of a semaphore rather than the definition of an asynchronous semaphore seen in some js community examples. Where as the latter one generally allows every defined task to proceed immediately and synchronizes at the end, async-\/sema allows only a selected number of tasks to proceed at once while the rest will remain waiting.

Async-\/sema manages the semaphore count as a list of tokens instead of a single variable containing the number of available resources. This enables an interesting application of managing the actual resources with the semaphore object itself. To make it practical the constructor for Sema includes an option for providing an init function for the semaphore tokens. Use of a custom token initializer is demonstrated in {\ttfamily examples/pooling.\+js}.\hypertarget{readme.md_autotoc_md8504}{}\doxysubsection{\texorpdfstring{Usage}{Usage}}\label{readme.md_autotoc_md8504}
Firstly, add the package to your project\textquotesingle{}s {\ttfamily dependencies}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{npm\ install\ -\/-\/save\ async-\/sema}

\end{DoxyCode}


or


\begin{DoxyCode}{0}
\DoxyCodeLine{yarn\ add\ async-\/sema}

\end{DoxyCode}


Then start using it like shown in the following example. Check more use case examples \href{./examples}{\texttt{ here}}.\hypertarget{readme.md_autotoc_md8505}{}\doxysubsection{\texorpdfstring{Example}{Example}}\label{readme.md_autotoc_md8505}

\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{\ Sema\ \}\ =\ require('async-\/sema');}
\DoxyCodeLine{const\ s\ =\ new\ Sema(}
\DoxyCodeLine{\ \ 4,\ //\ Allow\ 4\ concurrent\ async\ calls}
\DoxyCodeLine{\ \ \{}
\DoxyCodeLine{\ \ \ \ capacity:\ 100\ //\ Prealloc\ space\ for\ 100\ tokens}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{);}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ fetchData(x)\ \{}
\DoxyCodeLine{\ \ await\ s.acquire()}
\DoxyCodeLine{\ \ try\ \{}
\DoxyCodeLine{\ \ \ \ console.log(s.nrWaiting()\ +\ '\ calls\ to\ fetch\ are\ waiting')}
\DoxyCodeLine{\ \ \ \ //\ ...\ do\ some\ async\ stuff\ with\ x}
\DoxyCodeLine{\ \ \}\ finally\ \{}
\DoxyCodeLine{\ \ \ \ s.release();}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{const\ data\ =\ await\ Promise.all(array.map(fetchData));}

\end{DoxyCode}


The package also offers a simple rate limiter utilizing the semaphore implementation.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{\ RateLimit\ \}\ =\ require('async-\/sema');}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ f()\ \{}
\DoxyCodeLine{\ \ const\ lim\ =\ RateLimit(5);\ //\ rps}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ for\ (let\ i\ =\ 0;\ i\ <\ n;\ i++)\ \{}
\DoxyCodeLine{\ \ \ \ await\ lim();}
\DoxyCodeLine{\ \ \ \ //\ ...\ do\ something\ async}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{readme.md_autotoc_md8506}{}\doxysubsection{\texorpdfstring{API}{API}}\label{readme.md_autotoc_md8506}
\hypertarget{readme.md_autotoc_md8507}{}\doxysubsubsection{\texorpdfstring{Sema}{Sema}}\label{readme.md_autotoc_md8507}
\hypertarget{readme.md_autotoc_md8508}{}\doxysubsubsubsection{\texorpdfstring{Constructor(nr, \{ init\+Fn, pause\+Fn, resume\+Fn, capacity \})}{Constructor(nr, \{ init\+Fn, pause\+Fn, resume\+Fn, capacity \})}}\label{readme.md_autotoc_md8508}
Creates a semaphore object. The first argument is mandatory and the second argument is optional.


\begin{DoxyItemize}
\item {\ttfamily nr} The maximum number of callers allowed to acquire the semaphore concurrently.
\item {\ttfamily init\+Fn} Function that is used to initialize the tokens used to manage the semaphore. The default is `() =\texorpdfstring{$>$}{>} \textquotesingle{}1'{\ttfamily . -\/}pause\+Fn{\ttfamily An optional fuction that is called to opportunistically request pausing the the incoming stream of data, instead of piling up waiting promises and possibly running out of memory. See \mbox{[}examples/pausing.\+js\mbox{]}(./examples/pausing.js). -\/}resume\+Fn{\ttfamily An optional function that is called when there is room again to accept new waiters on the semaphore. This function must be declared if a}pause\+Fn{\ttfamily is declared. -\/}capacity\`{} Sets the size of the preallocated waiting list inside the semaphore. This is typically used by high performance where the developer can make a rough estimate of the number of concurrent users of a semaphore.
\end{DoxyItemize}\hypertarget{readme.md_autotoc_md8509}{}\doxysubsubsubsection{\texorpdfstring{async drain()}{async drain()}}\label{readme.md_autotoc_md8509}
Drains the semaphore and returns all the initialized tokens in an array. Draining is an ideal way to ensure there are no pending async tasks, for example before a process will terminate.\hypertarget{readme.md_autotoc_md8510}{}\doxysubsubsubsection{\texorpdfstring{nr\+Waiting()}{nr\+Waiting()}}\label{readme.md_autotoc_md8510}
Returns the number of callers waiting on the semaphore, i.\+e. the number of pending promises.\hypertarget{readme.md_autotoc_md8511}{}\doxysubsubsubsection{\texorpdfstring{try\+Acquire()}{try\+Acquire()}}\label{readme.md_autotoc_md8511}
Attempt to acquire a token from the semaphore, if one is available immediately. Otherwise, return {\ttfamily undefined}.\hypertarget{readme.md_autotoc_md8512}{}\doxysubsubsubsection{\texorpdfstring{async acquire()}{async acquire()}}\label{readme.md_autotoc_md8512}
Acquire a token from the semaphore, thus decrement the number of available execution slots. If {\ttfamily init\+Fn} is not used then the return value of the function can be discarded.\hypertarget{readme.md_autotoc_md8513}{}\doxysubsubsubsection{\texorpdfstring{release(token)}{release(token)}}\label{readme.md_autotoc_md8513}
Release the semaphore, thus increment the number of free execution slots. If {\ttfamily init\+Fn} is used then the {\ttfamily token} returned by {\ttfamily acquire()} should be given as an argument when calling this function.\hypertarget{readme.md_autotoc_md8514}{}\doxysubsubsection{\texorpdfstring{Rate\+Limit(rps, \{ time\+Unit, uniform\+Distribution \})}{Rate\+Limit(rps, \{ time\+Unit, uniform\+Distribution \})}}\label{readme.md_autotoc_md8514}
Creates a rate limiter function that blocks with a promise whenever the rate limit is hit and resolves the promise once the call rate is within the limit set by {\ttfamily rps}. The second argument is optional.

The {\ttfamily time\+Unit} is an optional argument setting the width of the rate limiting window in milliseconds. The default {\ttfamily time\+Unit} is {\ttfamily 1000 ms}, therefore making the {\ttfamily rps} argument act as requests per second limit.

The {\ttfamily uniform\+Distribution} argument enforces a discrete uniform distribution over time, instead of the default that allows hitting the function {\ttfamily rps} time and then pausing for {\ttfamily time\+Window} milliseconds. Setting the {\ttfamily uniform\+Distribution} option is mainly useful in a situation where the flow of rate limit function calls is continuous and and occuring faster than {\ttfamily time\+Unit} (e.\+g. reading a file) and not enabling it would cause the maximum number of calls to resolve immediately (thus exhaust the limit immediately) and therefore the next bunch calls would need to wait for {\ttfamily time\+Window} milliseconds. However if the flow is sparse then this option may make the code run slower with no advantages.\hypertarget{readme.md_autotoc_md8515}{}\doxysubsection{\texorpdfstring{Contributing}{Contributing}}\label{readme.md_autotoc_md8515}

\begin{DoxyEnumerate}
\item \href{https://help.github.com/articles/fork-a-repo/}{\texttt{ Fork}} this repository to your own Git\+Hub account and then \href{https://help.github.com/articles/cloning-a-repository/}{\texttt{ clone}} it to your local device
\item Move into the directory of the clone\+: {\ttfamily cd async-\/sema}
\item Link it to the global module directory of Node.\+js\+: {\ttfamily npm link}
\end{DoxyEnumerate}

Inside the project where you want to test your clone of the package, you can now either use {\ttfamily npm link async-\/sema} to link the clone to the local dependencies.\hypertarget{readme.md_autotoc_md8516}{}\doxysubsection{\texorpdfstring{Author}{Author}}\label{readme.md_autotoc_md8516}
Olli Vanhoja (\href{https://twitter.com/OVanhoja}{\texttt{ @\+OVanhoja}}) 