\chapter{OAuth Client Quickstart}
\hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h}{}\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h}\index{OAuth Client Quickstart@{OAuth Client Quickstart}}
\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1956}%
\Hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1956}%


This document describes how to implement OAuth based authentication in a browser-\/based Single Page App (SPA), to communicate with \href{https://atproto.com}{\texttt{ atproto}} API services.\hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1957}{}\doxysection{\texorpdfstring{Prerequisites}{Prerequisites}}\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1957}

\begin{DoxyItemize}
\item You need a web server -\/ or at the very least a static file server -\/ to host your SPA.
\end{DoxyItemize}

\begin{DoxyRemark}{Remarks}
~\newline
 During development, you can use a local server to host your client metadata. You will need to use a tunneling service like \href{https://ngrok.com/}{\texttt{ ngrok}} to make your local server accessible from the internet.

~\newline
 You can use a service like \href{https://pages.github.com/}{\texttt{ Git\+Hub Pages}} to host your client metadata and SPA for free.
\end{DoxyRemark}

\begin{DoxyItemize}
\item You must be able to build and deploy a SPA to your server.
\end{DoxyItemize}\hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1958}{}\doxysection{\texorpdfstring{Step 1\+: Create your client metadata}{Step 1\+: Create your client metadata}}\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1958}
Based on your hosting server endpoint, you will first need to choose a {\ttfamily client\+\_\+id}. That {\ttfamily client\+\_\+id} will be used to identify your client to Authorization Servers. A {\ttfamily client\+\_\+id} must be a URL pointing to a JSON file which contains your client metadata. The client metadata {\bfseries{must}} contain a {\ttfamily client\+\_\+id} that is the URL used to access the metadata.

Here is an example client metadata.


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}client\_id"{}:\ "{}https://example.com/client-\/metadata.json"{},}
\DoxyCodeLine{\ \ "{}client\_name"{}:\ "{}Example\ atproto\ Browser\ App"{},}
\DoxyCodeLine{\ \ "{}client\_uri"{}:\ "{}https://example.com"{},}
\DoxyCodeLine{\ \ "{}logo\_uri"{}:\ "{}https://example.com/logo.png"{},}
\DoxyCodeLine{\ \ "{}tos\_uri"{}:\ "{}https://example.com/tos"{},}
\DoxyCodeLine{\ \ "{}policy\_uri"{}:\ "{}https://example.com/policy"{},}
\DoxyCodeLine{\ \ "{}redirect\_uris"{}:\ ["{}https://example.com/callback"{}],}
\DoxyCodeLine{\ \ "{}scope"{}:\ "{}atproto"{},}
\DoxyCodeLine{\ \ "{}grant\_types"{}:\ ["{}authorization\_code"{},\ "{}refresh\_token"{}],}
\DoxyCodeLine{\ \ "{}response\_types"{}:\ ["{}code"{}],}
\DoxyCodeLine{\ \ "{}token\_endpoint\_auth\_method"{}:\ "{}none"{},}
\DoxyCodeLine{\ \ "{}application\_type"{}:\ "{}web"{},}
\DoxyCodeLine{\ \ "{}dpop\_bound\_access\_tokens"{}:\ true}
\DoxyCodeLine{\}}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\ttfamily redirect\+\_\+uris}\+: An array of URLs that will be used as the redirect URIs for the OAuth flow. This should typically contain a single URL that points to a page on your SPA that will handle the OAuth response. This URL must be HTTPS.
\item {\ttfamily client\+\_\+id}\+: The URL where the client metadata is hosted. This field must be the exact same as the URL used to access the metadata.
\item {\ttfamily client\+\_\+name}\+: The name of your client. Will be displayed to the user during the authentication process.
\item {\ttfamily client\+\_\+uri}\+: The URL of your client. Whether or not this value is actually displayed / used is up to the Authorization Server.
\item {\ttfamily logo\+\_\+uri}\+: The URL of your client\textquotesingle{}s logo. Should be displayed to the user during the authentication process. Whether your logo is actually displayed during the authentication process or not is up to the Authorization Server.
\item {\ttfamily tos\+\_\+uri}\+: The URL of your client\textquotesingle{}s terms of service. Will be displayed to the user during the authentication process.
\item {\ttfamily policy\+\_\+uri}\+: The URL of your client\textquotesingle{}s privacy policy. Will be displayed to the user during the authentication process.
\item If you don\textquotesingle{}t want or need the user to stay authenticated for long periods (better for security), you can remove {\ttfamily refresh\+\_\+token} from the {\ttfamily grant\+\_\+types}.
\end{DoxyItemize}

\begin{DoxyNote}{Note}
~\newline
 To mitigate phishing attacks, the Authentication Server will typically {\itshape not} display the {\ttfamily client\+\_\+uri} or {\ttfamily logo\+\_\+uri} to the user. If you don\textquotesingle{}t see your logo or client name during the authentication process, don\textquotesingle{}t worry. This is normal. The {\ttfamily client\+\_\+name} {\itshape is} generally displayed for all clients.
\end{DoxyNote}
Upload this JSON file so that it is accessible at the URL you chose for your {\ttfamily client\+\_\+id}.\hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1959}{}\doxysection{\texorpdfstring{Step 2\+: Setup your SPA}{Step 2\+: Setup your SPA}}\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1959}
Start by setting up your SPA. You can use any framework you like, or none at all. In this example, we will use Type\+Script and Parcel, with plain Java\+Script.


\begin{DoxyCode}{0}
\DoxyCodeLine{npm\ init\ -\/y}
\DoxyCodeLine{npm\ install\ -\/-\/save-\/dev\ @atproto/oauth-\/client-\/browser}
\DoxyCodeLine{npm\ install\ -\/-\/save-\/dev\ @atproto/api}
\DoxyCodeLine{npm\ install\ -\/-\/save-\/dev\ parcel}
\DoxyCodeLine{npm\ install\ -\/-\/save-\/dev\ parcel-\/reporter-\/static-\/files-\/copy}
\DoxyCodeLine{mkdir\ -\/p\ src}
\DoxyCodeLine{mkdir\ -\/p\ static}

\end{DoxyCode}


Create a {\ttfamily .parcelrc} file with the following (exact) content\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}extends"{}:\ ["{}@parcel/config-\/default"{}],}
\DoxyCodeLine{\ \ "{}reporters"{}:\ ["{}..."{},\ "{}parcel-\/reporter-\/static-\/files-\/copy"{}]}
\DoxyCodeLine{\}}

\end{DoxyCode}


Create an {\ttfamily src/index.\+html} file with the following content\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{<!doctype\ html>}
\DoxyCodeLine{<html\ lang="{}en"{}>}
\DoxyCodeLine{\ \ <head>}
\DoxyCodeLine{\ \ \ \ <meta\ charset="{}utf-\/8"{}\ />}
\DoxyCodeLine{\ \ \ \ <meta\ name="{}viewport"{}\ content="{}width=device-\/width,\ initial-\/scale=1.0"{}\ />}
\DoxyCodeLine{\ \ \ \ <title>My\ First\ OAuth\ App</title>}
\DoxyCodeLine{\ \ \ \ <script\ type="{}module"{}\ src="{}app.ts"{}></script>}
\DoxyCodeLine{\ \ </head>}
\DoxyCodeLine{\ \ <body>}
\DoxyCodeLine{\ \ \ \ Loading...}
\DoxyCodeLine{\ \ </body>}
\DoxyCodeLine{</html>}

\end{DoxyCode}


And an {\ttfamily src/app.\+ts} file, with the following content\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{console.log('Hello\ from\ atproto\ OAuth\ example\ app!')}

\end{DoxyCode}


Start the app in development mode\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{npx\ parcel\ src/index.html}

\end{DoxyCode}


In another terminal, open a tunnel to your local server\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{ngrok\ http\ 1234}

\end{DoxyCode}


Create a {\ttfamily static/client-\/metadata.\+json} file with the client metadata you created in Step 1. Use the hostname provided by ngrok as the {\ttfamily client\+\_\+id}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ "{}client\_id"{}:\ "{}https://<RANDOM\_VALUE>.ngrok.app/client-\/metadata.json"{},}
\DoxyCodeLine{\ \ "{}client\_name"{}:\ "{}My\ First\ atproto\ OAuth\ App"{},}
\DoxyCodeLine{\ \ "{}client\_uri"{}:\ "{}https://<RANDOM\_VALUE>.ngrok.app"{},}
\DoxyCodeLine{\ \ "{}redirect\_uris"{}:\ ["{}https://<RANDOM\_VALUE>.ngrok.app/"{}],}
\DoxyCodeLine{\ \ "{}grant\_types"{}:\ ["{}authorization\_code"{}],}
\DoxyCodeLine{\ \ "{}response\_types"{}:\ ["{}code"{}],}
\DoxyCodeLine{\ \ "{}token\_endpoint\_auth\_method"{}:\ "{}none"{},}
\DoxyCodeLine{\ \ "{}application\_type"{}:\ "{}web"{},}
\DoxyCodeLine{\ \ "{}dpop\_bound\_access\_tokens"{}:\ true}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1960}{}\doxysection{\texorpdfstring{Step 3\+: Implement the OAuth flow}{Step 3\+: Implement the OAuth flow}}\label{md_node__modules_2_0datproto_2api_2_o_a_u_t_h_autotoc_md1960}
Replace the content of the {\ttfamily src/app.\+ts} file, with the following content\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ Agent\ \}\ from\ '@atproto/api'}
\DoxyCodeLine{import\ \{\ BrowserOAuthClient\ \}\ from\ '@atproto/oauth-\/client-\/browser'}
\DoxyCodeLine{}
\DoxyCodeLine{async\ function\ main()\ \{}
\DoxyCodeLine{\ \ const\ oauthClient\ =\ await\ BrowserOAuthClient.load(\{}
\DoxyCodeLine{\ \ \ \ clientId:\ '<YOUR\_CLIENT\_ID>',}
\DoxyCodeLine{\ \ \ \ handleResolver:\ 'https://bsky.social/',}
\DoxyCodeLine{\ \ \})}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ TO\ BE\ CONTINUED}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{document.addEventListener('DOMContentLoaded',\ main)}

\end{DoxyCode}


\begin{DoxyAttention}{Attention}
~\newline
 Using Bluesky-\/hosted services for handle resolution (eg, the {\ttfamily bsky.\+social} endpoint) will leak both user IP addresses and handle identifier to Bluesky, a third party. While Bluesky has a declared privacy policy, both developers and users of applications need to be informed of and aware of the privacy implications of this arrangement. Application developers are encouraged to improve user privacy by operating their own handle resolution service when possible. If you are a PDS self-\/hoster, you can use your PDS\textquotesingle{}s URL for {\ttfamily handle\+Resolver}.
\end{DoxyAttention}
The {\ttfamily oauth\+Client} is now configured to communicate with the user\textquotesingle{}s Authorization Service. You can now initialize it in order to detect if the user is already authenticated. Replace the {\ttfamily // TO BE CONTINUED} comment with the following code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ result\ =\ await\ oauthClient.init()}
\DoxyCodeLine{}
\DoxyCodeLine{if\ (result)\ \{}
\DoxyCodeLine{\ \ if\ ('state'\ in\ result)\ \{}
\DoxyCodeLine{\ \ \ \ console.log('The\ user\ was\ just\ redirected\ back\ from\ the\ authorization\ page')}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ console.log(`The\ user\ is\ currently\ signed\ in\ as\ \$\{result.session.did\}`)}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{const\ session\ =\ result?.session}
\DoxyCodeLine{}
\DoxyCodeLine{//\ TO\ BE\ CONTINUED}

\end{DoxyCode}


At this point you can detect if the user is already authenticated or not (by checking if {\ttfamily session} is {\ttfamily undefined}).

Let\textquotesingle{}s initiate an authentication flow if the user is not authenticated. Replace the {\ttfamily // TO BE CONTINUED} comment with the following code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{if\ (!session)\ \{}
\DoxyCodeLine{\ \ const\ handle\ =\ prompt('Enter\ your\ atproto\ handle\ to\ authenticate')}
\DoxyCodeLine{\ \ if\ (!handle)\ throw\ new\ Error('Authentication\ process\ canceled\ by\ the\ user')}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ const\ url\ =\ await\ oauthClient.authorize(handle)}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Redirect\ the\ user\ to\ the\ authorization\ page}
\DoxyCodeLine{\ \ window.open(url,\ '\_self',\ 'noopener')}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Protect\ against\ browser's\ back-\/forward\ cache}
\DoxyCodeLine{\ \ await\ new\ Promise<never>((resolve,\ reject)\ =>\ \{}
\DoxyCodeLine{\ \ \ \ setTimeout(}
\DoxyCodeLine{\ \ \ \ \ \ reject,}
\DoxyCodeLine{\ \ \ \ \ \ 10\_000,}
\DoxyCodeLine{\ \ \ \ \ \ new\ Error('User\ navigated\ back\ from\ the\ authorization\ page'),}
\DoxyCodeLine{\ \ \ \ )}
\DoxyCodeLine{\ \ \})}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{//\ TO\ BE\ CONTINUED}

\end{DoxyCode}


At this point in the script, the user {\bfseries{will}} be authenticated. Authenticated API calls can be made using the {\ttfamily session}. The {\ttfamily session} can be used to instantiate the {\ttfamily Agent} class from {\ttfamily @atproto/api}. Let\textquotesingle{}s make a simple call to the API to retrieve the user\textquotesingle{}s profile. Replace the {\ttfamily // TO BE CONTINUED} comment with the following code\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{if\ (session)\ \{}
\DoxyCodeLine{\ \ const\ agent\ =\ new\ Agent(session)}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ const\ fetchProfile\ =\ async\ ()\ =>\ \{}
\DoxyCodeLine{\ \ \ \ const\ profile\ =\ await\ agent.getProfile(\{\ actor:\ agent.did\ \})}
\DoxyCodeLine{\ \ \ \ return\ profile.data}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ //\ Update\ the\ user\ interface}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ document.body.textContent\ =\ \`{}Authenticated\ as\ \$\{agent.did\}`}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ const\ profileBtn\ =\ document.createElement('button')}
\DoxyCodeLine{\ \ document.body.appendChild(profileBtn)}
\DoxyCodeLine{\ \ profileBtn.textContent\ =\ 'Fetch\ Profile'}
\DoxyCodeLine{\ \ profileBtn.onclick\ =\ async\ ()\ =>\ \{}
\DoxyCodeLine{\ \ \ \ const\ profile\ =\ await\ fetchProfile()}
\DoxyCodeLine{\ \ \ \ outputPre.textContent\ =\ JSON.stringify(profile,\ null,\ 2)}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ const\ logoutBtn\ =\ document.createElement('button')}
\DoxyCodeLine{\ \ document.body.appendChild(logoutBtn)}
\DoxyCodeLine{\ \ logoutBtn.textContent\ =\ 'Logout'}
\DoxyCodeLine{\ \ logoutBtn.onclick\ =\ async\ ()\ =>\ \{}
\DoxyCodeLine{\ \ \ \ await\ session.signOut()}
\DoxyCodeLine{\ \ \ \ window.location.reload()}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ const\ outputPre\ =\ document.createElement('pre')}
\DoxyCodeLine{\ \ document.body.appendChild(outputPre)}
\DoxyCodeLine{\}}

\end{DoxyCode}
 