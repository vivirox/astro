\chapter{Deploying a Web\+Socket proxy in front of your own Postgres instance}
\hypertarget{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y}{}\label{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y}\index{Deploying a WebSocket proxy in front of your own Postgres instance@{Deploying a WebSocket proxy in front of your own Postgres instance}}
\label{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y_autotoc_md5012}%
\Hypertarget{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y_autotoc_md5012}%


{\bfseries{This package comes configured to connect to a Neon database over a secure ({\ttfamily wss\+:}) Web\+Socket. If you\textquotesingle{}re using a Neon database, you can ignore what follows.}}

But you can also run your own Web\+Socket proxy, and configure it to allow onward connections to your own Postgres instances.

First, you\textquotesingle{}ll need to set up the proxy itself somewhere public-\/facing (or on {\ttfamily localhost} for development). See \href{https://github.com/neondatabase/wsproxy}{\texttt{ https\+://github.\+com/neondatabase/wsproxy}} for the Go code and instructions.

There are then two ways you can secure this\+:


\begin{DoxyEnumerate}
\item Set up nginx as a TLS proxy in front of {\ttfamily wsproxy}. Example shell commands to achieve this can be found below. Onward traffic to Postgres is not secured by this method, so Postgres should be running on the same machine or be reached over a private network.
\item Use experimental pure-\/\+JS Postgres connection encryption via \href{https://github.com/jawj/subtls}{\texttt{ subtls}}. There\textquotesingle{}s no need for nginx in this scenario, and the Postgres connection is encrypted end-\/to-\/end. You get this form of encryption if you set both {\ttfamily neon\+Config.\+use\+Secure\+Web\+Socket} and {\ttfamily neon\+Config.\+force\+Disable\+Pg\+SSL} to {\ttfamily false}, and append {\ttfamily ?sslmode=verify-\/full} (or similar) to your connection string. TLS version 1.\+3 must be supported by the Postgres back-\/end. {\bfseries{Please note that subtls is experimental software and this configuration is not recommended for production use.}}
\end{DoxyEnumerate}

Second, you\textquotesingle{}ll need to set some \doxysectlink{md_node__modules_2_0dneondatabase_2serverless_2_c_o_n_f_i_g}{configuration options}{0} on this package\+: at a minimum theÂ {\ttfamily ws\+Proxy} option and (if using experimental encryption) {\ttfamily subtls} and {\ttfamily root\+Certs}.\hypertarget{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y_autotoc_md5013}{}\doxysection{\texorpdfstring{Example shell commands}{Example shell commands}}\label{md_node__modules_2_0dneondatabase_2serverless_2_d_e_p_l_o_y_autotoc_md5013}
To deploy {\ttfamily wsproxy} behind nginx (for TLS) on a host {\ttfamily ws.\+example.\+com} running Ubuntu 22.\+04 (and Postgres locally), you\textquotesingle{}d do something similar to the following.

Before you start\+:


\begin{DoxyEnumerate}
\item Ensure port 443 is accessible on this machine. You might need to change firewall settings with your platform provider.
\item Upgrade to Ubuntu 22.\+04 if on an earlier version (golang is too old on older releases)\+:
\end{DoxyEnumerate}


\begin{DoxyCode}{0}
\DoxyCodeLine{sudo\ su\ \ \#\ do\ this\ all\ as\ root}
\DoxyCodeLine{apt\ update\ -\/y\ \&\&\ apt\ upgrade\ -\/y\ \&\&\ apt\ dist-\/upgrade\ -\/y}
\DoxyCodeLine{apt\ autoremove\ -\/y\ \&\&\ apt\ autoclean\ -\/y}
\DoxyCodeLine{apt\ install\ -\/y\ update-\/manager-\/core}
\DoxyCodeLine{do-\/release-\/upgrade\ \ \#\ and\ answer\ yes\ to\ all\ defaults}

\end{DoxyCode}


Then\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{sudo\ su\ \ \#\ do\ this\ all\ as\ root}
\DoxyCodeLine{}
\DoxyCodeLine{export\ HOSTDOMAIN=ws.example.com\ \ \#\ edit\ the\ domain\ name\ for\ your\ case}
\DoxyCodeLine{}
\DoxyCodeLine{\#\ if\ required:\ install\ postgres\ +\ create\ a\ password-\/auth\ user}
\DoxyCodeLine{}
\DoxyCodeLine{apt\ install\ -\/y\ postgresql}
\DoxyCodeLine{}
\DoxyCodeLine{echo\ 'create\ database\ wstest;\ create\ user\ wsclear;\ grant\ all\ privileges\ on\ database\ wstest\ to\ wsclear;'\ |\ sudo\ -\/u\ postgres\ psql}
\DoxyCodeLine{}
\DoxyCodeLine{sudo\ -\/u\ postgres\ psql\ \ \#\ and\ run:\ \(\backslash\)password\ wsclear}
\DoxyCodeLine{}
\DoxyCodeLine{perl\ -\/pi\ -\/e\ 's/\string^\#\ IPv4\ local\ connections:\(\backslash\)n/\#\ IPv4\ local\ connections:\(\backslash\)nhost\ all\ wsclear\ 127.0.0.1\(\backslash\)/32\ password\(\backslash\)n/'\ /etc/postgresql/14/main/pg\_hba.conf}
\DoxyCodeLine{}
\DoxyCodeLine{service\ postgresql\ restart}
\DoxyCodeLine{}
\DoxyCodeLine{\#\ install\ wsproxy}
\DoxyCodeLine{}
\DoxyCodeLine{adduser\ wsproxy\ -\/-\/disabled-\/login}
\DoxyCodeLine{}
\DoxyCodeLine{sudo\ su\ wsproxy}
\DoxyCodeLine{cd}
\DoxyCodeLine{git\ clone\ https://github.com/neondatabase/wsproxy.git}
\DoxyCodeLine{cd\ wsproxy}
\DoxyCodeLine{go\ build}
\DoxyCodeLine{exit}
\DoxyCodeLine{}
\DoxyCodeLine{echo\ "{}}
\DoxyCodeLine{[Unit]}
\DoxyCodeLine{Description=wsproxy}
\DoxyCodeLine{}
\DoxyCodeLine{[Service]}
\DoxyCodeLine{Type=simple}
\DoxyCodeLine{Restart=always}
\DoxyCodeLine{RestartSec=5s}
\DoxyCodeLine{User=wsproxy}
\DoxyCodeLine{Environment=LISTEN\_PORT=:6543\ ALLOW\_ADDR\_REGEX='\string^\$\{HOSTDOMAIN\}:5432\(\backslash\)\$'}
\DoxyCodeLine{ExecStart=/home/wsproxy/wsproxy/wsproxy}
\DoxyCodeLine{}
\DoxyCodeLine{[Install]}
\DoxyCodeLine{WantedBy=multi-\/user.target}
\DoxyCodeLine{"{}\ >\ /lib/systemd/system/wsproxy.service}
\DoxyCodeLine{}
\DoxyCodeLine{systemctl\ enable\ wsproxy}
\DoxyCodeLine{service\ wsproxy\ start}
\DoxyCodeLine{}
\DoxyCodeLine{\#\ install\ nginx\ as\ tls\ proxy}
\DoxyCodeLine{}
\DoxyCodeLine{apt\ install\ -\/y\ golang\ nginx\ certbot\ python3-\/certbot-\/nginx}
\DoxyCodeLine{}
\DoxyCodeLine{echo\ "{}127.0.0.1\ \$\{HOSTDOMAIN\}"{}\ >>\ /etc/hosts}
\DoxyCodeLine{}
\DoxyCodeLine{echo\ "{}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{server\ \{}
\DoxyCodeLine{\ \ listen\ 80;}
\DoxyCodeLine{\ \ listen\ [::]:80;}
\DoxyCodeLine{\ \ server\_name\ \$\{HOSTDOMAIN\};}
\DoxyCodeLine{\ \ location\ /\ \{}
\DoxyCodeLine{\ \ \ \ proxy\_pass\ http://127.0.0.1:6543/;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Upgrade\ \(\backslash\)\$http\_upgrade;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Connection\ Upgrade;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Host\ \(\backslash\)\$host;}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}}
\DoxyCodeLine{"{}\ >\ /etc/nginx/sites-\/available/wsproxy\ \ \ }
\DoxyCodeLine{}
\DoxyCodeLine{ln\ -\/s\ /etc/nginx/sites-\/available/wsproxy\ /etc/nginx/sites-\/enabled/wsproxy}
\DoxyCodeLine{}
\DoxyCodeLine{certbot\ -\/-\/nginx\ -\/d\ \$\{HOSTDOMAIN\}}
\DoxyCodeLine{}
\DoxyCodeLine{echo\ "{}}
\DoxyCodeLine{server\ \{}
\DoxyCodeLine{\ \ server\_name\ \$\{HOSTDOMAIN\};}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ location\ /\ \{}
\DoxyCodeLine{\ \ \ \ proxy\_pass\ http://127.0.0.1:6543/;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Upgrade\ \(\backslash\)\$http\_upgrade;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Connection\ Upgrade;}
\DoxyCodeLine{\ \ \ \ proxy\_set\_header\ Host\ \(\backslash\)\$host;}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ listen\ [::]:80\ ipv6only=on;}
\DoxyCodeLine{\ \ listen\ 80;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ listen\ [::]:443\ ssl\ ipv6only=on;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\ \ listen\ 443\ ssl;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\ \ ssl\_certificate\ /etc/letsencrypt/live/\$\{HOSTDOMAIN\}/fullchain.pem;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\ \ ssl\_certificate\_key\ /etc/letsencrypt/live/\$\{HOSTDOMAIN\}/privkey.pem;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\ \ include\ /etc/letsencrypt/options-\/ssl-\/nginx.conf;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\ \ ssl\_dhparam\ /etc/letsencrypt/ssl-\/dhparams.pem;\ \#\ managed\ by\ Certbot}
\DoxyCodeLine{\}}
\DoxyCodeLine{"{}\ >\ /etc/nginx/sites-\/available/wsproxy}
\DoxyCodeLine{}
\DoxyCodeLine{service\ nginx\ restart}

\end{DoxyCode}
 