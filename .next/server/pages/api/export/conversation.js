"use strict";(()=>{var e={};e.id=161,e.ids=[161],e.modules={339:(e,t,n)=>{n.d(t,{Ht:()=>a});var r=n(3939);async function a(e){try{console.log("Processing request:",e.url);let t=(0,r.createClient)((void 0).PUBLIC_SUPABASE_URL,(void 0).PUBLIC_SUPABASE_ANON_KEY),{data:n,error:a}=await t.auth.getSession();if(a||!n?.session)return console.log("Error getting session:",a),null;return{user:n?.session.user,session:n?.session}}catch(e){return console.error("Error getting session:",e),null}}!function(){var e=Error("Cannot find module '../audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}()},802:e=>{e.exports=import("clsx")},3939:e=>{e.exports=require("@supabase/supabase-js")},4420:(e,t,n)=>{n.d(t,{H:()=>a,n:()=>i});let r=(0,n(8951).tZ)();function a(e){try{let t=Date.now(),n={...JSON.parse(JSON.stringify(e)),iat:t,exp:t+36e5},r=JSON.stringify(n);return btoa(r)}catch(e){throw r.error("Failed to create verification token",{error:e}),Error("Verification token creation failed")}}function i(e){try{let t=JSON.parse(atob(e));if(t.exp<Date.now())return r.warn("Token expired",{token:e}),null;return t}catch(t){return r.error("Error verifying token",{error:t,token:e}),null}}},4696:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{POST:()=>f});var a=n(339),i=n(5303),o=n(3719),s=n(901),c=n(8951),l=e([i]);i=(l.then?(await l)():l)[0];let h=(0,c.tZ)(),f=async({request:e})=>{try{let t=await (0,a.Ht)(e);if(!t)return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let{sessionId:n,format:r="json",encryptionMode:c="hipaa"}=await e.json();if(!n)return new Response(JSON.stringify({error:"Session ID is required"}),{status:400,headers:{"Content-Type":"application/json"}});if(!await d(t.user.id,n))return new Response(JSON.stringify({error:"Access denied to this session"}),{status:403,headers:{"Content-Type":"application/json"}});let l=await p(n);if(!l||0===l.length)return new Response(JSON.stringify({error:"No messages found"}),{status:404,headers:{"Content-Type":"application/json"}});let h=i._.getInstance(o.BO);await h.initialize();let f=function(e){switch(e.toLowerCase()){case"pdf":return i.A.PDF;case"encrypted_archive":case"archive":return i.A.ENCRYPTED_ARCHIVE;default:return i.A.JSON}}(r),y=function(e){switch(e.toLowerCase()){case"none":return s.vS.NONE;case"standard":return s.vS.STANDARD;case"fhe":case"maximum":return s.vS.FHE;default:return s.vS.HIPAA}}(c),g=await h.exportConversation(l,{format:f,encryptionMode:y,includeMetadata:!0,includeVerificationToken:!0});return await u(t.user.id,n,g.id,f),new Response(JSON.stringify({id:g.id,filename:g.filename,format:g.format,timestamp:g.timestamp,totalMessages:g.totalMessages,downloadUrl:`/api/export/download/${g.id}`}),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return h.error("Export API error:",e),new Response(JSON.stringify({error:"Export failed"}),{status:500,headers:{"Content-Type":"application/json"}})}};async function d(e,t){return console.log(`Checking access for user ${e} to session ${t}`),!0}async function p(e){return console.log(`Fetching messages for session ${e}`),[{id:"1",role:"system",content:"This is a secure therapy session. All messages are encrypted.",timestamp:Date.now()-36e5},{id:"2",role:"user",content:"I've been feeling anxious lately.",timestamp:Date.now()-35e5},{id:"3",role:"assistant",content:"I understand. Can you tell me more about what triggers your anxiety?",timestamp:Date.now()-34e5},{id:"4",role:"user",content:"It seems to happen most often when I have deadlines approaching.",timestamp:Date.now()-33e5}]}async function u(e,t,n,r){h.info(`User ${e} exported session ${t} in ${r} format with ID ${n}`)}r()}catch(e){r(e)}})},5275:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{$:()=>s,w:()=>c});var a=n(802),i=n(5979),o=e([a,i]);function s(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}function c(e,t){let n=new Date(e);switch(t){case"daily":default:return n.toISOString().split("T")[0];case"weekly":{let e=new Date(n),t=n.getDay();return e.setDate(n.getDate()-t),e.toISOString().split("T")[0]}case"monthly":return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}}[a,i]=o.then?(await o)():o,r()}catch(e){r(e)}})},5303:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.d(t,{A:()=>l,_:()=>u});var a=n(901),i=n(8951),o=n(4420),s=n(5275),c=e([s]);s=(c.then?(await c)():c)[0];let d=(0,i.tZ)();var l=function(e){return e.JSON="json",e.PDF="pdf",e.ENCRYPTED_ARCHIVE="encrypted_archive",e}({});let p={format:"json",includeMetadata:!0,encryptionMode:a.vS.HIPAA,includeVerificationToken:!0};class u{constructor(e){this.initialized=!1,this.fheService=e,d.info("Export service initialized")}static getInstance(e){return u.instance||(u.instance=new u(e)),u.instance}async initialize(){if(this.initialized){d.warn("Export service already initialized");return}d.info("Initializing export service");try{if(!this.fheService)throw Error("FHE service not available");this.initialized=!0,d.info("Export service initialized successfully")}catch(e){throw d.error("Failed to initialize export service",e),e}}async exportConversation(e,t={}){this.initialized||await this.initialize();let n={...p,...t},r=Date.now(),a=(0,s.$)();try{let t,i,o,s;switch(d.info(`Exporting conversation with ${e.length} messages in ${n.format} format`),n.format){case"pdf":t=(await this.createPDFExport(e,n)).data,i="application/pdf",o=`therapy-conversation-${a}.pdf`;break;case"encrypted_archive":t=(await this.createEncryptedArchive(e,n)).data,i="application/octet-stream",o=`therapy-conversation-${a}.secz`;break;default:t=(await this.createJSONExport(e,n)).data,i="application/json",o=`therapy-conversation-${a}.json`}return n.includeVerificationToken&&(s=await this.createVerificationToken(t,a,r)),{id:a,data:t,format:n.format,encryptionMode:n.encryptionMode,verificationToken:s,timestamp:r,mimeType:i,filename:o,totalMessages:e.length}}catch(e){throw d.error("Failed to export conversation",e),Error(`Export failed: ${e.message}`)}}async createJSONExport(e,t){let n={id:(0,s.$)(),timestamp:Date.now(),messages:e.map(e=>({id:e.id,role:e.role,content:e.content,timestamp:e.timestamp||Date.now()})),metadata:t.includeMetadata?{exportVersion:"1.0",encryptionMode:t.encryptionMode,totalMessages:e.length}:void 0},r=JSON.stringify(n,null,2);if(t.encryptionMode!==a.vS.NONE){let e=await this.fheService.encryptData(new TextEncoder().encode(r),t.encryptionMode),n={protected:btoa(JSON.stringify({alg:"ECDH-ES+A256KW",enc:"A256GCM",cty:"application/json"})),encrypted_key:e.encryptedKey,iv:e.iv,ciphertext:e.data,tag:e.authTag};return{data:JSON.stringify(n)}}return{data:r}}async createPDFExport(e,t){let n=`
      Therapy Conversation export
      Generated: ${new Date().toISOString()}
      Messages: ${e.length}

      ${e.map(e=>`${e.role.toUpperCase()}: ${e.content}`).join("\n\n")}
    `,r=new TextEncoder().encode(n);if(t.encryptionMode!==a.vS.NONE){let e=await this.fheService.encryptData(r,t.encryptionMode);return{data:new Uint8Array(e.data)}}return{data:r}}async createEncryptedArchive(e,t){let n=await this.createJSONExport(e,t),r=new TextEncoder().encode(JSON.stringify({format:"SECZ-1.0",encryption:t.encryptionMode,timestamp:Date.now(),contentType:"application/json"})),a=new Uint32Array([r.length]),i=new Uint8Array(a.buffer),o=new TextEncoder().encode(n.data),s=new Uint8Array(i.length+r.length+o.length);return s.set(i,0),s.set(r,i.length),s.set(o,i.length+r.length),{data:s}}async createVerificationToken(e,t,n){let r="string"==typeof e?new TextEncoder().encode(e):e,a={exportId:t,timestamp:n,contentLength:r.length};return(0,o.H)(a)}}r()}catch(e){r(e)}})},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5979:e=>{e.exports=import("tailwind-merge")},8748:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{config:()=>d,default:()=>l,routeModule:()=>p});var a=n(3480),i=n(8667),o=n(6435),s=n(4696),c=e([s]);s=(c.then?(await c)():c)[0];let l=(0,o.M)(s,"default"),d=(0,o.M)(s,"config"),p=new a.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/export/conversation",pathname:"/api/export/conversation",bundlePath:"",filename:""},userland:s});r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[94],()=>n(8748));module.exports=r})();