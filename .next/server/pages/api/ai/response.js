"use strict";(()=>{var e={};e.id=125,e.ids=[125],e.modules={556:(e,t,o)=>{function s(e){return"choices"in e}o.d(t,{b:()=>n});class n{constructor(e){this.aiService=e.aiService,this.model=e.model||"mistralai/Mixtral-8x7B-Instruct-v0.2",this.temperature=e.temperature||.7,this.maxResponseTokens=e.maxResponseTokens||1024,this.systemPrompt=e.systemPrompt||`You are a supportive and empathetic assistant. Your responses should:
      - Supportive without being judgmental
      - Empathetic and understanding
      - Clear and concise
      - Helpful and informative

      Avoid:
      - Giving medical or legal advice
      - Using clich\xe9s or platitudes

      Focus on validating the user's feelings and providing supportive, thoughtful responses.`}async generateResponseFromMessages(e,t){let o=[...e];t&&o.unshift({role:"system",content:t,name:""});let n=await this.aiService.createChatCompletion(o,{model:this.model,temperature:this.temperature,maxTokens:this.maxResponseTokens});if(!s(n))throw Error("Expected completion response but got stream");if(!n.choices?.[0]?.message?.content)throw Error("Invalid response: missing content");let r=n.choices[0].message.content;return{content:r,model:n.model||this.model,usage:{promptTokens:Number(n.usage?.promptTokens)||0,completionTokens:Number(n.usage?.completionTokens)||0,totalTokens:Number(n.usage?.totalTokens)||0}}}async generateResponse(e,t=[],o){let s=[...t];return o&&s.unshift({role:"system",content:o,name:""}),s.push({role:"user",content:e,name:""}),this.generateResponseFromMessages(s)}async generateResponseToConversation(e,t){let o=t?.temperature??this.temperature,n=t?.maxResponseTokens??this.maxResponseTokens,r=t?.systemPrompt??this.systemPrompt,a=[...e];0===a.length||"system"!==a[0].role?a.unshift({role:"system",content:r,name:""}):a[0]={role:"system",content:r,name:""};let i=await this.aiService.createChatCompletion(a,{model:this.model,temperature:o,maxTokens:n});if(!s(i))throw Error("Expected completion response but got stream");if(!i.choices?.[0]?.message?.content)throw Error("Invalid response: missing content");return{content:i.choices[0].message.content,usage:{promptTokens:i.usage?.promptTokens||0,completionTokens:i.usage?.completionTokens||0,totalTokens:i.usage?.totalTokens||0},metadata:{model:i.model||this.model,tokensUsed:(i.usage?.promptTokens||0)+(i.usage?.completionTokens||0)},aiService:this.aiService,model:this.model,temperature:o,maxResponseTokens:this.maxResponseTokens,systemPrompt:r}}async generateResponseWithInstructions(e,t,o){let s=`${this.systemPrompt}

Additional instructions: ${t}`;return this.generateResponseToConversation(e,{...o,systemPrompt:s})}async generateStreamingResponse(e,t,o){let s=o?.temperature??this.temperature,n=o?.maxResponseTokens??this.maxResponseTokens,r=o?.systemPrompt??this.systemPrompt,a=[...e];0===a.length||"system"!==a[0].role?a.unshift({role:"system",content:r,name:""}):a[0]={role:"system",content:r,name:""};let i=await this.aiService.createStreamingChatCompletion(a,{model:this.model,temperature:s,maxTokens:n}),m="";if(Symbol.asyncIterator in i)for await(let e of i){let o=e.content??"";o&&(m+=o,t(o))}else{let e=i.choices?.[0]?.message?.content??"";e&&(m=e,t(e))}return{content:m,usage:{promptTokens:0,completionTokens:0,totalTokens:0},metadata:{model:this.model},aiService:this.aiService,model:this.model,temperature:s,maxResponseTokens:this.maxResponseTokens,systemPrompt:r}}}},2616:(e,t,o)=>{o.a(e,async(e,s)=>{try{o.r(t),o.d(t,{config:()=>l,default:()=>p,routeModule:()=>c});var n=o(3480),r=o(8667),a=o(6435),i=o(5680),m=e([i]);i=(m.then?(await m)():m)[0];let p=(0,a.M)(i,"default"),l=(0,a.M)(i,"config"),c=new n.PagesAPIRouteModule({definition:{kind:r.A.PAGES_API,page:"/api/ai/response",pathname:"/api/ai/response",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},2971:e=>{e.exports=import("zod")},3939:e=>{e.exports=require("@supabase/supabase-js")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5680:(e,t,o)=>{o.a(e,async(e,s)=>{try{o.r(t),o.d(t,{POST:()=>l});var n=o(556),r=o(7626),a=o(5754),i=o(339),m=o(2754),p=e([m]);m=(p.then?(await p)():p)[0];let l=async({request:e})=>{let t;try{let o;if(!(t=await (0,i.Ht)(e)))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let{messages:s,currentMessage:p,model:l,temperature:c=.7,maxResponseTokens:u=1024,instructions:d}=await e.json();if(!s&&!p)return new Response(JSON.stringify({error:"Either messages or currentMessage is required"}),{status:400,headers:{"Content-Type":"application/json"}});let g=(0,r.E)({togetherApiKey:(void 0).TOGETHER_API_KEY,togetherBaseUrl:(void 0).TOGETHER_BASE_URL,apiKey:""}),h=l||"mistralai/Mixtral-8x7B-Instruct-v0.2",T=new n.b({aiService:{createChatCompletion:async(e,t)=>{let o=await g.generateCompletion(e,t);return{id:`together${Date.now()}`,created:Date.now(),model:t?.model||h,choices:[{message:{role:"assistant",content:"object"==typeof o&&null!==o&&"content"in o?o.content:"",name:"assistant"},finishReason:"stop"}],usage:"object"==typeof o&&null!==o&&"usage"in o?{promptTokens:Number(o.usage?.promptTokens||0),completionTokens:Number(o.usage?.completionTokens||0),totalTokens:Number(o.usage?.totalTokens||0)}:{promptTokens:0,completionTokens:0,totalTokens:0},provider:"together",content:"object"==typeof o&&null!==o&&"content"in o?o.content:""}},createStreamingChatCompletion:async(e,t)=>{throw Error("Streaming not supported yet")},getModelInfo:e=>({id:e,name:e,provider:"together",capabilities:["chat"],contextWindow:8192,maxTokens:8192}),createChatCompletionWithTracking:async(e,t)=>{let o=await g.generateCompletion(e,t);return{id:`together${Date.now()}`,created:Date.now(),model:t?.model||h,choices:[{message:{role:"assistant",content:"object"==typeof o&&null!==o&&"content"in o?o.content:"",name:"assistant"},finishReason:"stop"}],usage:"object"==typeof o&&null!==o&&"usage"in o?{promptTokens:Number(o.usage?.promptTokens||0),completionTokens:Number(o.usage?.completionTokens||0),totalTokens:Number(o.usage?.totalTokens||0)}:{promptTokens:0,completionTokens:0,totalTokens:0},provider:"together",content:"object"==typeof o&&null!==o&&"content"in o?o.content:""}},generateCompletion:async(e,t,o)=>{let s=await g.generateCompletion(e,t);return{...s,provider:o||"together",id:"object"==typeof s&&null!==s&&s.id||`together-${Date.now()}`,created:"object"==typeof s&&null!==s&&s.created||Date.now()}},dispose:()=>{g.dispose()}},model:h,temperature:c,maxResponseTokens:u});await (0,a.iL)({userId:t?.user?.id||"anonymous",action:"ai.response.request",resource:"ai",resourceId:void 0,metadata:{model:h||"mistralai/Mixtral-8x7B-Instruct-v0.2",temperature:c,maxResponseTokens:u,messageCount:s?s.length:1}});let k=Date.now();o=s?await T.generateResponseWithInstructions(s,d):await T.generateResponseWithInstructions([p],d);let y=Date.now()-k;return await m.v_.storeResponseGeneration({userId:t?.user?.id||"anonymous",modelId:h||"mistralai/Mixtral-8x7B-Instruct-v0.2",modelProvider:"together",latencyMs:y,success:!0,error:null,prompt:p||(s?JSON.stringify(s):""),response:o?.content,context:"",instructions:d,temperature:c,maxTokens:u,requestTokens:o?.usage?.promptTokens||0,responseTokens:o?.usage?.completionTokens||0,totalTokens:o?.usage?.totalTokens||0,metadata:{messageCount:s?s.length:1}}),await (0,a.iL)({userId:t?.user?.id||"anonymous",action:"ai.response.response",resource:"ai",resourceId:void 0,metadata:{model:h||"mistralai/Mixtral-8x7B-Instruct-v0.2",responseLength:o?.content.length,latencyMs:y}}),new Response(JSON.stringify(o),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("Error in response generation API:",e),await (0,a.iL)({userId:t?.user?.id||"anonymous",action:"ai.response.error",resource:"ai",resourceId:void 0,metadata:{error:e instanceof Error?e?.message:String(e),stack:e instanceof Error?e?.stack:void 0,status:"error"}}),new Response(JSON.stringify({error:"An error occurred during response generation"}),{status:500,headers:{"Content-Type":"application/json"}})}};s()}catch(e){s(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[80],()=>o(2616));module.exports=s})();