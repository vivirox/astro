"use strict";(()=>{var e={};e.id=270,e.ids=[270],e.modules={339:(e,t,r)=>{r.d(t,{Ht:()=>a});var o=r(3939);async function a(e){try{console.log("Processing request:",e.url);let t=(0,o.createClient)((void 0).PUBLIC_SUPABASE_URL,(void 0).PUBLIC_SUPABASE_ANON_KEY),{data:r,error:a}=await t.auth.getSession();if(a||!r?.session)return console.log("Error getting session:",a),null;return{user:r?.session.user,session:r?.session}}catch(e){return console.error("Error getting session:",e),null}}!function(){var e=Error("Cannot find module '../audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}()},3480:(e,t,r)=>{e.exports=r(5600)},3939:e=>{e.exports=require("@supabase/supabase-js")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5643:(e,t,r)=>{r.d(t,{N:()=>s});var o=r(3939);let a=(void 0).PUBLIC_SUPABASE_URL,n=(void 0).PUBLIC_SUPABASE_ANON_KEY,s=a&&n?(0,o.createClient)(a,n):(console.warn("Using mock Supabase client in db module. This should not be used in production."),{auth:{getUser:()=>Promise.resolve({data:{user:null},error:null}),getSession:()=>Promise.resolve({data:{session:null},error:null})},from:()=>({insert:()=>Promise.resolve({error:null}),select:()=>({eq:()=>({order:()=>({range:()=>Promise.resolve({data:[],error:null})})})})})})},5754:(e,t,r)=>{let o;r.d(t,{iL:()=>i});var a=r(3939);let n=(void 0).PUBLIC_SUPABASE_URL,s=(void 0).PUBLIC_SUPABASE_ANON_KEY;async function i(e,t,r,a={},n){try{let s=new Date,i=null,u=null;if(n&&(i=n.headers.get("x-forwarded-for")||n.headers.get("x-real-ip"),u=n.headers.get("user-agent")),"string"==typeof e){let{error:n}=await o.from("audit_logs").insert({user_id:e,action:t,resource_id:r,resource_type:"unknown",metadata:a,timestamp:s.toISOString(),ip_address:i,user_agent:u});if(n){let o=`Error creating audit log: ${n.message}`;console.error(o,{userId:e,action:t,resource:r})}}else{let{error:t}=await o.from("audit_logs").insert({id:e.id,user_id:e.userId,action:e.action,resource_id:e.resource.id,resource_type:e.resource.type,metadata:e.metadata,timestamp:e.timestamp.toISOString()});if(t){let r=`Error creating audit log: ${t.message}`;console.error(r,{entry:e})}}}catch(e){console.error(`Exception in audit logging: ${e instanceof Error?e.message:String(e)}`)}}n&&s||console.error("CRITICAL: Missing Supabase credentials for audit logging in production"),n&&s?o=(0,a.createClient)(n,s):(console.warn("CRITICAL: Using mock Supabase client for audit logging in production. This should never happen."),o={from:()=>({insert:()=>Promise.resolve({error:null}),select:()=>({eq:()=>({order:()=>({range:()=>Promise.resolve({data:[],error:null})})})})})})},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7956:(e,t,r)=>{r.r(t),r.d(t,{config:()=>m,default:()=>l,routeModule:()=>_});var o={};r.r(o),r.d(o,{GET:()=>d});var a=r(3480),n=r(8667),s=r(6435),i=r(5754),u=r(339),c=r(5643);let d=async({request:e,url:t})=>{try{let r=await (0,u.Ht)(e);if(r?.user?.role!=="admin")return new Response(JSON.stringify({error:"Unauthorized - Admin access required"}),{status:403,headers:{"Content-Type":"application/json"}});let{user:o}=r,a=t.searchParams.get("period")||"weekly",n=new Date(t.searchParams.get("startDate")?t.searchParams.get("startDate"):Date.now()-2592e6),s=t.searchParams.get("endDate")?new Date(t.searchParams.get("endDate")):new Date,d=t.searchParams.get("model")||void 0,l=Number.parseInt(t.searchParams.get("limit")||"100",10);await (0,i.iL)({userId:o.id,action:"ai.performance.metrics.request",resource:"ai",metadata:{period:a,startDate:n.toISOString(),endDate:s.toISOString(),model:d,limit:l}});let{data:m,error:_}=await c.N.rpc("get_ai_metrics",{p_period:a,p_start_date:n.toISOString(),p_end_date:s.toISOString(),p_model:d,p_limit:l}).then(e=>e.data);if(_)throw _;let p=m?.map(e=>({date:e.date_trunc,model:e.model,requestCount:Number(e.request_count),latency:{avg:Number(e.avg_latency),max:Number(e.max_latency),min:Number(e.min_latency)},tokens:{input:Number(e.total_input_tokens),output:Number(e.total_output_tokens),total:Number(e.total_tokens)},successRate:Number(e.success_count)/Number(e.request_count),cacheHitRate:Number(e.cached_count)/Number(e.request_count),optimizationRate:Number(e.optimized_count)/Number(e.request_count)}))??[],{data:g,error:f}=await c.N.rpc("get_ai_model_breakdown",{p_start_date:n.toISOString(),p_end_date:s.toISOString()}).then(e=>e.data);if(f)throw f;let{data:P,error:S}=await c.N.rpc("get_ai_error_breakdown",{p_start_date:n.toISOString(),p_end_date:s.toISOString()}).then(e=>e.data);if(S||S)throw S;return new Response(JSON.stringify({metrics:p,modelBreakdown:g?.map(e=>({model:e.model,requestCount:Number(e.request_count),totalTokens:Number(e.total_tokens),successRate:Number(e.success_count)/Number(e.request_count),cacheHitRate:Number(e.cached_count)/Number(e.request_count),optimizationRate:Number(e.optimized_count)/Number(e.request_count)}))??[],errorBreakdown:P?.map(e=>({errorCode:e.error_code,count:Number(e.error_count)}))??[]}),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("Error fetching AI performance metrics:",e),new Response(JSON.stringify({error:"Failed to fetch AI performance metrics",details:e instanceof Error?e?.message:String(e)}),{status:500,headers:{"Content-Type":"application/json"}})}},l=(0,s.M)(o,"default"),m=(0,s.M)(o,"config"),_=new a.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/ai/performance-metrics",pathname:"/api/ai/performance-metrics",bundlePath:"",filename:""},userland:o})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=7956);module.exports=r})();