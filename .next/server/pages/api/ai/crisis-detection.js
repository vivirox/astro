"use strict";(()=>{var e={};e.id=149,e.ids=[149],e.modules={192:(e,s,t)=>{t.a(e,async(e,r)=>{try{t.r(s),t.d(s,{config:()=>l,default:()=>d,routeModule:()=>u});var i=t(3480),a=t(8667),o=t(6435),n=t(5832),c=e([n]);n=(c.then?(await c)():c)[0];let d=(0,o.M)(n,"default"),l=(0,o.M)(n,"config"),u=new i.PagesAPIRouteModule({definition:{kind:a.A.PAGES_API,page:"/api/ai/crisis-detection",pathname:"/api/ai/crisis-detection",bundlePath:"",filename:""},userland:n});r()}catch(e){r(e)}})},2971:e=>{e.exports=import("zod")},3939:e=>{e.exports=require("@supabase/supabase-js")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5832:(e,s,t)=>{t.a(e,async(e,r)=>{try{t.r(s),t.d(s,{POST:()=>d});var i=t(7626),a=t(5754),o=t(339),n=t(2754),c=e([n]);n=(c.then?(await c)():c)[0];let d=async({request:e})=>{let s;try{let t;if(!(s=await (0,o.Ht)(e)))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let{text:r,batch:c,model:d,sensitivityLevel:l=5}=await e.json();if(!r&&!c)return new Response(JSON.stringify({error:"Either text or batch is required"}),{status:400,headers:{"Content-Type":"application/json"}});let u=(0,i.E)({togetherApiKey:(void 0).TOGETHER_API_KEY,togetherBaseUrl:(void 0).TOGETHER_BASE_URL,apiKey:""}),p={detectCrisis:async e=>{let s=await u.createChatCompletion([{role:"system",content:"You are a crisis detection system.",name:""},{role:"user",content:e,name:""}],{model:d||"mistralai/Mixtral-8x7B-Instruct-v0.1"}),t=s?.choices?.[0]?.message?.content||"{}",r=JSON.parse(t);return{hasCrisis:r?.hasCrisis,confidence:r?.confidence,crisisType:r?.crisisType,riskLevel:r?.riskLevel,content:e}},detectBatch:async e=>Promise.all(e.map(e=>p.detectCrisis(e))),model:d||"mistralai/Mixtral-8x7B-Instruct-v0.1"};await (0,a.iL)({userId:s?.user?.id||"anonymous",action:"ai.crisis.request",resource:"ai",resourceId:void 0,metadata:{model:p.model,sensitivityLevel:l,batchSize:c?c.length:0,textLength:r?r.length:0}});let m=Date.now(),h=!1;if(c){t=await p.detectBatch(c);for(let e=0;e<t?.length;e++){let r=t[e],i=Date.now()-m;r.hasCrisis&&(h=!0),await n.v_.storeCrisisDetection({userId:s?.user?.id||"anonymous",modelId:p.model,modelProvider:"together",latencyMs:i,success:!0,error:null,text:c[e],crisisDetected:r.hasCrisis,crisisType:r.crisisType,confidence:r.confidence,riskLevel:r.riskLevel,sensitivityLevel:l,requestTokens:0,responseTokens:0,totalTokens:0,metadata:{batchIndex:e,batchSize:c.length}})}}else{t=await p.detectCrisis(r);let e=Date.now()-m;t?.hasCrisis&&(h=!0),await n.v_.storeCrisisDetection({userId:s?.user?.id||"anonymous",modelId:p.model,modelProvider:"together",latencyMs:e,success:!0,error:null,text:r,crisisDetected:t?.hasCrisis,crisisType:t?.crisisType,confidence:t?.confidence,riskLevel:t?.riskLevel,sensitivityLevel:l,requestTokens:0,responseTokens:0,totalTokens:0,metadata:{category:t?.crisisType}})}return await (0,a.iL)({userId:s?.user?.id||"anonymous",action:"ai.crisis.response",resource:"ai",resourceId:void 0,metadata:{model:p.model,resultCount:c?t.length:1,crisisDetected:h,latencyMs:Date.now()-m,priority:h?"high":"normal"}}),new Response(JSON.stringify(t),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("Error in crisis detection API:",e),await (0,a.iL)({userId:s?.user?.id||"anonymous",action:"ai.crisis.error",resource:"ai",resourceId:void 0,metadata:{error:e instanceof Error?e?.message:String(e),stack:e instanceof Error?e?.stack:void 0,status:"error"}}),new Response(JSON.stringify({error:"An error occurred during crisis detection analysis"}),{status:500,headers:{"Content-Type":"application/json"}})}};r()}catch(e){r(e)}})}};var s=require("../../../webpack-api-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[80],()=>t(192));module.exports=r})();