"use strict";(()=>{var e={};e.id=546,e.ids=[546],e.modules={3480:(e,n,r)=>{e.exports=r(5600)},3843:(e,n,r)=>{r.r(n),r.d(n,{config:()=>c,default:()=>d,routeModule:()=>u});var t={};r.r(t),r.d(t,{POST:()=>s});var o=r(3480),i=r(8667),a=r(6435);(function(){var e=Error("Cannot find module '../../../lib/ai/services/intervention-analysis.js'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '../../../lib/ai/services/together.js'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '../../../lib/audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '../../../lib/auth/session.js'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '../../../lib/db/ai/index.js'");throw e.code="MODULE_NOT_FOUND",e}();let s=async({request:e})=>{let n;try{let r;if(!(n=await Object(function(){var e=Error("Cannot find module '../../../lib/auth/session.js'");throw e.code="MODULE_NOT_FOUND",e}())(e)))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let{conversation:t,interventionMessage:o,userResponse:i,batch:a,model:s}=await e.json();if(!(t&&o&&i)&&!a)return new Response(JSON.stringify({error:"Either conversation, interventionMessage, and userResponse or batch is required"}),{status:400,headers:{"Content-Type":"application/json"}});let d=Object(function(){var e=Error("Cannot find module '../../../lib/ai/services/together.js'");throw e.code="MODULE_NOT_FOUND",e}())({togetherApiKey:(void 0).TOGETHER_API_KEY,togetherBaseUrl:(void 0).TOGETHER_BASE_URL,apiKey:""}),c=s||"mistralai/Mixtral-8x7B-Instruct-v0.2",u=Object(function(){var e=Error("Cannot find module '../../../lib/ai/services/intervention-analysis.js'");throw e.code="MODULE_NOT_FOUND",e}())({aiService:d,model:c});await Object(function(){var e=Error("Cannot find module '../../../lib/audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}())({userId:n?.user?.id||"anonymous",action:"ai.intervention.request",resource:"ai",resourceId:void 0,metadata:{model:c,batchSize:a?a.length:0}});let l=Date.now();if(a){r=await u.analyzeBatch(a);for(let e=0;e<r?.length;e+=1){let t=r[e],o=Date.now()-l,i=a[e];await Object(function(){var e=Error("Cannot find module '../../../lib/db/ai/index.js'");throw e.code="MODULE_NOT_FOUND",e}()).storeInterventionAnalysis({userId:n?.user?.id,modelId:c,modelProvider:"together",requestTokens:0,responseTokens:0,totalTokens:0,latencyMs:o,success:!0,error:null,conversation:JSON.stringify(i.conversation),intervention:i.interventionMessage,userResponse:i.userResponse,effectiveness:t.score,insights:JSON.stringify({areas:t.areas||[],confidence:t.confidence}),recommendedFollowUp:t.recommendations?t.recommendations.join("\n"):"",metadata:{batchIndex:e,batchSize:a.length}})}}else{let e=Array.isArray(t)?t:[{role:"user",content:t,name:""}];r=await u.analyzeIntervention(e,o,i);let a=Date.now()-l;await Object(function(){var e=Error("Cannot find module '../../../lib/db/ai/index.js'");throw e.code="MODULE_NOT_FOUND",e}()).storeInterventionAnalysis({userId:n?.user?.id||"anonymous",modelId:c,modelProvider:"together",requestTokens:0,responseTokens:0,totalTokens:0,latencyMs:a,success:!0,error:null,conversation:JSON.stringify(e),intervention:o,userResponse:i,effectiveness:r.score,insights:JSON.stringify({areas:r.areas||[],confidence:r.confidence}),recommendedFollowUp:r.recommendations?r.recommendations.join("\n"):"",metadata:{}})}return await Object(function(){var e=Error("Cannot find module '../../../lib/audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}())({userId:n?.user?.id||"anonymous",action:"ai.intervention.response",resource:"ai",resourceId:void 0,metadata:{model:c||"mistralai/Mixtral-8x7B-Instruct-v0.2",resultCount:Array.isArray(r)?r.length:1,latencyMs:Date.now()-l}}),new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("Error in intervention analysis API:",e),await Object(function(){var e=Error("Cannot find module '../../../lib/audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}())({userId:n?.user?.id||"anonymous",action:"ai.intervention.error",resource:"ai",resourceId:void 0,metadata:{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,status:"error"}}),new Response(JSON.stringify({error:"An error occurred during intervention analysis"}),{status:500,headers:{"Content-Type":"application/json"}})}},d=(0,a.M)(t,"default"),c=(0,a.M)(t,"config"),u=new o.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/ai/intervention-analysis",pathname:"/api/ai/intervention-analysis",bundlePath:"",filename:""},userland:t})},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,n)=>{Object.defineProperty(n,"M",{enumerable:!0,get:function(){return function e(n,r){return r in n?n[r]:"then"in n&&"function"==typeof n.then?n.then(n=>e(n,r)):"function"==typeof n&&"default"===r?n:void 0}}})},8667:(e,n)=>{Object.defineProperty(n,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})}};var n=require("../../../webpack-api-runtime.js");n.C(e);var r=n(n.s=3843);module.exports=r})();