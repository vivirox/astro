"use strict";(()=>{var e={};e.id=162,e.ids=[162],e.modules={1524:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.d(t,{B7:()=>l,lv:()=>i});var r=a(2971),n=e([r]);let s=(r=(n.then?(await n)():n)[0]).default.object({role:r.default.enum(["system","user","assistant"]),content:r.default.string().min(1).max(32768),name:r.default.string().optional()}),i=r.default.object({model:r.default.string().min(1).default("togethercomputer/llama-3-8b-instruct"),messages:r.default.array(s).min(1).max(100),temperature:r.default.number().min(0).max(2).default(.7),max_tokens:r.default.number().min(1).max(4096).default(1024),stream:r.default.boolean().default(!1),presence_penalty:r.default.number().min(-2).max(2).default(0).optional(),frequency_penalty:r.default.number().min(-2).max(2).default(0).optional(),top_p:r.default.number().min(0).max(1).default(1).optional()}),l=r.default.object({period:r.default.enum(["daily","weekly","monthly"]).default("daily"),allUsers:r.default.boolean().default(!1),startDate:r.default.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),endDate:r.default.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional()});r.default.object({text:r.default.string().min(1).max(5e3),model:r.default.string().default("togethercomputer/llama-3-8b-instruct").optional(),includeReasoning:r.default.boolean().default(!1).optional()}),r.default.object({text:r.default.string().min(1).max(5e3),userId:r.default.string().optional(),threshold:r.default.number().min(0).max(1).default(.7).optional(),categories:r.default.array(r.default.string()).optional()}),r.default.object({messages:r.default.array(s).min(1).max(100),userId:r.default.string().optional(),model:r.default.string().default("togethercomputer/llama-3-8b-instruct").optional(),includeAnalysis:r.default.boolean().default(!1).optional(),safety:r.default.object({enabled:r.default.boolean().default(!0),threshold:r.default.number().min(0).max(1).default(.7)}).optional()}),r.default.object({messages:r.default.array(s).min(2).max(100),userId:r.default.string().optional(),interventionTypes:r.default.array(r.default.string()).optional(),includeTextAnalysis:r.default.boolean().default(!1).optional()}),o()}catch(e){o(e)}})},1708:e=>{e.exports=require("node:process")},1979:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.r(t),a.d(t,{POST:()=>c});var r=a(7830),n=a(5754),s=a(7452),i=a(7626),l=a(339),u=a(7544),d=a(1524),m=e([u,d]);[u,d]=m.then?(await m)():m;let c=async({request:e})=>{let t=null;try{if(t=await (0,l.Ht)(e),!t?.user)return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});let[a,o]=await (0,u.sv)(e,d.lv);if(o)return await (0,n.iL)({id:crypto.randomUUID(),timestamp:new Date,userId:t?.user?.id||"anonymous",action:"ai.completion.validation_error",resource:{id:"ai-completion",type:"ai"},metadata:{error:o.error,details:JSON.stringify(o.details),status:"error"}}),new Response(JSON.stringify(o),{status:o.status,headers:{"Content-Type":"application/json"}});let s=JSON.stringify(a).length;if(s>51200)return new Response(JSON.stringify({error:"Payload too large",message:"The request payload exceeds the maximum allowed size"}),{status:413,headers:{"Content-Type":"application/json"}});let m=(0,i.E)({apiKey:(void 0).TOGETHER_API_KEY,togetherApiKey:(void 0).TOGETHER_API_KEY,togetherBaseUrl:(void 0).TOGETHER_BASE_URL});await (0,n.iL)({id:crypto.randomUUID(),timestamp:new Date,userId:t?.user?.id||"anonymous",action:"ai.completion.request",resource:{id:"ai-completion",type:"ai"},metadata:{model:a?.model,messageCount:a?.messages?.length,inputSize:s,status:"success"}});let c=(a?.messages||[]).map(e=>({role:e.role||"user",content:e.content||"",...e.name&&{name:e.name}}));if(a?.stream){let e=await m.createChatCompletion(c,{model:a?.model,temperature:a?.temperature,maxTokens:a?.max_tokens}),o=new r.ReadableStream({start(a){try{a.enqueue(new TextEncoder().encode(`data: ${JSON.stringify({content:e.content,model:e.model})}

`)),a.enqueue(new TextEncoder().encode("data: [DONE]\n\n")),a.close()}catch(e){console.error("Error in streaming response:",e),a.error(e),(0,n.iL)({id:crypto.randomUUID(),timestamp:new Date,userId:t?.user?.id||"anonymous",action:"ai.completion.stream_error",resource:{id:"ai-completion",type:"ai"},metadata:{error:e instanceof Error?e?.message:String(e),status:"error"}})}}});return new Response(o,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache, no-transform",Connection:"keep-alive"}})}let p=await m.createChatCompletion(c,{model:a?.model,temperature:a?.temperature,maxTokens:a?.max_tokens});return await (0,n.iL)({id:crypto.randomUUID(),timestamp:new Date,userId:t?.user?.id||"anonymous",action:"ai.completion.response",resource:{id:"ai-completion",type:"ai"},metadata:{model:p.model,contentLength:p.content.length,status:"success"}}),new Response(JSON.stringify(p),{status:200,headers:{"Content-Type":"application/json","Cache-Control":"private, no-cache, no-store, must-revalidate"}})}catch(e){return console.error("Error in AI completion API:",e),await (0,n.iL)({id:crypto.randomUUID(),timestamp:new Date,userId:t?.user?.id||"anonymous",action:"ai.completion.error",resource:{id:"ai-completion",type:"ai"},metadata:{error:e instanceof Error?e?.message:String(e),stack:e instanceof Error?e?.stack:void 0,status:"error"}}),(0,s.hS)(e)}};o()}catch(e){o(e)}})},2971:e=>{e.exports=import("zod")},3939:e=>{e.exports=require("@supabase/supabase-js")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7544:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.d(t,{fe:()=>i,sv:()=>s});var r=a(2971),n=e([r]);async function s(e,t){try{let a=await e.json(),o=t.safeParse(a);if(!o?.success)return[null,{status:400,error:"Invalid request parameters",details:o?.error.format()}];return[o?.data,null]}catch(e){return[null,{status:400,error:"Invalid JSON in request body",details:e instanceof Error?e?.message:String(e)}]}}function i(e,t){try{let a={};e.searchParams.forEach((e,t)=>{a[t]=e});let o=t.safeParse(a);if(!o.success)return[null,{status:400,error:"Invalid query parameters",details:o?.error.format()}];return[o?.data,null]}catch(e){return[null,{status:400,error:"Error parsing query parameters",details:e instanceof Error?e?.message:String(e)}]}}(r=(n.then?(await n)():n)[0]).z.string().uuid().or(r.z.string().regex(/^[\w-]{21}$/)),o()}catch(e){o(e)}})},7626:(e,t,a)=>{a.d(t,{E:()=>o});function o(e){let t=e.togetherBaseUrl||"https://api.together.xyz/v1",a=e.apiKey||e.togetherApiKey;if(!a)throw Error("TogetherAI API key is required");async function o(e,r={}){try{let{model:o="mistralai/Mixtral-8x7B-Instruct-v0.2",temperature:n=.7,maxTokens:s=1e3}=r,i=e.map(e=>({role:e.role,content:e.content,name:e.name||"default_name"})),l=await fetch(`${t}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:o,messages:i,temperature:n,max_tokens:s})});if(!l?.ok){let e=await l?.json();throw Error(`TogetherAI API error: ${e.error?.message||l.statusText}`)}let u=await l?.json();return{id:u?.id||`together_${Date.now()}`,model:u?.model||o,created:Date.now(),content:u?.choices[0].message.content,choices:[{message:{role:"assistant",content:u?.choices[0].message.content,name:"assistant"},finishReason:u?.choices[0].finish_reason||"stop"}],usage:{promptTokens:u?.usage?.prompt_tokens||0,completionTokens:u?.usage?.completion_tokens||0,totalTokens:u?.usage?.total_tokens||0},provider:"together"}}catch(e){throw console.error("Error generating completion:",e),e}}return{generateCompletion:async(e,t)=>{let a=await o(e,t);return{content:a?.content,model:a?.model,usage:a?.usage?{promptTokens:a?.usage.promptTokens||0,completionTokens:a?.usage.completionTokens||0,totalTokens:a?.usage.totalTokens||0}:void 0}},createChatCompletion:async(e,t)=>o(e,t),createStreamingChatCompletion:async(e,t)=>(async function*(){throw yield{id:`together_${Date.now()}`,model:t?.model||"unknown",created:Date.now(),content:"",done:!0},Error("Streaming not supported yet")})(),getModelInfo:e=>({id:e,name:e,provider:"together",capabilities:["chat"],contextWindow:8192,maxTokens:8192}),createChatCompletionWithTracking:async(t,a)=>{let r=await o(t,a);return e.onUsage&&r?.usage&&await e.onUsage({timestamp:Date.now(),model:r?.model,promptTokens:r?.usage.promptTokens||0,completionTokens:r?.usage.completionTokens||0,totalTokens:r?.usage.totalTokens||0,id:r?.id,provider:"together"}),r},dispose:()=>{}}}},7830:e=>{e.exports=require("node:stream/web")},9374:(e,t,a)=>{a.a(e,async(e,o)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>u,routeModule:()=>m});var r=a(3480),n=a(8667),s=a(6435),i=a(1979),l=e([i]);i=(l.then?(await l)():l)[0];let u=(0,s.M)(i,"default"),d=(0,s.M)(i,"config"),m=new r.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/ai/completion",pathname:"/api/ai/completion",bundlePath:"",filename:""},userland:i});o()}catch(e){o(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=e=>t(t.s=e),o=t.X(0,[798],()=>a(9374));module.exports=o})();