(()=>{var e={};e.id=81,e.ids=[81],e.modules={325:(e,t,i)=>{"use strict";i.a(e,async(e,s)=>{try{let o;i.d(t,{Ay:()=>u,_K:()=>d});var n=i(2971),r=e([n]);let l=(n=(r.then?(await r)():r)[0]).z.object({NODE_ENV:n.z.enum(["development","production","test"]).default("development"),VERCEL:n.z.string().optional(),VERCEL_ENV:n.z.enum(["development","preview","production"]).optional(),VERCEL_URL:n.z.string().optional(),VERCEL_TOKEN:n.z.string().optional(),VERCEL_ORG_ID:n.z.string().optional(),VERCEL_PROJECT_ID:n.z.string().optional(),PORT:n.z.string().transform(Number).default("3000"),LOG_LEVEL:n.z.enum(["error","warn","info","verbose","debug"]).default("info"),ENABLE_RATE_LIMITING:n.z.string().transform(e=>"true"===e).default("true"),POSTGRES_URL:n.z.string().optional(),POSTGRES_PRISMA_URL:n.z.string().optional(),POSTGRES_URL_NON_POOLING:n.z.string().optional(),SUPABASE_URL:n.z.string().url().optional(),SUPABASE_KEY:n.z.string().optional(),SUPABASE_ANON_KEY:n.z.string().optional(),SUPABASE_SERVICE_ROLE_KEY:n.z.string().optional(),SUPABASE_JWT_SECRET:n.z.string().optional(),OPENAI_API_KEY:n.z.string().optional(),OPENAI_BASE_URL:n.z.string().url().optional(),TOGETHER_API_KEY:n.z.string().optional(),GOOGLE_API_KEY:n.z.string().optional(),REPLICATE_API_TOKEN:n.z.string().optional(),SENTRY_DSN:n.z.string().url().optional(),AXIOM_DATASET:n.z.string().optional(),AXIOM_TOKEN:n.z.string().optional(),VITE_LITLYX_PROJECT_ID:n.z.string().optional(),VITE_LITLYX_API_KEY:n.z.string().optional(),EMAIL_FROM:n.z.string().email().optional(),RESEND_API_KEY:n.z.string().optional(),SECURITY_ENABLE_BRUTE_FORCE_PROTECTION:n.z.string().transform(e=>"true"===e).default("true"),SECURITY_MAX_LOGIN_ATTEMPTS:n.z.string().transform(Number).default("5"),SECURITY_ACCOUNT_LOCKOUT_DURATION:n.z.string().transform(Number).default("1800"),SECURITY_API_ABUSE_THRESHOLD:n.z.string().transform(Number).default("100"),SECURITY_ENABLE_ALERTS:n.z.string().transform(e=>"true"===e).default("true"),RATE_LIMIT_MAX_REQUESTS:n.z.string().transform(Number).default("100"),RATE_LIMIT_WINDOW_MS:n.z.string().transform(Number).default("900000"),LOG_CONSOLE:n.z.string().transform(e=>"true"===e).default("true"),LOG_AUDIT:n.z.string().transform(e=>"true"===e).default("true"),VITE_API_URL:n.z.string().url().optional(),VITE_SUPABASE_URL:n.z.string().url().optional(),VITE_SUPABASE_ANON_KEY:n.z.string().optional()});function a(){return o||(o=l.parse(process.env)),o}let d=a(),u={isDevelopment:()=>"development"===a().NODE_ENV,isProduction:()=>"production"===a().NODE_ENV,isTest:()=>"test"===a().NODE_ENV,server:{port:()=>a().PORT,logLevel:()=>a().LOG_LEVEL,enableRateLimiting:()=>a().ENABLE_RATE_LIMITING},database:{url:()=>a().POSTGRES_URL,prismaUrl:()=>a().POSTGRES_PRISMA_URL,nonPoolingUrl:()=>a().POSTGRES_URL_NON_POOLING},supabase:{url:()=>a().SUPABASE_URL,key:()=>a().SUPABASE_KEY,anonKey:()=>a().SUPABASE_ANON_KEY,serviceRoleKey:()=>a().SUPABASE_SERVICE_ROLE_KEY,jwtSecret:()=>a().SUPABASE_JWT_SECRET},ai:{openAiKey:()=>a().OPENAI_API_KEY,openAiBaseUrl:()=>a().OPENAI_BASE_URL,togetherApiKey:()=>a().TOGETHER_API_KEY,googleApiKey:()=>a().GOOGLE_API_KEY,replicateToken:()=>a().REPLICATE_API_TOKEN},monitoring:{sentryDsn:()=>a().SENTRY_DSN,axiomDataset:()=>a().AXIOM_DATASET,axiomToken:()=>a().AXIOM_TOKEN,litlyxProjectId:()=>a().VITE_LITLYX_PROJECT_ID,litlyxApiKey:()=>a().VITE_LITLYX_API_KEY},email:{from:()=>a().EMAIL_FROM,resendApiKey:()=>a().RESEND_API_KEY},deployment:{vercelEnv:()=>a().VERCEL_ENV,isVercel:()=>a().VERCEL,vercelUrl:()=>a().VERCEL_URL,vercelToken:()=>a().VERCEL_TOKEN,vercelOrgId:()=>a().VERCEL_ORG_ID,vercelProjectId:()=>a().VERCEL_PROJECT_ID},security:{enableBruteForceProtection:()=>a().SECURITY_ENABLE_BRUTE_FORCE_PROTECTION,maxLoginAttempts:()=>a().SECURITY_MAX_LOGIN_ATTEMPTS,accountLockoutDuration:()=>a().SECURITY_ACCOUNT_LOCKOUT_DURATION,apiAbuseThreshold:()=>a().SECURITY_API_ABUSE_THRESHOLD,enableAlerts:()=>a().SECURITY_ENABLE_ALERTS},rateLimiting:{maxRequests:()=>a().RATE_LIMIT_MAX_REQUESTS,windowMs:()=>a().RATE_LIMIT_WINDOW_MS},logging:{console:()=>a().LOG_CONSOLE,audit:()=>a().LOG_AUDIT},client:{apiUrl:()=>a().VITE_API_URL,supabaseUrl:()=>a().VITE_SUPABASE_URL,supabaseAnonKey:()=>a().VITE_SUPABASE_ANON_KEY}};s()}catch(e){s(e)}})},339:(e,t,i)=>{"use strict";i.d(t,{Ht:()=>n});var s=i(3939);async function n(e){try{console.log("Processing request:",e.url);let t=(0,s.createClient)((void 0).PUBLIC_SUPABASE_URL,(void 0).PUBLIC_SUPABASE_ANON_KEY),{data:i,error:n}=await t.auth.getSession();if(n||!i?.session)return console.log("Error getting session:",n),null;return{user:i?.session.user,session:i?.session}}catch(e){return console.error("Error getting session:",e),null}}!function(){var e=Error("Cannot find module '../audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}()},410:()=>{throw Error('Module build failed: UnhandledSchemeError: Reading from "astro:middleware" is not handled by plugins (Unhandled scheme).\nWebpack supports "data:" and "file:" URIs by default.\nYou may need an additional plugin to handle "astro:" URIs.\n    at /Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408376\n    at Hook.eval [as callAsync] (eval at create (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:16:9224), <anonymous>:6:1)\n    at Object.processResource (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408301)\n    at processResource (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:5308)\n    at iteratePitchingLoaders (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:4667)\n    at runLoaders (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:8590)\n    at NormalModule._doBuild (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408163)\n    at NormalModule.build (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:410176)\n    at /Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:82494\n    at NormalModule.needBuild (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:414126)')},1672:(e,t,i)=>{"use strict";i.a(e,async(e,s)=>{try{i.r(t),i.d(t,{config:()=>u,default:()=>d,routeModule:()=>E});var n=i(3480),r=i(8667),a=i(6435),o=i(8584),l=e([o]);o=(l.then?(await l)():l)[0];let d=(0,a.M)(o,"default"),u=(0,a.M)(o,"config"),E=new n.PagesAPIRouteModule({definition:{kind:r.A.PAGES_API,page:"/api/fhe/rotate-keys",pathname:"/api/fhe/rotate-keys",bundlePath:"",filename:""},userland:o});s()}catch(e){s(e)}})},2971:e=>{"use strict";e.exports=import("zod")},3411:(e,t,i)=>{"use strict";i.a(e,async(e,s)=>{try{i.d(t,{Q:()=>a});var n=i(325),r=e([n]);let a={default:{maxRequests:(n=(r.then?(await r)():r)[0]).Ay.rateLimiting.maxRequests(),windowMs:n.Ay.rateLimiting.windowMs(),enabled:n.Ay.server.enableRateLimiting(),message:"Too many requests, please try again later.",statusCode:429,headers:!0,skipTrustedIPs:["127.0.0.1","::1"]},auth:{maxRequests:20,windowMs:6e4,message:"Too many authentication attempts, please try again later."},api:{maxRequests:300,windowMs:3e5,message:"API rate limit exceeded, please slow down your requests."},sensitive:{maxRequests:10,windowMs:36e5,message:"Too many sensitive operations attempted. Please try again later."},getConfig:e=>{if(!a.default.enabled)return{...a.default,enabled:!1};let t=a.default;return"default"===e?t:{...t,...a[e]}}};s()}catch(e){s(e)}})},3939:e=>{"use strict";e.exports=require("@supabase/supabase-js")},5600:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7620:(e,t,i)=>{"use strict";i.d(t,{if:()=>d,v$:()=>o});var s=i(410),n=i(339);let r=(0,i(8951).tZ)(),a=[{path:"/api/ai/",limits:{admin:120,therapist:80,user:40,anonymous:10},windowMs:6e4},{path:"/api/auth/",limits:{admin:30,therapist:30,user:20,anonymous:5},windowMs:6e4},{path:"/api/",limits:{admin:300,therapist:200,user:100,anonymous:30},windowMs:6e4}];class o{constructor(e=30,t=6e4){this.storage=new Map,this.userLimits={admin:60,user:30,anonymous:15},this.defaultLimit=defaultLimi,this.windowMs=t}check(e,t="anonymous",i,s){let n=Date.now(),r=i?`${e}:path_specific`:e,a=this.storage.get(r);i?.[t]||this.userLimits[t]||this.defaultLimi;let o=s||this.windowMs;if(!a||a.resetTime<=n){let e=n+o;return this.storage.set(r,{count:1,resetTime:e}),{allowed:!0,limit,remaining:limit-1,reset:e}}return a.count>=limit?{allowed:!1,limit,remaining:0,reset:a.resetTime}:(a.count+=1,this.storage.set(r,a),{allowed:!0,limit,remaining:limit-a.count,reset:a.resetTime})}cleanup(){let e=Date.now();for(let[t,i]of this.storage.entries())i.resetTime<=e&&this.storage.delete(t)}}let l=new o;setInterval(()=>{l.cleanup()},6e4),(0,s.defineMiddleware)(async({request:e},t)=>{let i=new URL(e.url).pathname;if(!i.startsWith("/api/"))return t();let s=[...a].sort((e,t)=>t.path.length-e.path.length).find(e=>i.includes(e.path));if(!s)return t();let o=e.headers.get("x-forwarded-for")||e.headers.get("cf-connecting-ip")||"anonymous",d="anonymous";try{let t=await (0,n.Ht)(e);t?.user?.id&&(o=t.user.id,d=t.user.role||"user")}catch(e){r.warn("Error getting session for rate limiting:",e)}let u=`${o}:${s.path}`,{allowed:E,limit:_,remaining:m,reset:p}=l.check(u,d,s.limits,s.windowMs);if(!E)return r.warn("Rate limit exceeded",{path:i,identifier:o,role:d,limit:_}),new Response(JSON.stringify({error:"Too Many Requests",message:"Rate limit exceeded. Please try again later."}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":_.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":p.toString(),"Retry-After":Math.ceil((p-Date.now())/1e3).toString()}});let c=await t();return c?.headers.set("X-RateLimit-Limit",_.toString()),c?.headers.set("X-RateLimit-Remaining",m.toString()),c?.headers.set("X-RateLimit-Reset",p.toString()),c});let d=l},8584:(e,t,i)=>{"use strict";i.a(e,async(e,s)=>{try{i.r(t),i.d(t,{POST:()=>u});var n=i(3411),r=i(3719),a=i(8951),o=i(7620),l=i(901),d=e([n]);n=(d.then?(await d)():d)[0];let u=async({request:e,cookies:t})=>{let i=new o.v$(n.Q.sensitive.maxRequests,n.Q.sensitive.windowMs);try{let s=await i.check(e.headers.get("x-forwarded-for")||"anonymous","key-rotation");if(!s.allowed)return new Response(JSON.stringify({success:!1,error:"Rate limit exceeded. Please try again later."}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":s.limit.toString(),"X-RateLimit-Remaining":s.remaining.toString(),"X-RateLimit-Reset":s.reset.toString()}});if(!t.get("session"))return new Response(JSON.stringify({success:!1,error:"Authentication required"}),{status:401,headers:{"Content-Type":"application/json"}});r.BO.isInitialized()||await r.BO.initialize({mode:l.vS.FHE,securityLevel:"high",enableDebug:!0!==(void 0).PROD});let n=await r.BO.rotateKeys();return new Response(JSON.stringify({success:!0,keyId:n,timestamp:Date.now()}),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return(0,a.tZ)().error(`Key rotation API error: ${e.message}`),new Response(JSON.stringify({success:!1,error:"Failed to rotate encryption keys",message:!0!==(void 0).PROD?e.message:void 0}),{status:500,headers:{"Content-Type":"application/json"}})}};s()}catch(e){s(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var i=e=>t(t.s=e),s=t.X(0,[94],()=>i(1672));module.exports=s})();