(()=>{var e={};e.id=868,e.ids=[868],e.modules={339:(e,t,s)=>{"use strict";s.d(t,{Ht:()=>r});var i=s(3939);async function r(e){try{console.log("Processing request:",e.url);let t=(0,i.createClient)((void 0).PUBLIC_SUPABASE_URL,(void 0).PUBLIC_SUPABASE_ANON_KEY),{data:s,error:r}=await t.auth.getSession();if(r||!s?.session)return console.log("Error getting session:",r),null;return{user:s?.session.user,session:s?.session}}catch(e){return console.error("Error getting session:",e),null}}!function(){var e=Error("Cannot find module '../audit/log.js'");throw e.code="MODULE_NOT_FOUND",e}()},410:()=>{throw Error('Module build failed: UnhandledSchemeError: Reading from "astro:middleware" is not handled by plugins (Unhandled scheme).\nWebpack supports "data:" and "file:" URIs by default.\nYou may need an additional plugin to handle "astro:" URIs.\n    at /Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408376\n    at Hook.eval [as callAsync] (eval at create (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:16:9224), <anonymous>:6:1)\n    at Object.processResource (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408301)\n    at processResource (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:5308)\n    at iteratePitchingLoaders (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:4667)\n    at runLoaders (/Users/vivi/astro/node_modules/next/dist/compiled/loader-runner/LoaderRunner.js:1:8590)\n    at NormalModule._doBuild (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:408163)\n    at NormalModule.build (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:410176)\n    at /Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:82494\n    at NormalModule.needBuild (/Users/vivi/astro/node_modules/next/dist/compiled/webpack/bundle5.js:31:414126)')},3939:e=>{"use strict";e.exports=require("@supabase/supabase-js")},5600:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7620:(e,t,s)=>{"use strict";s.d(t,{if:()=>l,v$:()=>o});var i=s(410),r=s(339);let n=(0,s(8951).tZ)(),a=[{path:"/api/ai/",limits:{admin:120,therapist:80,user:40,anonymous:10},windowMs:6e4},{path:"/api/auth/",limits:{admin:30,therapist:30,user:20,anonymous:5},windowMs:6e4},{path:"/api/",limits:{admin:300,therapist:200,user:100,anonymous:30},windowMs:6e4}];class o{constructor(e=30,t=6e4){this.storage=new Map,this.userLimits={admin:60,user:30,anonymous:15},this.defaultLimit=defaultLimi,this.windowMs=t}check(e,t="anonymous",s,i){let r=Date.now(),n=s?`${e}:path_specific`:e,a=this.storage.get(n);s?.[t]||this.userLimits[t]||this.defaultLimi;let o=i||this.windowMs;if(!a||a.resetTime<=r){let e=r+o;return this.storage.set(n,{count:1,resetTime:e}),{allowed:!0,limit,remaining:limit-1,reset:e}}return a.count>=limit?{allowed:!1,limit,remaining:0,reset:a.resetTime}:(a.count+=1,this.storage.set(n,a),{allowed:!0,limit,remaining:limit-a.count,reset:a.resetTime})}cleanup(){let e=Date.now();for(let[t,s]of this.storage.entries())s.resetTime<=e&&this.storage.delete(t)}}let d=new o;setInterval(()=>{d.cleanup()},6e4),(0,i.defineMiddleware)(async({request:e},t)=>{let s=new URL(e.url).pathname;if(!s.startsWith("/api/"))return t();let i=[...a].sort((e,t)=>t.path.length-e.path.length).find(e=>s.includes(e.path));if(!i)return t();let o=e.headers.get("x-forwarded-for")||e.headers.get("cf-connecting-ip")||"anonymous",l="anonymous";try{let t=await (0,r.Ht)(e);t?.user?.id&&(o=t.user.id,l=t.user.role||"user")}catch(e){n.warn("Error getting session for rate limiting:",e)}let u=`${o}:${i.path}`,{allowed:c,limit:m,remaining:p,reset:g}=d.check(u,l,i.limits,i.windowMs);if(!c)return n.warn("Rate limit exceeded",{path:s,identifier:o,role:l,limit:m}),new Response(JSON.stringify({error:"Too Many Requests",message:"Rate limit exceeded. Please try again later."}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":m.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":g.toString(),"Retry-After":Math.ceil((g-Date.now())/1e3).toString()}});let h=await t();return h?.headers.set("X-RateLimit-Limit",m.toString()),h?.headers.set("X-RateLimit-Remaining",p.toString()),h?.headers.set("X-RateLimit-Reset",g.toString()),h});let l=d},7967:(e,t,s)=>{"use strict";s.r(t),s.d(t,{config:()=>p,default:()=>m,routeModule:()=>g});var i={};s.r(i),s.d(i,{POST:()=>c});var r=s(3480),n=s(8667),a=s(6435),o=s(3719),d=s(901),l=s(8951),u=s(7620);let c=async({request:e})=>{try{let t=e.headers.get("x-forwarded-for")||e.headers.get("cf-connecting-ip")||"anonymous",s=await u.if.check(t,"anonymous");if(!s.allowed)return new Response(JSON.stringify({success:!1,error:"Rate limit exceeded. Please try again later."}),{status:429,headers:{"Content-Type":"application/json","X-RateLimit-Limit":s.limit.toString(),"X-RateLimit-Remaining":s.remaining.toString(),"X-RateLimit-Reset":s.reset.toString()}});let{encryptedData:i,operation:r,params:n={}}=await e.json();if(!i)return new Response(JSON.stringify({success:!1,error:"Encrypted data is required"}),{status:400,headers:{"Content-Type":"application/json"}});if(!r)return new Response(JSON.stringify({success:!1,error:"Operation is required"}),{status:400,headers:{"Content-Type":"application/json"}});o.BO.isInitialized()||await o.BO.initialize({mode:d.vS.FHE,securityLevel:"high",enableDebug:!0!==(void 0).PROD});let a=await o.BO.processEncrypted(i,r,n);return new Response(JSON.stringify({success:!0,result:a}),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return(0,l.tZ)().error(`FHE API error: ${e.message}`),new Response(JSON.stringify({success:!1,error:"Failed to process encrypted data",message:!0!==(void 0).PROD?e.message:void 0}),{status:500,headers:{"Content-Type":"application/json"}})}},m=(0,a.M)(i,"default"),p=(0,a.M)(i,"config"),g=new r.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/fhe/process",pathname:"/api/fhe/process",bundlePath:"",filename:""},userland:i})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),i=t.X(0,[94],()=>s(7967));module.exports=i})();